<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fishing Adventure</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            position: relative;
        }

        h1 {
            text-align: center;
            color: #667eea;
            margin-bottom: 20px;
            font-size: 2.5em;
            cursor: pointer;
            transition: transform 0.2s;
            user-select: none;
        }

        h1:hover {
            transform: scale(1.05);
        }

        h1:active {
            transform: scale(0.98);
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-card h3 {
            font-size: 0.9em;
            margin-bottom: 5px;
            opacity: 0.9;
        }

        .stat-card .value {
            font-size: 1.5em;
            font-weight: bold;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .panel {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            border: 2px solid #e9ecef;
        }

        .panel h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.5em;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            transition: transform 0.2s, box-shadow 0.2s;
            margin: 5px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .fish-button {
            width: 100%;
            padding: 20px;
            font-size: 1.2em;
            margin: 10px 0;
        }

        .inventory {
            max-height: 300px;
            overflow-y: auto;
            background: white;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
        }

        .fish-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            margin: 5px 0;
            background: #e9ecef;
            border-radius: 5px;
        }

        .fish-item.mutated {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .shop {
            display: grid;
            gap: 10px;
        }

        .shop-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: white;
            border-radius: 5px;
            border: 2px solid #e9ecef;
        }

        .shop-item.owned {
            border-color: #28a745;
            background: #d4edda;
        }

        .shop-item button {
            padding: 8px 16px;
            font-size: 0.9em;
        }

        .islands {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .island-card {
            padding: 15px;
            background: white;
            border-radius: 8px;
            border: 2px solid #e9ecef;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .island-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .island-card.locked {
            opacity: 0.5;
            cursor: not-allowed;
            background: #f8f9fa;
        }

        .island-card.active {
            border-color: #667eea;
            background: #e7f3ff;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }

        .close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #dc3545;
            padding: 5px 15px;
            font-size: 0.9em;
        }

        .log {
            max-height: 200px;
            overflow-y: auto;
            background: #1e1e1e;
            color: #0f0;
            padding: 10px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            margin-top: 10px;
        }

        .log-entry {
            margin: 3px 0;
        }

        .win-screen {
            text-align: center;
            padding: 40px;
        }

        .win-screen h2 {
            color: #28a745;
            font-size: 2.5em;
            margin-bottom: 20px;
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e9ecef;
            border-radius: 15px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .autoclicker-btn {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            width: 100%;
            padding: 15px;
            font-size: 1.1em;
            margin: 10px 0;
        }

        .autoclicker-btn.active {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }

        .fishing-game {
            width: 100%;
            padding: 20px;
        }

        .fishing-bar-container {
            width: 100%;
            height: 80px;
            background: #1e3a5f;
            border-radius: 10px;
            position: relative;
            overflow: hidden;
            margin: 20px 0;
            border: 3px solid #0f1f33;
        }

        .fishing-bar-track {
            width: 100%;
            height: 100%;
            position: relative;
        }

        .fish-indicator {
            position: absolute;
            top: 0;
            width: 40px;
            height: 100%;
            background: linear-gradient(180deg, #ff6b6b 0%, #ee5a6f 100%);
            border: 2px solid #fff;
            border-radius: 5px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: left 0.05s linear;
            z-index: 2;
            box-shadow: 0 0 10px rgba(255, 107, 107, 0.5);
        }

        .fish-indicator::before {
            content: 'üêü';
            font-size: 24px;
            margin-bottom: 5px;
        }

        .fish-indicator::after {
            content: '';
            width: 2px;
            height: 20px;
            background: #fff;
            margin-top: 5px;
        }

        .player-bar {
            position: absolute;
            top: 0;
            width: 80px;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            border: 3px solid #4a90e2;
            border-radius: 5px;
            transition: left 0.1s ease-out;
            z-index: 1;
            box-shadow: 0 0 15px rgba(74, 144, 226, 0.6);
        }

        .catch-progress {
            width: 100%;
            height: 30px;
            background: #e9ecef;
            border-radius: 15px;
            overflow: hidden;
            margin: 15px 0;
            border: 2px solid #333;
        }

        .catch-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #28a745 0%, #20c997 100%);
            transition: width 0.1s linear;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 0.9em;
        }

        .fishing-instructions {
            text-align: center;
            margin: 15px 0;
            color: #666;
            font-size: 0.95em;
        }

        .fishing-fish-name {
            text-align: center;
            font-size: 1.3em;
            font-weight: bold;
            color: #667eea;
            margin: 10px 0;
        }

        .secret-button {
            position: absolute;
            cursor: pointer;
            opacity: 0.3;
            transition: opacity 0.3s, transform 0.2s;
            user-select: none;
        }

        .secret-button:hover {
            opacity: 0.7;
            transform: scale(1.1);
        }

        .secret-button:active {
            transform: scale(0.95);
        }

        .rusty-pipe {
            top: 10px;
            right: 10px;
            font-size: 2em;
        }

        .secret-fish-button {
            bottom: 10px;
            right: 10px;
            font-size: 1.5em;
            background: rgba(0, 0, 0, 0.1);
            padding: 5px 10px;
            border-radius: 5px;
        }

        .poop-button {
            position: fixed;
            bottom: 5px;
            left: 5px;
            font-size: 0.5em;
            opacity: 0.1;
            cursor: pointer;
            transition: opacity 0.3s;
            z-index: 9999;
            user-select: none;
            pointer-events: auto;
        }

        .poop-button:hover {
            opacity: 0.3;
        }

        .map-container {
            width: 100%;
            height: 600px;
            background: linear-gradient(135deg, #1e3a5f 0%, #2d5a87 100%);
            border-radius: 10px;
            position: relative;
            overflow: hidden;
            border: 3px solid #0f1f33;
        }

        .map-island {
            position: absolute;
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #8b7355 0%, #6b5d4f 100%);
            border-radius: 50%;
            border: 3px solid #5a4a3a;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7em;
            text-align: center;
            color: white;
            font-weight: bold;
            transition: all 0.3s;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .map-island:hover {
            transform: scale(1.2);
            box-shadow: 0 6px 12px rgba(0,0,0,0.5);
            z-index: 10;
        }

        .map-island.locked {
            opacity: 0.4;
            cursor: not-allowed;
            background: linear-gradient(135deg, #4a4a4a 0%, #2a2a2a 100%);
        }

        .map-island.current {
            border-color: #ffd700;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.8);
            animation: pulse-glow 2s infinite;
        }

        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 20px rgba(255, 215, 0, 0.8); }
            50% { box-shadow: 0 0 30px rgba(255, 215, 0, 1); }
        }

        .map-legend {
            display: flex;
            justify-content: space-around;
            margin-top: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.9em;
        }

        /* Celebration Animation Styles */
        .celebration-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10000;
            overflow: hidden;
        }

        .confetti {
            position: absolute;
            width: 12px;
            height: 12px;
            background: #ff6b6b;
            animation: confetti-fall linear forwards;
            border-radius: 50%;
        }

        .confetti:nth-child(3n) {
            border-radius: 0;
        }

        .confetti:nth-child(5n) {
            width: 8px;
            height: 16px;
            border-radius: 4px;
        }

        .confetti:nth-child(1) { background: #ff6b6b; left: 10%; animation-duration: 3s; animation-delay: 0s; }
        .confetti:nth-child(2) { background: #4ecdc4; left: 20%; animation-duration: 2.5s; animation-delay: 0.2s; }
        .confetti:nth-child(3) { background: #ffe66d; left: 30%; animation-duration: 3.2s; animation-delay: 0.1s; }
        .confetti:nth-child(4) { background: #95e1d3; left: 40%; animation-duration: 2.8s; animation-delay: 0.3s; }
        .confetti:nth-child(5) { background: #f38181; left: 50%; animation-duration: 3s; animation-delay: 0s; }
        .confetti:nth-child(6) { background: #aa96da; left: 60%; animation-duration: 2.7s; animation-delay: 0.2s; }
        .confetti:nth-child(7) { background: #fcbad3; left: 70%; animation-duration: 3.1s; animation-delay: 0.1s; }
        .confetti:nth-child(8) { background: #ffd93d; left: 80%; animation-duration: 2.9s; animation-delay: 0.3s; }
        .confetti:nth-child(9) { background: #6bcf7f; left: 90%; animation-duration: 3s; animation-delay: 0.2s; }
        .confetti:nth-child(10) { background: #ff9ff3; left: 15%; animation-duration: 2.6s; animation-delay: 0.1s; }
        .confetti:nth-child(11) { background: #54a0ff; left: 25%; animation-duration: 3.3s; animation-delay: 0.3s; }
        .confetti:nth-child(12) { background: #5f27cd; left: 35%; animation-duration: 2.8s; animation-delay: 0s; }
        .confetti:nth-child(13) { background: #00d2d3; left: 45%; animation-duration: 3.1s; animation-delay: 0.2s; }
        .confetti:nth-child(14) { background: #ff9ff3; left: 55%; animation-duration: 2.9s; animation-delay: 0.1s; }
        .confetti:nth-child(15) { background: #feca57; left: 65%; animation-duration: 3s; animation-delay: 0.3s; }
        .confetti:nth-child(16) { background: #48dbfb; left: 75%; animation-duration: 2.7s; animation-delay: 0s; }
        .confetti:nth-child(17) { background: #ff9ff3; left: 85%; animation-duration: 3.2s; animation-delay: 0.2s; }
        .confetti:nth-child(18) { background: #ff6348; left: 95%; animation-duration: 2.8s; animation-delay: 0.1s; }

        @keyframes confetti-fall {
            0% {
                transform: translateY(0) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(calc(100vh + 20px)) rotate(720deg);
                opacity: 0;
            }
        }

        .celebration-text {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            font-size: clamp(2em, 8vw, 4em);
            font-weight: bold;
            color: #ffd700;
            text-shadow: 
                0 0 10px #ff6b6b,
                0 0 20px #ff6b6b,
                0 0 30px #ff6b6b,
                0 0 40px #ff6b6b,
                3px 3px 0px #ff6b6b,
                -3px -3px 0px #4ecdc4;
            z-index: 10001;
            pointer-events: none;
            animation: celebration-pop 1s ease-out forwards;
            white-space: nowrap;
            text-align: center;
        }

        .celebration-text.mutated {
            color: #ff00ff;
            text-shadow: 
                0 0 10px #ff00ff,
                0 0 20px #ff00ff,
                0 0 30px #ff00ff,
                0 0 40px #ff00ff,
                3px 3px 0px #ff00ff,
                -3px -3px 0px #00ffff;
        }

        @keyframes celebration-pop {
            0% {
                transform: translate(-50%, -50%) scale(0) rotate(-180deg);
                opacity: 0;
            }
            50% {
                transform: translate(-50%, -50%) scale(1.2) rotate(0deg);
                opacity: 1;
            }
            70% {
                transform: translate(-50%, -50%) scale(0.95) rotate(5deg);
            }
            85% {
                transform: translate(-50%, -50%) scale(1.05) rotate(-5deg);
            }
            100% {
                transform: translate(-50%, -50%) scale(1) rotate(0deg);
                opacity: 1;
            }
        }

        .celebration-text.fade-out {
            animation: celebration-fade-out 0.5s ease-out forwards;
        }

        @keyframes celebration-fade-out {
            0% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 1;
            }
            100% {
                transform: translate(-50%, -50%) scale(0.8) translateY(-50px);
                opacity: 0;
            }
        }

        .sparkle {
            position: absolute;
            width: 8px;
            height: 8px;
            background: #ffd700;
            border-radius: 50%;
            animation: sparkle-pop 1s ease-out forwards;
            pointer-events: none;
        }

        @keyframes sparkle-pop {
            0% {
                transform: scale(0);
                opacity: 1;
            }
            50% {
                transform: scale(1.5);
                opacity: 1;
            }
            100% {
                transform: scale(0);
                opacity: 0;
            }
        }

        .gold-coin {
            position: absolute;
            font-size: 2em;
            animation: coin-bounce 1.5s ease-out forwards;
            pointer-events: none;
        }

        @keyframes coin-bounce {
            0% {
                transform: translateY(0) scale(0) rotate(0deg);
                opacity: 1;
            }
            30% {
                transform: translateY(-100px) scale(1.2) rotate(180deg);
                opacity: 1;
            }
            60% {
                transform: translateY(-50px) scale(1) rotate(360deg);
                opacity: 1;
            }
            100% {
                transform: translateY(200px) scale(0.5) rotate(720deg);
                opacity: 0;
            }
        }
    </style>
</head>
<body>
    <div class="poop-button" onclick="poopButtonClick()" title="">üí©</div>
    <div class="container">
        <div class="secret-button rusty-pipe" onclick="toggleAutoFishing()" title="Rusty Pipe">üîß</div>
        <div class="secret-button secret-fish-button" onclick="spawnSecretFish()" title="Secret Fish">üêâ</div>
        <h1 onclick="secretGold()" title="Click for a surprise!">üé£ Fishing Adventure</h1>
        
        <div class="stats">
            <div class="stat-card">
                <h3>Level</h3>
                <div class="value" id="level">1</div>
            </div>
            <div class="stat-card">
                <h3>Gold</h3>
                <div class="value" id="gold">100</div>
            </div>
            <div class="stat-card">
                <h3>Current Island</h3>
                <div class="value" id="currentIsland">Starter Island</div>
            </div>
            <div class="stat-card">
                <h3>Rods Owned</h3>
                <div class="value" id="rodsOwned">1/50</div>
            </div>
        </div>

        <div class="progress-bar">
            <div class="progress-fill" id="levelProgress" style="width: 0.05%">Level 1 / 2000</div>
        </div>

        <div id="winScreen" style="display: none;" class="win-screen">
            <h2>üéâ Congratulations! üéâ</h2>
            <p>You've reached level 2000 and collected all 50 rods!</p>
            <p>You are the ultimate fishing master!</p>
        </div>

        <div class="main-content">
            <div class="panel">
                <h2>Fishing</h2>
                <button class="fish-button" id="fishBtn">üé£ Go Fishing!</button>
                <button class="autoclicker-btn" id="autoclickerBtn">‚ö° Auto-Clicker: OFF</button>
                <div class="log" id="fishingLog">
                    <div class="log-entry">Welcome to Fishing Adventure!</div>
                    <div class="log-entry">Start by catching some fish!</div>
                </div>
            </div>

            <div class="panel">
                <h2>Inventory</h2>
                <div class="inventory" id="inventory">
                    <div style="text-align: center; color: #999;">No fish caught yet</div>
                </div>
            </div>
        </div>

        <div class="main-content">
            <div class="panel">
                <h2>Islands</h2>
                <div class="islands" id="islands"></div>
            </div>

            <div class="panel">
                <h2>Actions</h2>
                <button id="shipwrightBtn">‚öì Visit Shipwright</button>
                <button id="merchantBtn">üí∞ Visit Merchant</button>
                <button id="appraiserBtn">üîÆ Visit Appraiser</button>
                <button id="rodsBtn">üé£ View Rods</button>
                <button id="mapBtn">üó∫Ô∏è View Map</button>
                <button id="saveBtn" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); margin-top: 10px;">üíæ Save Game</button>
                <button id="secretAutoclickerBtn" class="autoclicker-btn" style="margin-top: 10px;">üí∞ Secret Auto-Clicker: OFF</button>
                <button id="secretFishAutoclickerBtn" class="autoclicker-btn" style="margin-top: 10px;">üêâ Secret Fish Auto-Clicker: OFF</button>
            </div>
        </div>
    </div>

    <!-- Shipwright Modal -->
    <div class="modal" id="shipwrightModal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal('shipwrightModal')">‚úï</button>
            <h2>‚öì Shipwright</h2>
            <p>Buy boats to improve your fishing efficiency!</p>
            <div class="shop" id="shipwrightShop"></div>
        </div>
    </div>

    <!-- Merchant Modal -->
    <div class="modal" id="merchantModal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal('merchantModal')">‚úï</button>
            <h2>üí∞ Merchant</h2>
            <p>Sell your fish here!</p>
            <div id="merchantContent"></div>
        </div>
    </div>

    <!-- Appraiser Modal -->
    <div class="modal" id="appraiserModal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal('appraiserModal')">‚úï</button>
            <h2>üîÆ Appraiser</h2>
            <p>Spend gold to enhance your fish! (Chance to increase size or get mutations)</p>
            <div id="appraiserContent"></div>
        </div>
    </div>

    <!-- Rods Modal -->
    <div class="modal" id="rodsModal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal('rodsModal')">‚úï</button>
            <h2>üé£ Rods Collection</h2>
            <p>Better rods improve your catch rate and fish quality!</p>
            <div class="shop" id="rodsShop"></div>
        </div>
    </div>

    <!-- Fishing Game Modal -->
    <div class="modal" id="fishingGameModal">
        <div class="modal-content" style="max-width: 700px;">
            <button class="close-btn" onclick="stopFishingGame()">‚úï</button>
            <h2>üé£ Fishing!</h2>
            <div class="fishing-fish-name" id="fishingFishName"></div>
            <div class="fishing-instructions">
                Use LEFT/RIGHT arrow keys or A/D to move your bar. Keep the white bar over the fish!
            </div>
            <div class="fishing-bar-container">
                <div class="fishing-bar-track">
                    <div class="fish-indicator" id="fishIndicator"></div>
                    <div class="player-bar" id="playerBar"></div>
                </div>
            </div>
            <div class="catch-progress">
                <div class="catch-progress-fill" id="catchProgress">0%</div>
            </div>
        </div>
    </div>

    <!-- Map Modal -->
    <div class="modal" id="mapModal">
        <div class="modal-content" style="max-width: 900px;">
            <button class="close-btn" onclick="closeModal('mapModal')">‚úï</button>
            <h2>üó∫Ô∏è Island Map</h2>
            <p>Click on an island to travel there!</p>
            <div class="map-container" id="mapContainer"></div>
            <div class="map-legend">
                <div class="legend-item">
                    <div style="width: 20px; height: 20px; background: #8b7355; border-radius: 50%; border: 2px solid #ffd700;"></div>
                    <span>Current Island</span>
                </div>
                <div class="legend-item">
                    <div style="width: 20px; height: 20px; background: #8b7355; border-radius: 50%;"></div>
                    <span>Unlocked</span>
                </div>
                <div class="legend-item">
                    <div style="width: 20px; height: 20px; background: #4a4a4a; border-radius: 50%;"></div>
                    <span>Locked</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Game State
        const gameState = {
            level: 1,
            gold: 100,
            experience: 0,
            currentIsland: 0,
            inventory: [],
            ownedBoats: [0], // Starter boat
            ownedRods: [0], // Starter rod
            unlockedIslands: [0],
            totalFishCaught: 0
        };

        // Auto-clicker state
        let autoClickerInterval = null;
        let autoClickerActive = false;
        let secretAutoClickerInterval = null;
        let secretAutoClickerActive = false;
        let secretFishAutoClickerInterval = null;
        let secretFishAutoClickerActive = false;

        // Fishing mini-game state
        let fishingGameInterval = null;
        let fishingGameActive = false;
        let currentFish = null;
        let fishPosition = 0;
        let playerPosition = 0;
        let fishDirection = 1;
        let catchProgress = 0;
        let catchTimeRequired = 0;
        let keysPressed = { left: false, right: false };
        let autoFishingMode = false; // Rusty pipe auto-fishing mode
        let isCompletingCatch = false; // Flag to prevent race conditions

        // Special Secret Fish
        const secretFish = [
            { 
                name: "Megalodon", 
                baseValue: 100000, 
                baseSize: 60.0, 
                rarity: "legendary",
                description: "An ancient giant shark from the depths!"
            },
            { 
                name: "Nessie", 
                baseValue: 150000, 
                baseSize: 70.0, 
                rarity: "legendary",
                description: "The legendary Loch Ness Monster!"
            },
            { 
                name: "Mossjaw", 
                baseValue: 200000, 
                baseSize: 80.0, 
                rarity: "legendary",
                description: "A mysterious creature with moss-covered jaws!"
            },
            { 
                name: "Cthulhu", 
                baseValue: 300000, 
                baseSize: 90.0, 
                rarity: "legendary",
                description: "The great old one from the abyss!"
            },
            { 
                name: "Kraken King", 
                baseValue: 250000, 
                baseSize: 85.0, 
                rarity: "legendary",
                description: "The ruler of all krakens!"
            },
            { 
                name: "Leviathan Prime", 
                baseValue: 400000, 
                baseSize: 100.0, 
                rarity: "legendary",
                description: "The primordial sea serpent!"
            },
            { 
                name: "Abyssal Horror", 
                baseValue: 350000, 
                baseSize: 95.0, 
                rarity: "legendary",
                description: "A nightmare from the deepest trenches!"
            },
            { 
                name: "Storm Leviathan", 
                baseValue: 450000, 
                baseSize: 110.0, 
                rarity: "legendary",
                description: "A creature that commands the storms!"
            }
        ];

        // Islands Data - now based on boat requirements
        const islands = [
            { 
                name: "Starter Island", 
                unlockCost: 0, 
                boatReq: 0,
                background: "linear-gradient(135deg, #667eea 0%, #764ba2 100%)"
            },
            { 
                name: "Coral Reef", 
                unlockCost: 500, 
                boatReq: 1,
                background: "linear-gradient(135deg, #00d2ff 0%, #3a7bd5 100%)"
            },
            { 
                name: "Deep Blue", 
                unlockCost: 2000, 
                boatReq: 2,
                background: "linear-gradient(135deg, #1e3c72 0%, #2a5298 100%)"
            },
            { 
                name: "Mystic Waters", 
                unlockCost: 5000, 
                boatReq: 3,
                background: "linear-gradient(135deg, #667eea 0%, #764ba2 100%)"
            },
            { 
                name: "Abyssal Depths", 
                unlockCost: 10000, 
                boatReq: 4,
                background: "linear-gradient(135deg, #0c0c0c 0%, #1a1a2e 100%)"
            },
            { 
                name: "Golden Lagoon", 
                unlockCost: 25000, 
                boatReq: 5,
                background: "linear-gradient(135deg, #f6d365 0%, #fda085 100%)"
            },
            { 
                name: "Crystal Bay", 
                unlockCost: 50000, 
                boatReq: 6,
                background: "linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)"
            },
            { 
                name: "Dragon's Cove", 
                unlockCost: 100000, 
                boatReq: 7,
                background: "linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%)"
            },
            { 
                name: "Phantom Sea", 
                unlockCost: 250000, 
                boatReq: 8,
                background: "linear-gradient(135deg, #434343 0%, #000000 100%)"
            },
            { 
                name: "Legendary Archipelago", 
                unlockCost: 500000, 
                boatReq: 9,
                background: "linear-gradient(135deg, #f093fb 0%, #f5576c 100%)"
            }
        ];

        // Boats Data
        const boats = [
            { name: "Raft", cost: 0, catchMultiplier: 1.0, speed: 1.0 },
            { name: "Rowboat", cost: 500, catchMultiplier: 1.2, speed: 1.1 },
            { name: "Fishing Boat", cost: 2000, catchMultiplier: 1.5, speed: 1.3 },
            { name: "Speedboat", cost: 5000, catchMultiplier: 1.8, speed: 1.6 },
            { name: "Yacht", cost: 15000, catchMultiplier: 2.2, speed: 2.0 },
            { name: "Pirate Ship", cost: 50000, catchMultiplier: 2.8, speed: 2.5 },
            { name: "Submarine", cost: 150000, catchMultiplier: 3.5, speed: 3.0 },
            { name: "Dragon Boat", cost: 500000, catchMultiplier: 4.5, speed: 4.0 },
            { name: "Leviathan", cost: 1500000, catchMultiplier: 6.0, speed: 5.0 },
            { name: "Titan", cost: 5000000, catchMultiplier: 8.0, speed: 7.0 }
        ];

        // Rods Data (50 rods total)
        const rods = [];
        for (let i = 0; i < 50; i++) {
            const baseCost = Math.floor(100 * Math.pow(1.5, i));
            const catchBonus = 1 + (i * 0.1);
            const qualityBonus = 1 + (i * 0.05);
            rods.push({
                name: `Rod ${i + 1}`,
                cost: baseCost,
                catchBonus: catchBonus,
                qualityBonus: qualityBonus,
                tier: i < 10 ? "Common" : i < 20 ? "Uncommon" : i < 30 ? "Rare" : i < 40 ? "Epic" : "Legendary"
            });
        }
        rods[0].name = "Starter Rod";
        rods[0].cost = 0;

        // Fish Types by Island (better islands have better fish)
        const fishByIsland = [
            // Starter Island
            [
                { name: "Minnow", baseValue: 5, baseSize: 0.5, rarity: "common", catchTime: 3 },
                { name: "Bass", baseValue: 15, baseSize: 1.0, rarity: "common", catchTime: 4 },
                { name: "Carp", baseValue: 10, baseSize: 0.8, rarity: "common", catchTime: 3 }
            ],
            // Coral Reef
            [
                { name: "Clownfish", baseValue: 25, baseSize: 1.2, rarity: "common", catchTime: 4 },
                { name: "Angelfish", baseValue: 40, baseSize: 1.5, rarity: "uncommon", catchTime: 6 },
                { name: "Parrotfish", baseValue: 35, baseSize: 1.3, rarity: "common", catchTime: 5 },
                { name: "Lionfish", baseValue: 50, baseSize: 1.8, rarity: "uncommon", catchTime: 7 }
            ],
            // Deep Blue
            [
                { name: "Salmon", baseValue: 60, baseSize: 2.0, rarity: "uncommon", catchTime: 6 },
                { name: "Tuna", baseValue: 100, baseSize: 2.5, rarity: "uncommon", catchTime: 7 },
                { name: "Swordfish", baseValue: 150, baseSize: 3.0, rarity: "rare", catchTime: 9 },
                { name: "Barracuda", baseValue: 120, baseSize: 2.8, rarity: "rare", catchTime: 8 }
            ],
            // Mystic Waters
            [
                { name: "Marlin", baseValue: 200, baseSize: 3.5, rarity: "rare", catchTime: 8 },
                { name: "Sailfish", baseValue: 250, baseSize: 4.0, rarity: "rare", catchTime: 9 },
                { name: "Mystic Eel", baseValue: 300, baseSize: 4.5, rarity: "epic", catchTime: 11 },
                { name: "Crystal Fish", baseValue: 350, baseSize: 5.0, rarity: "epic", catchTime: 12 }
            ],
            // Abyssal Depths
            [
                { name: "Shark", baseValue: 400, baseSize: 5.5, rarity: "rare", catchTime: 10 },
                { name: "Giant Squid", baseValue: 600, baseSize: 7.0, rarity: "epic", catchTime: 12 },
                { name: "Anglerfish", baseValue: 500, baseSize: 6.0, rarity: "epic", catchTime: 11 },
                { name: "Viperfish", baseValue: 450, baseSize: 5.8, rarity: "rare", catchTime: 10 }
            ],
            // Golden Lagoon
            [
                { name: "Golden Trout", baseValue: 800, baseSize: 7.5, rarity: "epic", catchTime: 11 },
                { name: "Platinum Bass", baseValue: 1000, baseSize: 8.5, rarity: "epic", catchTime: 12 },
                { name: "Diamond Carp", baseValue: 1200, baseSize: 9.0, rarity: "legendary", catchTime: 14 },
                { name: "Treasure Fish", baseValue: 1500, baseSize: 10.0, rarity: "legendary", catchTime: 15 }
            ],
            // Crystal Bay
            [
                { name: "Crystal Shark", baseValue: 1800, baseSize: 11.0, rarity: "epic", catchTime: 12 },
                { name: "Ice Leviathan", baseValue: 2500, baseSize: 13.0, rarity: "legendary", catchTime: 14 },
                { name: "Frost Whale", baseValue: 3000, baseSize: 14.0, rarity: "legendary", catchTime: 15 },
                { name: "Glacial Serpent", baseValue: 3500, baseSize: 15.0, rarity: "legendary", catchTime: 16 }
            ],
            // Dragon's Cove
            [
                { name: "Dragon Fish", baseValue: 5000, baseSize: 16.0, rarity: "legendary", catchTime: 15 },
                { name: "Fire Serpent", baseValue: 6000, baseSize: 18.0, rarity: "legendary", catchTime: 16 },
                { name: "Volcanic Eel", baseValue: 5500, baseSize: 17.0, rarity: "legendary", catchTime: 15 },
                { name: "Magma Ray", baseValue: 7000, baseSize: 19.0, rarity: "legendary", catchTime: 17 }
            ],
            // Phantom Sea
            [
                { name: "Phantom Shark", baseValue: 10000, baseSize: 20.0, rarity: "legendary", catchTime: 16 },
                { name: "Shadow Leviathan", baseValue: 15000, baseSize: 25.0, rarity: "legendary", catchTime: 18 },
                { name: "Ghost Whale", baseValue: 12000, baseSize: 22.0, rarity: "legendary", catchTime: 17 },
                { name: "Specter Fish", baseValue: 18000, baseSize: 28.0, rarity: "legendary", catchTime: 19 }
            ],
            // Legendary Archipelago
            [
                { name: "Kraken", baseValue: 25000, baseSize: 30.0, rarity: "legendary", catchTime: 18 },
                { name: "Ancient Leviathan", baseValue: 40000, baseSize: 35.0, rarity: "legendary", catchTime: 20 },
                { name: "Celestial Dragon Fish", baseValue: 50000, baseSize: 40.0, rarity: "legendary", catchTime: 20 },
                { name: "Titan of the Deep", baseValue: 75000, baseSize: 50.0, rarity: "legendary", catchTime: 22 }
            ]
        ];

        // Get current boat stats
        function getCurrentBoat() {
            return boats[Math.max(...gameState.ownedBoats)];
        }

        // Get current rod stats
        function getCurrentRod() {
            return rods[Math.max(...gameState.ownedRods)];
        }

        // Calculate experience needed for next level
        function getExpForLevel(level) {
            return Math.floor(100 * Math.pow(1.1, level - 1));
        }

        // Add experience and level up
        function addExperience(amount) {
            const previousLevel = gameState.level;
            gameState.experience += amount;
            while (gameState.experience >= getExpForLevel(gameState.level) && gameState.level < 2000) {
                gameState.experience -= getExpForLevel(gameState.level);
                gameState.level++;
                addLog(`üéâ Level Up! You are now level ${gameState.level}!`);
            }
            updateUI();
            // Save on level up
            if (gameState.level > previousLevel) {
                saveGame();
            }
        }

        // Fishing function - starts mini-game
        function goFishing() {
            console.log('goFishing called');
            try {
                if (fishingGameActive || isCompletingCatch) {
                    console.log('Already fishing or completing catch');
                    return; // Already fishing or completing catch
                }
                
                const rod = getCurrentRod();
                if (!rod) {
                    console.error('No rod found!', gameState.ownedRods);
                    addLog('‚ùå Error: No fishing rod available!');
                    return;
                }
                
                const islandIndex = gameState.currentIsland;
                
                // Get random fish from current island
                const availableFish = fishByIsland[islandIndex] || fishByIsland[0];
                if (!availableFish || availableFish.length === 0) {
                    addLog('‚ùå No fish available at this island!');
                    return;
                }
                const fishType = availableFish[Math.floor(Math.random() * availableFish.length)];
                
                // Safety check - ensure fishType is valid
                if (!fishType || !fishType.name || !fishType.baseSize) {
                    console.error('Invalid fish type:', fishType);
                    addLog('‚ùå Error: Invalid fish type!');
                    return;
                }
                
                // If auto-fishing mode is active, instantly catch the fish
                if (autoFishingMode) {
                    // Set currentFish and immediately complete catch
                    currentFish = fishType;
                    if (currentFish && currentFish.baseSize) {
                        completeCatch();
                    } else {
                        console.error('Failed to set currentFish properly');
                    }
                    return;
                }
                
                // Calculate catch time based on fish rarity and rod quality
                // Better rods reduce catch time
                const rodSpeedBonus = 1 / rod.qualityBonus; // Better rods = faster catching
                catchTimeRequired = fishType.catchTime * rodSpeedBonus;
                
                // Start the mini-game
                currentFish = fishType;
                fishingGameActive = true;
                catchProgress = 0;
                fishPosition = 50; // Start in middle
                playerPosition = 50; // Start in middle
                fishDirection = Math.random() > 0.5 ? 1 : -1;
                
                // Show modal
                document.getElementById('fishingFishName').textContent = `A ${fishType.name} appeared!`;
                document.getElementById('fishingGameModal').classList.add('active');
                
                // Start game loop after a small delay to ensure modal is rendered
                setTimeout(() => {
                    startFishingGame();
                }, 50);
            } catch (error) {
                console.error('Error in goFishing:', error);
                addLog('‚ùå Error starting fishing: ' + error.message);
                fishingGameActive = false;
                isCompletingCatch = false;
            }
        }

        // Start fishing mini-game loop
        function startFishingGame() {
            const container = document.querySelector('.fishing-bar-container');
            if (!container) {
                console.error('Fishing container not found!');
                stopFishingGame();
                return;
            }
            
            const containerWidth = container.offsetWidth;
            if (containerWidth === 0) {
                console.error('Container width is 0, retrying...');
                setTimeout(() => startFishingGame(), 100);
                return;
            }
            
            const fishWidth = 40;
            const playerWidth = 80;
            const maxPosition = containerWidth - fishWidth;
            const maxPlayerPosition = containerWidth - playerWidth;
            
            // Reset player position
            playerPosition = (containerWidth - playerWidth) / 2;
            const playerBar = document.getElementById('playerBar');
            if (playerBar) {
                playerBar.style.left = playerPosition + 'px';
            }
            
            fishingGameInterval = setInterval(() => {
                // Move player bar based on keys
                const playerSpeed = 5;
                if (keysPressed.left) {
                    playerPosition = Math.max(0, playerPosition - playerSpeed);
                }
                if (keysPressed.right) {
                    playerPosition = Math.min(maxPlayerPosition, playerPosition + playerSpeed);
                }
                
                // Move fish (bounces back and forth)
                const fishSpeed = 2 + (currentFish.catchTime / 2); // Faster fish move faster
                fishPosition += fishDirection * fishSpeed;
                
                if (fishPosition <= 0 || fishPosition >= maxPosition) {
                    fishDirection *= -1;
                    fishPosition = Math.max(0, Math.min(maxPosition, fishPosition));
                }
                
                // Update positions
                document.getElementById('fishIndicator').style.left = fishPosition + 'px';
                document.getElementById('playerBar').style.left = playerPosition + 'px';
                
                // Check if player bar is over fish
                const fishCenter = fishPosition + fishWidth / 2;
                const playerCenter = playerPosition + playerWidth / 2;
                const overlap = Math.abs(fishCenter - playerCenter) < (fishWidth / 2 + playerWidth / 2 - 10);
                
                if (overlap) {
                    // Increase catch progress
                    catchProgress += (100 / (catchTimeRequired * 10)); // 10 updates per second
                    if (catchProgress >= 100) {
                        catchProgress = 100;
                        completeCatch();
                        return;
                    }
                } else {
                    // Decrease catch progress if not aligned
                    catchProgress = Math.max(0, catchProgress - 0.5);
                }
                
                // Update UI
                document.getElementById('catchProgress').style.width = catchProgress + '%';
                document.getElementById('catchProgress').textContent = Math.floor(catchProgress) + '%';
                
            }, 100); // Update every 100ms
        }

        // Celebration animation function
        function triggerCelebration(fish, isMutated) {
            console.log('Triggering celebration for fish:', fish, 'mutated:', isMutated);
            
            try {
                // Create overlay
                const overlay = document.createElement('div');
                overlay.className = 'celebration-overlay';
                document.body.appendChild(overlay);

            // Create confetti - start from top with random colors and positions
            const colors = ['#ff6b6b', '#4ecdc4', '#ffe66d', '#95e1d3', '#f38181', '#aa96da', '#fcbad3', '#ffd93d', '#6bcf7f', '#ff9ff3', '#54a0ff', '#5f27cd', '#00d2d3', '#feca57', '#48dbfb', '#ff6348'];
            for (let i = 0; i < 30; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = (Math.random() * 100) + '%';
                confetti.style.top = '-10px';
                confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.animationDuration = (2 + Math.random() * 2) + 's';
                confetti.style.animationDelay = (Math.random() * 0.5) + 's';
                overlay.appendChild(confetti);
            }

            // Create celebration text
            const celebrationText = document.createElement('div');
            celebrationText.className = 'celebration-text' + (isMutated ? ' mutated' : '');
            
            // Choose message based on fish value and mutation
            let message = 'üé£ Great Catch!';
            if (isMutated) {
                message = '‚ú® MUTATED FISH! ‚ú®';
            } else if (fish.value > 10000) {
                message = 'üåü AMAZING CATCH! üåü';
            } else if (fish.value > 5000) {
                message = 'üíé EXCELLENT! üíé';
            } else if (fish.value > 1000) {
                message = '‚≠ê NICE CATCH! ‚≠ê';
            }
            
            celebrationText.textContent = message;
            document.body.appendChild(celebrationText);

            // Create sparkles around the text
            for (let i = 0; i < 20; i++) {
                setTimeout(() => {
                    const sparkle = document.createElement('div');
                    sparkle.className = 'sparkle';
                    const angle = (i / 20) * Math.PI * 2;
                    const radius = 150;
                    sparkle.style.left = `calc(50% + ${Math.cos(angle) * radius}px)`;
                    sparkle.style.top = `calc(50% + ${Math.sin(angle) * radius}px)`;
                    sparkle.style.animationDelay = (i * 0.05) + 's';
                    overlay.appendChild(sparkle);
                }, i * 50);
            }

            // Create gold coins for value
            const coinCount = Math.min(Math.floor(fish.value / 100), 10);
            for (let i = 0; i < coinCount; i++) {
                setTimeout(() => {
                    const coin = document.createElement('div');
                    coin.className = 'gold-coin';
                    coin.textContent = 'üí∞';
                    coin.style.left = `calc(50% + ${(Math.random() - 0.5) * 200}px)`;
                    coin.style.top = '50%';
                    coin.style.animationDelay = (i * 0.1) + 's';
                    overlay.appendChild(coin);
                }, i * 100);
            }

            // Remove elements after animation
            setTimeout(() => {
                celebrationText.classList.add('fade-out');
            }, 1500);

            setTimeout(() => {
                overlay.remove();
                celebrationText.remove();
            }, 3000);
            } catch (error) {
                console.error('Error in celebration animation:', error);
            }
        }

        // Complete catch
        function completeCatch() {
            // Prevent multiple simultaneous catches
            if (isCompletingCatch) {
                return;
            }
            isCompletingCatch = true;
            
            // Safety check - if no fish, return early (check BEFORE stopFishingGame clears it)
            if (!currentFish) {
                console.error('completeCatch called but currentFish is null');
                isCompletingCatch = false;
                return;
            }
            
            // Save fish data BEFORE stopFishingGame clears currentFish
            const rod = getCurrentRod();
            const fishType = currentFish;
            
            // Now stop the game (this will clear currentFish)
            stopFishingGame();
            
            // Calculate size with rod bonus
            const baseSize = fishType.baseSize;
            const sizeMultiplier = 1 + (Math.random() * 0.5) + (rod.qualityBonus - 1) * 0.3;
            const size = baseSize * sizeMultiplier;
            
            // Mutation chance (5% base, improved by rod)
            const mutationChance = 0.05 * rod.qualityBonus;
            const isMutated = Math.random() < mutationChance;
            
            const fish = {
                type: fishType.name,
                size: size.toFixed(2),
                value: Math.floor(fishType.baseValue * size * (isMutated ? 3 : 1)),
                mutated: isMutated,
                rarity: fishType.rarity
            };
            
            gameState.inventory.push(fish);
            gameState.totalFishCaught++;
            
            const expGain = Math.floor(fish.value / 10) * (isMutated ? 2 : 1) * 4;
            addExperience(expGain);
            
            const mutationText = isMutated ? " ‚ú® MUTATED ‚ú®" : "";
            addLog(`üé£ Caught: ${fish.type} (${fish.size}kg)${mutationText} - Worth ${fish.value} gold!`);
            
            // Trigger celebration animation after a small delay to ensure modal is closed
            setTimeout(() => {
                triggerCelebration(fish, isMutated);
            }, 100);
            
            updateUI();
            saveGame();
            
            // Clear the flag and reset currentFish
            const wasAutoClickerActive = autoClickerActive;
            isCompletingCatch = false;
            currentFish = null;
            
            // If auto-clicker is active, start next fish immediately
            if (wasAutoClickerActive) {
                setTimeout(() => {
                    if (!fishingGameActive && !isCompletingCatch) {
                        goFishing();
                    }
                }, 100);
            }
        }

        // Stop fishing game
        function stopFishingGame() {
            if (fishingGameInterval) {
                clearInterval(fishingGameInterval);
                fishingGameInterval = null;
            }
            fishingGameActive = false;
            // Only clear isCompletingCatch if we're not in the middle of completing a catch
            // (completeCatch() manages this flag itself)
            if (!isCompletingCatch) {
                isCompletingCatch = false;
            }
            document.getElementById('fishingGameModal').classList.remove('active');
            catchProgress = 0;
            currentFish = null;
        }

        // Sell all fish
        function sellAllFish() {
            if (gameState.inventory.length === 0) {
                alert("You have no fish to sell!");
                return;
            }
            
            const totalValue = gameState.inventory.reduce((sum, fish) => sum + fish.value, 0);
            gameState.gold += totalValue;
            gameState.inventory = [];
            
            addLog(`üí∞ Sold all fish for ${totalValue} gold!`);
            updateUI();
            saveGame();
        }

        // Appraise fish (enhancement)
        function appraiseFish() {
            if (gameState.inventory.length === 0) {
                alert("You have no fish to appraise!");
                return;
            }
            
            const cost = 100 * gameState.level;
            if (gameState.gold < cost) {
                alert(`You need ${cost} gold to appraise fish!`);
                return;
            }
            
            gameState.gold -= cost;
            
            // Randomly select a fish
            const fishIndex = Math.floor(Math.random() * gameState.inventory.length);
            const fish = gameState.inventory[fishIndex];
            
            // 30% chance to increase size, 10% chance for mutation
            const sizeIncrease = Math.random() < 0.3;
            const mutation = !fish.mutated && Math.random() < 0.1;
            
            if (sizeIncrease) {
                const increase = 1 + (Math.random() * 0.5);
                fish.size = (parseFloat(fish.size) * increase).toFixed(2);
                fish.value = Math.floor(fish.value * increase);
                addLog(`‚ú® ${fish.type} grew to ${fish.size}kg!`);
            }
            
            if (mutation) {
                fish.mutated = true;
                fish.value = Math.floor(fish.value * 3);
                addLog(`üåü ${fish.type} MUTATED! Value tripled!`);
            }
            
            if (!sizeIncrease && !mutation) {
                addLog(`üîç Appraised ${fish.type} - No changes this time.`);
            }
            
            updateUI();
            saveGame();
        }

        // Buy boat
        function buyBoat(index) {
            const boat = boats[index];
            if (gameState.ownedBoats.includes(index)) {
                alert("You already own this boat!");
                return;
            }
            if (gameState.gold < boat.cost) {
                alert(`You need ${boat.cost} gold to buy this boat!`);
                return;
            }
            
            gameState.gold -= boat.cost;
            gameState.ownedBoats.push(index);
            addLog(`‚öì Purchased ${boat.name}!`);
            
            // Check for island unlocks based on boat
            islands.forEach((island, islandIndex) => {
                if (!gameState.unlockedIslands.includes(islandIndex) && 
                    index >= island.boatReq && 
                    gameState.gold >= island.unlockCost) {
                    gameState.unlockedIslands.push(islandIndex);
                    addLog(`üèùÔ∏è ${island.name} is now available with your new boat!`);
                }
            });
            
            updateUI();
            renderShipwright();
            saveGame();
        }

        // Buy rod
        function buyRod(index) {
            const rod = rods[index];
            if (gameState.ownedRods.includes(index)) {
                alert("You already own this rod!");
                return;
            }
            if (gameState.gold < rod.cost) {
                alert(`You need ${rod.cost} gold to buy this rod!`);
                return;
            }
            
            gameState.gold -= rod.cost;
            gameState.ownedRods.push(index);
            addLog(`üé£ Purchased ${rod.name}!`);
            updateUI();
            renderRods();
            saveGame();
        }

        // Change island
        function changeIsland(index) {
            if (!gameState.unlockedIslands.includes(index)) {
                const island = islands[index];
                const bestBoatIndex = Math.max(...gameState.ownedBoats);
                
                if (bestBoatIndex < island.boatReq) {
                    alert(`You need a better boat to reach ${island.name}! You need at least ${boats[island.boatReq].name}.`);
                    return;
                }
                if (gameState.gold < island.unlockCost) {
                    alert(`You need ${island.unlockCost} gold to unlock this island!`);
                    return;
                }
                gameState.gold -= island.unlockCost;
                gameState.unlockedIslands.push(index);
                addLog(`üèùÔ∏è Unlocked ${island.name}!`);
            }
            
            gameState.currentIsland = index;
            const currentIsland = islands[index];
            
            // Change background color
            document.body.style.background = currentIsland.background;
            
            addLog(`üèùÔ∏è Traveled to ${currentIsland.name}!`);
            updateUI();
            saveGame();
        }

        // UI Updates
        function updateUI() {
            document.getElementById('level').textContent = gameState.level;
            document.getElementById('gold').textContent = gameState.gold.toLocaleString();
            document.getElementById('currentIsland').textContent = islands[gameState.currentIsland].name;
            document.getElementById('rodsOwned').textContent = `${gameState.ownedRods.length}/50`;
            
            // Level progress
            const expForNext = getExpForLevel(gameState.level);
            const progress = (gameState.experience / expForNext) * 100;
            document.getElementById('levelProgress').style.width = `${progress}%`;
            document.getElementById('levelProgress').textContent = `Level ${gameState.level} / 2000`;
            
            // Check win condition
            if (gameState.level >= 2000 && gameState.ownedRods.length >= 50) {
                document.getElementById('winScreen').style.display = 'block';
            }
            
            renderInventory();
            renderIslands();
        }

        function renderInventory() {
            const inventoryDiv = document.getElementById('inventory');
            if (gameState.inventory.length === 0) {
                inventoryDiv.innerHTML = '<div style="text-align: center; color: #999;">No fish caught yet</div>';
                return;
            }
            
            inventoryDiv.innerHTML = gameState.inventory.map((fish, index) => {
                const mutatedClass = fish.mutated ? 'mutated' : '';
                return `
                    <div class="fish-item ${mutatedClass}">
                        <div>
                            <strong>${fish.type}</strong> - ${fish.size}kg
                            ${fish.mutated ? '‚ú® MUTATED ‚ú®' : ''}
                        </div>
                        <div>${fish.value} gold</div>
                    </div>
                `;
            }).join('');
        }

        function renderIslands() {
            const islandsDiv = document.getElementById('islands');
            const bestBoatIndex = Math.max(...gameState.ownedBoats);
            islandsDiv.innerHTML = islands.map((island, index) => {
                const isUnlocked = gameState.unlockedIslands.includes(index);
                const isActive = gameState.currentIsland === index;
                const canUnlock = !isUnlocked && bestBoatIndex >= island.boatReq && gameState.gold >= island.unlockCost;
                
                let classes = 'island-card';
                if (!isUnlocked && !canUnlock) classes += ' locked';
                if (isActive) classes += ' active';
                
                return `
                    <div class="${classes}" onclick="changeIsland(${index})">
                        <h3>${island.name}</h3>
                        ${!isUnlocked ? `<p>Unlock: ${island.unlockCost} gold<br>Boat: ${boats[island.boatReq].name}</p>` : ''}
                        ${isActive ? '<p>üìç Current</p>' : ''}
                    </div>
                `;
            }).join('');
        }

        function renderShipwright() {
            const shopDiv = document.getElementById('shipwrightShop');
            shopDiv.innerHTML = boats.map((boat, index) => {
                const isOwned = gameState.ownedBoats.includes(index);
                const canAfford = gameState.gold >= boat.cost;
                const classes = isOwned ? 'shop-item owned' : 'shop-item';
                
                return `
                    <div class="${classes}">
                        <div>
                            <strong>${boat.name}</strong><br>
                            <small>Catch: ${boat.catchMultiplier}x | Speed: ${boat.speed}x</small>
                        </div>
                        <div>
                            ${isOwned ? '<span>‚úì Owned</span>' : `<button onclick="buyBoat(${index})" ${!canAfford ? 'disabled' : ''}>${boat.cost.toLocaleString()} gold</button>`}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderMerchant() {
            const merchantDiv = document.getElementById('merchantContent');
            const totalValue = gameState.inventory.reduce((sum, fish) => sum + fish.value, 0);
            
            merchantDiv.innerHTML = `
                <p>You have <strong>${gameState.inventory.length}</strong> fish in your inventory.</p>
                <p>Total value: <strong>${totalValue.toLocaleString()}</strong> gold</p>
                <button onclick="sellAllFish(); closeModal('merchantModal');" style="width: 100%; margin-top: 20px; padding: 15px; font-size: 1.2em;">
                    üí∞ Sell All Fish
                </button>
            `;
        }

        function renderAppraiser() {
            const appraiserDiv = document.getElementById('appraiserContent');
            const cost = 100 * gameState.level;
            const canAfford = gameState.gold >= cost;
            
            appraiserDiv.innerHTML = `
                <p>You have <strong>${gameState.inventory.length}</strong> fish to appraise.</p>
                <p>Cost per appraisal: <strong>${cost.toLocaleString()}</strong> gold</p>
                <p><small>30% chance to increase size, 10% chance for mutation</small></p>
                <button onclick="appraiseFish();" style="width: 100%; margin-top: 20px; padding: 15px; font-size: 1.2em;" ${!canAfford ? 'disabled' : ''}>
                    üîÆ Appraise Fish (${cost.toLocaleString()} gold)
                </button>
            `;
        }

        function renderRods() {
            const rodsDiv = document.getElementById('rodsShop');
            rodsDiv.innerHTML = rods.map((rod, index) => {
                const isOwned = gameState.ownedRods.includes(index);
                const canAfford = gameState.gold >= rod.cost;
                const classes = isOwned ? 'shop-item owned' : 'shop-item';
                
                return `
                    <div class="${classes}">
                        <div>
                            <strong>${rod.name}</strong> [${rod.tier}]<br>
                            <small>Catch Bonus: ${rod.catchBonus.toFixed(2)}x | Quality: ${rod.qualityBonus.toFixed(2)}x</small>
                        </div>
                        <div>
                            ${isOwned ? '<span>‚úì Owned</span>' : `<button onclick="buyRod(${index})" ${!canAfford ? 'disabled' : ''}>${rod.cost.toLocaleString()} gold</button>`}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function addLog(message) {
            const logDiv = document.getElementById('fishingLog');
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.textContent = message;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
            if (modalId === 'shipwrightModal') renderShipwright();
            if (modalId === 'merchantModal') renderMerchant();
            if (modalId === 'appraiserModal') renderAppraiser();
            if (modalId === 'rodsModal') renderRods();
            if (modalId === 'mapModal') {
                setTimeout(() => renderMap(), 100); // Small delay to ensure container is rendered
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // Auto-clicker functions
        function toggleAutoClicker() {
            autoClickerActive = !autoClickerActive;
            const btn = document.getElementById('autoclickerBtn');
            
            if (autoClickerActive) {
                // Start auto-clicker at super speed (10ms interval = 100 clicks per second)
                autoClickerInterval = setInterval(() => {
                    if (!fishingGameActive) {
                        goFishing();
                    }
                }, 10);
                btn.textContent = '‚ö° Auto-Clicker: ON';
                btn.classList.add('active');
                addLog('‚ö° Auto-clicker activated!');
            } else {
                // Stop auto-clicker
                if (autoClickerInterval) {
                    clearInterval(autoClickerInterval);
                    autoClickerInterval = null;
                }
                btn.textContent = '‚ö° Auto-Clicker: OFF';
                btn.classList.remove('active');
                addLog('‚ö° Auto-clicker deactivated.');
            }
            saveGame();
        }

        // Secret gold function
        function secretGold() {
            gameState.gold += 5000;
            addLog('üí∞ Secret discovered! You received 5000 gold!');
            updateUI();
            saveGame();
        }

        // Poop button - Gives you all the best rods!
        function poopButtonClick() {
            // Unlock all 50 rods
            for (let i = 0; i < rods.length; i++) {
                if (!gameState.ownedRods.includes(i)) {
                    gameState.ownedRods.push(i);
                }
            }
            
            // Sort owned rods array
            gameState.ownedRods.sort((a, b) => a - b);
            
            addLog('üí© Secret discovered! You received ALL RODS!');
            addLog('üé£ You now own all 50 rods including the legendary ones!');
            updateUI();
            saveGame();
        }

        // Rusty Pipe - Toggle auto-fishing mode (instantly catch fish without mini-game)
        function toggleAutoFishing() {
            autoFishingMode = !autoFishingMode;
            if (autoFishingMode) {
                addLog('üîß Rusty Pipe activated! Fish will be caught instantly!');
            } else {
                addLog('üîß Rusty Pipe deactivated. Back to normal fishing.');
            }
            updateUI();
        }

        // Secret Fish Button - Spawn a legendary secret fish
        function spawnSecretFish() {
            const randomSecretFish = secretFish[Math.floor(Math.random() * secretFish.length)];
            const rod = getCurrentRod();
            
            // Calculate size with rod bonus
            const baseSize = randomSecretFish.baseSize;
            const sizeMultiplier = 1 + (Math.random() * 0.3) + (rod.qualityBonus - 1) * 0.2;
            const size = baseSize * sizeMultiplier;
            
            // Secret fish are always mutated!
            const fish = {
                type: randomSecretFish.name,
                size: size.toFixed(2),
                value: Math.floor(randomSecretFish.baseValue * size * 3), // Always mutated = 3x value
                mutated: true,
                rarity: randomSecretFish.rarity
            };
            
            gameState.inventory.push(fish);
            gameState.totalFishCaught++;
            
            const expGain = Math.floor(fish.value / 10) * 2 * 4; // Mutated = 2x exp, then 4x multiplier
            addExperience(expGain);
            
            addLog(`üêâ LEGENDARY CATCH: ${fish.type} (${fish.size}kg) ‚ú® MUTATED ‚ú® - Worth ${fish.value.toLocaleString()} gold!`);
            addLog(`üìñ ${randomSecretFish.description}`);
            
            updateUI();
            saveGame();
        }

        // Secret auto-clicker toggle
        function toggleSecretAutoClicker() {
            secretAutoClickerActive = !secretAutoClickerActive;
            const btn = document.getElementById('secretAutoclickerBtn');
            
            if (secretAutoClickerActive) {
                // Start secret auto-clicker at super speed (10ms interval)
                secretAutoClickerInterval = setInterval(() => {
                    secretGold();
                }, 10);
                btn.textContent = 'üí∞ Secret Auto-Clicker: ON';
                btn.classList.add('active');
                addLog('üí∞ Secret auto-clicker activated!');
            } else {
                // Stop secret auto-clicker
                if (secretAutoClickerInterval) {
                    clearInterval(secretAutoClickerInterval);
                    secretAutoClickerInterval = null;
                }
                btn.textContent = 'üí∞ Secret Auto-Clicker: OFF';
                btn.classList.remove('active');
                addLog('üí∞ Secret auto-clicker deactivated.');
            }
            saveGame();
        }

        // Secret Fish Auto-Clicker toggle
        function toggleSecretFishAutoClicker() {
            secretFishAutoClickerActive = !secretFishAutoClickerActive;
            const btn = document.getElementById('secretFishAutoclickerBtn');
            
            if (secretFishAutoClickerActive) {
                // Start secret fish auto-clicker (100ms interval)
                secretFishAutoClickerInterval = setInterval(() => {
                    spawnSecretFish();
                }, 100);
                btn.textContent = 'üêâ Secret Fish Auto-Clicker: ON';
                btn.classList.add('active');
                addLog('üêâ Secret fish auto-clicker activated!');
            } else {
                // Stop secret fish auto-clicker
                if (secretFishAutoClickerInterval) {
                    clearInterval(secretFishAutoClickerInterval);
                    secretFishAutoClickerInterval = null;
                }
                btn.textContent = 'üêâ Secret Fish Auto-Clicker: OFF';
                btn.classList.remove('active');
                addLog('üêâ Secret fish auto-clicker deactivated.');
            }
            saveGame();
        }

        // Render map with islands
        function renderMap() {
            const mapContainer = document.getElementById('mapContainer');
            mapContainer.innerHTML = '';
            
            const containerWidth = mapContainer.offsetWidth;
            const containerHeight = mapContainer.offsetHeight;
            
            // Position islands in a spiral/archipelago pattern
            const positions = [
                { x: containerWidth * 0.15, y: containerHeight * 0.5 },   // Starter Island
                { x: containerWidth * 0.3, y: containerHeight * 0.3 },   // Coral Reef
                { x: containerWidth * 0.45, y: containerHeight * 0.2 },   // Deep Blue
                { x: containerWidth * 0.6, y: containerHeight * 0.25 },   // Mystic Waters
                { x: containerWidth * 0.75, y: containerHeight * 0.3 },   // Abyssal Depths
                { x: containerWidth * 0.85, y: containerHeight * 0.45 },  // Golden Lagoon
                { x: containerWidth * 0.8, y: containerHeight * 0.65 },  // Crystal Bay
                { x: containerWidth * 0.65, y: containerHeight * 0.75 },  // Dragon's Cove
                { x: containerWidth * 0.45, y: containerHeight * 0.8 },    // Phantom Sea
                { x: containerWidth * 0.25, y: containerHeight * 0.7 }    // Legendary Archipelago
            ];
            
            const bestBoatIndex = Math.max(...gameState.ownedBoats);
            islands.forEach((island, index) => {
                const isUnlocked = gameState.unlockedIslands.includes(index);
                const isCurrent = gameState.currentIsland === index;
                const canUnlock = !isUnlocked && bestBoatIndex >= island.boatReq && gameState.gold >= island.unlockCost;
                
                const islandDiv = document.createElement('div');
                islandDiv.className = 'map-island';
                islandDiv.style.left = positions[index].x + 'px';
                islandDiv.style.top = positions[index].y + 'px';
                
                if (isCurrent) {
                    islandDiv.classList.add('current');
                }
                if (!isUnlocked && !canUnlock) {
                    islandDiv.classList.add('locked');
                }
                
                islandDiv.innerHTML = `<div>${island.name}</div>`;
                islandDiv.title = isUnlocked 
                    ? `Click to travel to ${island.name}` 
                    : `Locked - Requires ${boats[island.boatReq].name} and ${island.unlockCost} gold`;
                
                islandDiv.onclick = () => {
                    if (isUnlocked || canUnlock) {
                        changeIsland(index);
                        closeModal('mapModal');
                    }
                };
                
                mapContainer.appendChild(islandDiv);
            });
        }

        // Save/Load functions using cookies
        function saveGame() {
            try {
                // Create a comprehensive save data object
                const saveData = {
                    version: "1.0",
                    timestamp: Date.now(),
                    gameState: {
                        level: gameState.level || 1,
                        gold: gameState.gold || 100,
                        experience: gameState.experience || 0,
                        currentIsland: gameState.currentIsland || 0,
                        inventory: gameState.inventory ? JSON.parse(JSON.stringify(gameState.inventory)) : [],
                        ownedBoats: gameState.ownedBoats ? [...gameState.ownedBoats] : [0],
                        ownedRods: gameState.ownedRods ? [...gameState.ownedRods] : [0],
                        unlockedIslands: gameState.unlockedIslands ? [...gameState.unlockedIslands] : [0],
                        totalFishCaught: gameState.totalFishCaught || 0
                    },
                    autoClickerActive: autoClickerActive || false,
                    secretAutoClickerActive: secretAutoClickerActive || false,
                    secretFishAutoClickerActive: secretFishAutoClickerActive || false,
                    autoFishingMode: autoFishingMode || false
                };
                
                const saveString = JSON.stringify(saveData);
                
                // Check if save string is too large (cookies have ~4KB limit)
                if (saveString.length > 4000) {
                    console.warn('Save data is large, attempting to save anyway...');
                }
                
                // Set cookie with proper encoding
                const cookieValue = encodeURIComponent(saveString);
                const cookieString = `fishingGameSave=${cookieValue}; max-age=31536000; path=/; SameSite=Lax`;
                document.cookie = cookieString;
                
                // Simple verification - check if cookie string was set (some browsers restrict immediate reading)
                // The cookie should be saved even if we can't verify it immediately
                try {
                    const allCookies = document.cookie;
                    if (allCookies.includes('fishingGameSave=')) {
                        // Try to parse it to make sure it's valid
                        const cookieMatch = allCookies.match(/fishingGameSave=([^;]+)/);
                        if (cookieMatch && cookieMatch[1]) {
                            const decoded = decodeURIComponent(cookieMatch[1]);
                            const parsed = JSON.parse(decoded);
                            if (parsed.gameState && parsed.gameState.level !== undefined) {
                                console.log('Save verified successfully');
                                return true;
                            }
                        }
                    }
                } catch (e) {
                    // Verification failed but cookie was still set
                    console.warn('Save verification failed, but cookie was set:', e);
                }
                
                // Even if verification fails, assume success since cookie was set
                // Some browsers have security restrictions that prevent reading cookies immediately
                console.log('Save completed (verification skipped due to browser restrictions)');
                return true;
            } catch (e) {
                console.error('Error saving game:', e);
                alert('Error saving game: ' + e.message);
                return false;
            }
        }

        // Manual save function
        function manualSave() {
            const btn = document.getElementById('saveBtn');
            btn.disabled = true;
            btn.textContent = 'üíæ Saving...';
            
            // Force a small delay to ensure UI updates
            setTimeout(() => {
                if (saveGame()) {
                    addLog('üíæ Game saved successfully!');
                    addLog(`üíæ Saved: Level ${gameState.level}, ${gameState.gold.toLocaleString()} gold, ${gameState.inventory.length} fish`);
                    btn.textContent = '‚úì Saved!';
                    btn.style.background = 'linear-gradient(135deg, #28a745 0%, #20c997 100%)';
                    setTimeout(() => {
                        btn.textContent = 'üíæ Save Game';
                        btn.style.background = 'linear-gradient(135deg, #28a745 0%, #20c997 100%)';
                        btn.disabled = false;
                    }, 2000);
                } else {
                    addLog('‚ùå Error saving game! Check console for details.');
                    btn.textContent = '‚ùå Save Failed';
                    btn.style.background = 'linear-gradient(135deg, #dc3545 0%, #c82333 100%)';
                    setTimeout(() => {
                        btn.textContent = 'üíæ Save Game';
                        btn.style.background = 'linear-gradient(135deg, #28a745 0%, #20c997 100%)';
                        btn.disabled = false;
                    }, 2000);
                }
            }, 100);
        }

        function loadGame() {
            const cookies = document.cookie.split(';');
            let saveData = null;
            
            for (let cookie of cookies) {
                const [name, value] = cookie.trim().split('=');
                if (name === 'fishingGameSave') {
                    try {
                        saveData = JSON.parse(decodeURIComponent(value));
                        break;
                    } catch (e) {
                        console.error('Error loading save data:', e);
                    }
                }
            }
            
            if (saveData && saveData.gameState) {
                // Restore game state
                Object.assign(gameState, saveData.gameState);
                
                // Restore background color based on current island
                if (gameState.currentIsland !== undefined && islands[gameState.currentIsland]) {
                    document.body.style.background = islands[gameState.currentIsland].background;
                }
                
                // Restore auto-clicker states (only toggle if they were active)
                if (saveData.autoClickerActive && !autoClickerActive) {
                    toggleAutoClicker();
                }
                if (saveData.secretAutoClickerActive && !secretAutoClickerActive) {
                    toggleSecretAutoClicker();
                }
                if (saveData.secretFishAutoClickerActive && !secretFishAutoClickerActive) {
                    toggleSecretFishAutoClicker();
                }
                if (saveData.autoFishingMode !== undefined) {
                    autoFishingMode = saveData.autoFishingMode;
                }
                
                addLog('üíæ Game loaded successfully!');
                updateUI();
                return true;
            }
            return false;
        }

        // Auto-save periodically (every 30 seconds)
        setInterval(() => {
            saveGame();
        }, 30000);

        // Event Listeners
        const fishBtn = document.getElementById('fishBtn');
        if (fishBtn) {
            fishBtn.addEventListener('click', goFishing);
        } else {
            console.error('fishBtn not found!');
        }
        
        const autoclickerBtn = document.getElementById('autoclickerBtn');
        if (autoclickerBtn) autoclickerBtn.addEventListener('click', toggleAutoClicker);
        
        const secretAutoclickerBtn = document.getElementById('secretAutoclickerBtn');
        if (secretAutoclickerBtn) secretAutoclickerBtn.addEventListener('click', toggleSecretAutoClicker);
        
        const secretFishAutoclickerBtn = document.getElementById('secretFishAutoclickerBtn');
        if (secretFishAutoclickerBtn) secretFishAutoclickerBtn.addEventListener('click', toggleSecretFishAutoClicker);
        
        const saveBtn = document.getElementById('saveBtn');
        if (saveBtn) saveBtn.addEventListener('click', manualSave);
        
        const shipwrightBtn = document.getElementById('shipwrightBtn');
        if (shipwrightBtn) shipwrightBtn.addEventListener('click', () => openModal('shipwrightModal'));
        
        const merchantBtn = document.getElementById('merchantBtn');
        if (merchantBtn) merchantBtn.addEventListener('click', () => openModal('merchantModal'));
        
        const appraiserBtn = document.getElementById('appraiserBtn');
        if (appraiserBtn) appraiserBtn.addEventListener('click', () => openModal('appraiserModal'));
        
        const rodsBtn = document.getElementById('rodsBtn');
        if (rodsBtn) rodsBtn.addEventListener('click', () => openModal('rodsModal'));
        
        const mapBtn = document.getElementById('mapBtn');
        if (mapBtn) mapBtn.addEventListener('click', () => openModal('mapModal'));

        // Close modals when clicking outside
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.remove('active');
                }
            });
        });

        // Keyboard controls for fishing game
        document.addEventListener('keydown', (e) => {
            if (!fishingGameActive) return;
            
            if (e.key === 'ArrowLeft' || e.key === 'a' || e.key === 'A') {
                keysPressed.left = true;
                e.preventDefault();
            }
            if (e.key === 'ArrowRight' || e.key === 'd' || e.key === 'D') {
                keysPressed.right = true;
                e.preventDefault();
            }
        });

        document.addEventListener('keyup', (e) => {
            if (!fishingGameActive) return;
            
            if (e.key === 'ArrowLeft' || e.key === 'a' || e.key === 'A') {
                keysPressed.left = false;
                e.preventDefault();
            }
            if (e.key === 'ArrowRight' || e.key === 'd' || e.key === 'D') {
                keysPressed.right = false;
                e.preventDefault();
            }
        });

        // Initialize
        if (!loadGame()) {
            // No save data found, start fresh
            document.body.style.background = islands[0].background;
            addLog("üé£ Welcome to Fishing Adventure!");
            addLog("Start fishing to earn gold and level up!");
        }
        updateUI();
    </script>
</body>
</html>
