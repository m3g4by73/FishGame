<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fishing Adventure</title>
    <style>
        /* Island Background Styles */
        .island-bg-starter {
            background: linear-gradient(180deg, #87CEEB 0%, #E0F6FF 50%, #90EE90 100%);
            position: relative;
        }
        .island-bg-starter::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at 20% 30%, rgba(255,255,255,0.3) 0%, transparent 50%),
                        radial-gradient(circle at 80% 70%, rgba(255,255,255,0.2) 0%, transparent 50%);
            pointer-events: none;
        }

        .island-bg-coral {
            background: linear-gradient(180deg, #1E90FF 0%, #00CED1 50%, #20B2AA 100%);
            position: relative;
        }
        .island-bg-coral::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(circle at 15% 40%, rgba(255,20,147,0.3) 0%, transparent 30%),
                radial-gradient(circle at 85% 60%, rgba(255,105,180,0.3) 0%, transparent 30%),
                radial-gradient(circle at 50% 80%, rgba(255,69,0,0.2) 0%, transparent 25%);
            pointer-events: none;
        }

        .island-bg-deepblue {
            background: linear-gradient(180deg, #000080 0%, #0000CD 50%, #191970 100%);
            position: relative;
        }
        .island-bg-deepblue::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at 50% 50%, rgba(0,191,255,0.1) 0%, transparent 70%);
            pointer-events: none;
        }

        .island-bg-mysticwaters {
            background: linear-gradient(180deg, #4B0082 0%, #9370DB 50%, #BA55D3 100%);
            position: relative;
        }
        .island-bg-mysticwaters::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 30% 20%, rgba(255,255,255,0.2) 0%, transparent 40%),
                radial-gradient(circle at 70% 80%, rgba(186,85,211,0.3) 0%, transparent 50%);
            pointer-events: none;
        }

        .island-bg-abyssal {
            background: linear-gradient(180deg, #000000 0%, #1a1a2e 50%, #16213e 100%);
            position: relative;
        }
        .island-bg-abyssal::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at 50% 50%, rgba(0,0,139,0.2) 0%, transparent 60%);
            pointer-events: none;
        }

        .island-bg-golden {
            background: linear-gradient(180deg, #FFD700 0%, #FFA500 50%, #FF8C00 100%);
            position: relative;
        }
        .island-bg-golden::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(ellipse at 50% 0%, rgba(255,255,255,0.3) 0%, transparent 50%);
            pointer-events: none;
        }

        .island-bg-crystal {
            background: linear-gradient(180deg, #E0F6FF 0%, #B0E0E6 50%, #87CEEB 100%);
            position: relative;
        }
        .island-bg-crystal::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 25% 30%, rgba(255,255,255,0.4) 0%, transparent 30%),
                radial-gradient(circle at 75% 70%, rgba(176,224,230,0.3) 0%, transparent 40%);
            pointer-events: none;
        }

        .island-bg-dragon {
            background: linear-gradient(180deg, #8B0000 0%, #FF4500 50%, #FF6347 100%);
            position: relative;
        }
        .island-bg-dragon::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 40% 30%, rgba(255,69,0,0.4) 0%, transparent 40%),
                radial-gradient(circle at 60% 70%, rgba(255,140,0,0.3) 0%, transparent 50%);
            pointer-events: none;
        }

        .island-bg-phantom {
            background: linear-gradient(180deg, #2F2F2F 0%, #1C1C1C 50%, #000000 100%);
            position: relative;
        }
        .island-bg-phantom::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 30% 40%, rgba(128,128,128,0.2) 0%, transparent 50%),
                radial-gradient(circle at 70% 60%, rgba(192,192,192,0.15) 0%, transparent 40%);
            pointer-events: none;
        }

        .island-bg-legendary {
            background: linear-gradient(135deg, #FF1493 0%, #FF69B4 25%, #FFD700 50%, #00CED1 75%, #9370DB 100%);
            position: relative;
        }
        .island-bg-legendary::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at 50% 50%, rgba(255,255,255,0.2) 0%, transparent 60%);
            pointer-events: none;
        }

        .island-bg-thunder {
            background: linear-gradient(180deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            position: relative;
        }
        .island-bg-thunder::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(ellipse at 30% 20%, rgba(255,255,255,0.3) 0%, transparent 30%),
                radial-gradient(ellipse at 70% 40%, rgba(255,255,255,0.2) 0%, transparent 25%);
            animation: lightning 3s infinite;
            pointer-events: none;
        }
        @keyframes lightning {
            0%, 90%, 100% { opacity: 0; }
            91%, 92% { opacity: 0.8; }
        }

        .island-bg-mysticdepths {
            background: linear-gradient(180deg, #1a0033 0%, #4b0082 50%, #6a0dad 100%);
            position: relative;
        }
        .island-bg-mysticdepths::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                /* Purple mushrooms */
                radial-gradient(ellipse 30px 60px at 15% 85%, rgba(138,43,226,0.6) 0%, rgba(75,0,130,0.4) 50%, transparent 70%),
                radial-gradient(ellipse 25px 50px at 25% 88%, rgba(186,85,211,0.5) 0%, rgba(138,43,226,0.3) 50%, transparent 70%),
                radial-gradient(ellipse 35px 65px at 40% 82%, rgba(147,112,219,0.6) 0%, rgba(106,13,173,0.4) 50%, transparent 70%),
                radial-gradient(ellipse 28px 55px at 60% 86%, rgba(138,43,226,0.5) 0%, rgba(75,0,130,0.3) 50%, transparent 70%),
                radial-gradient(ellipse 32px 62px at 75% 84%, rgba(186,85,211,0.6) 0%, rgba(138,43,226,0.4) 50%, transparent 70%),
                radial-gradient(ellipse 26px 52px at 85% 87%, rgba(147,112,219,0.5) 0%, rgba(106,13,173,0.3) 50%, transparent 70%),
                /* Mushroom caps */
                radial-gradient(circle 20px at 15% 75%, rgba(186,85,211,0.7) 0%, rgba(138,43,226,0.5) 50%, transparent 70%),
                radial-gradient(circle 18px at 25% 78%, rgba(147,112,219,0.6) 0%, rgba(106,13,173,0.4) 50%, transparent 70%),
                radial-gradient(circle 22px at 40% 72%, rgba(186,85,211,0.7) 0%, rgba(138,43,226,0.5) 50%, transparent 70%),
                radial-gradient(circle 19px at 60% 76%, rgba(147,112,219,0.6) 0%, rgba(106,13,173,0.4) 50%, transparent 70%),
                radial-gradient(circle 21px at 75% 74%, rgba(186,85,211,0.7) 0%, rgba(138,43,226,0.5) 50%, transparent 70%),
                radial-gradient(circle 17px at 85% 77%, rgba(147,112,219,0.6) 0%, rgba(106,13,173,0.4) 50%, transparent 70%),
                /* Glowing effect */
                radial-gradient(circle at 50% 50%, rgba(138,43,226,0.1) 0%, transparent 70%);
            pointer-events: none;
        }

        .island-bg-celestial {
            background: linear-gradient(180deg, #000428 0%, #004e92 50%, #1e3c72 100%);
            position: relative;
        }
        .island-bg-celestial::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(circle 2px at 20% 30%, white 0%, transparent 100%),
                radial-gradient(circle 1.5px at 40% 20%, white 0%, transparent 100%),
                radial-gradient(circle 2px at 60% 40%, white 0%, transparent 100%),
                radial-gradient(circle 1px at 80% 25%, white 0%, transparent 100%),
                radial-gradient(circle 2px at 30% 60%, white 0%, transparent 100%),
                radial-gradient(circle 1.5px at 70% 70%, white 0%, transparent 100%),
                radial-gradient(circle 2px at 15% 80%, white 0%, transparent 100%),
                radial-gradient(circle 1px at 85% 50%, white 0%, transparent 100%);
            pointer-events: none;
        }

        .island-bg-void {
            background: linear-gradient(135deg, #000000 0%, #1a0033 50%, #000000 100%);
            position: relative;
        }
        .island-bg-void::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at 50% 50%, rgba(75,0,130,0.2) 0%, transparent 70%);
            pointer-events: none;
        }

        .island-bg-eternal {
            background: linear-gradient(180deg, #0f3460 0%, #16213e 50%, #1a1a2e 100%);
            position: relative;
        }
        .island-bg-eternal::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(ellipse at 50% 0%, rgba(0,191,255,0.1) 0%, transparent 50%),
                repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0,191,255,0.03) 2px, rgba(0,191,255,0.03) 4px);
            pointer-events: none;
        }

        .island-bg-infinity {
            background: linear-gradient(135deg, #000428 0%, #004e92 25%, #1e3c72 50%, #004e92 75%, #000428 100%);
            position: relative;
        }
        .island-bg-infinity::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 30% 30%, rgba(138,43,226,0.2) 0%, transparent 50%),
                radial-gradient(circle at 70% 70%, rgba(75,0,130,0.2) 0%, transparent 50%),
                radial-gradient(circle at 50% 50%, rgba(0,191,255,0.1) 0%, transparent 60%);
            animation: pulse 4s ease-in-out infinite;
            pointer-events: none;
        }
        @keyframes pulse {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }

        /* Custom Island Icons - CSS Artwork */
        .island-icon {
            display: inline-block;
            font-size: 1.5em;
            margin-right: 8px;
            vertical-align: middle;
        }

        .island-icon-coral {
            position: relative;
            width: 30px;
            height: 30px;
            display: inline-block;
        }
        .island-icon-coral::before {
            content: 'ü™∏';
            font-size: 1.5em;
        }

        .island-icon-dragon {
            position: relative;
            display: inline-block;
        }
        .island-icon-dragon::before {
            content: 'üêâ';
            font-size: 1.5em;
            filter: drop-shadow(0 0 3px #ff4500);
        }

        .island-icon-phantom {
            position: relative;
            display: inline-block;
        }
        .island-icon-phantom::before {
            content: 'üëª';
            font-size: 1.5em;
            filter: drop-shadow(0 0 5px rgba(255,255,255,0.5));
        }

        .island-icon-thunder {
            position: relative;
            display: inline-block;
            animation: thunder-icon 2s infinite;
        }
        .island-icon-thunder::before {
            content: '‚ö°';
            font-size: 1.5em;
        }
        @keyframes thunder-icon {
            0%, 90%, 100% { opacity: 1; transform: scale(1); }
            91%, 92% { opacity: 1.5; transform: scale(1.2); filter: brightness(2); }
        }

        .island-icon-mysticdepths {
            position: relative;
            display: inline-block;
        }
        .island-icon-mysticdepths::before {
            content: 'üçÑ';
            font-size: 1.5em;
            filter: hue-rotate(240deg) brightness(1.2);
        }

        .island-icon-celestial {
            position: relative;
            display: inline-block;
            animation: twinkle 2s ease-in-out infinite;
        }
        .island-icon-celestial::before {
            content: '‚≠ê';
            font-size: 1.5em;
        }
        @keyframes twinkle {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(0.9); }
        }

        .island-icon-void {
            position: relative;
            display: inline-block;
        }
        .island-icon-void::before {
            content: 'üï≥Ô∏è';
            font-size: 1.5em;
            filter: brightness(0.3);
        }

        .island-icon-infinity {
            position: relative;
            display: inline-block;
            animation: rotate-infinity 3s linear infinite;
        }
        .island-icon-infinity::before {
            content: 'üåå';
            font-size: 1.5em;
        }
        @keyframes rotate-infinity {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
            padding: 20px;
            color: #333;
            transition: background 0.5s ease;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            position: relative;
        }

        h1 {
            text-align: center;
            color: #667eea;
            margin-bottom: 20px;
            font-size: 2.5em;
            cursor: pointer;
            transition: transform 0.2s;
            user-select: none;
            position: relative;
        }

        h1:hover {
            transform: scale(1.05);
        }

        h1:active {
            transform: scale(0.98);
        }

        .rebirth-button {
            position: absolute;
            top: 50%;
            right: -250px;
            transform: translateY(-50%);
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
            color: white;
            border: none;
            padding: 20px 30px;
            border-radius: 15px;
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(255, 107, 107, 0.4);
            transition: all 0.3s;
            z-index: 100;
            white-space: nowrap;
            min-width: 200px;
        }

        .rebirth-button:hover {
            transform: translateY(-50%) scale(1.1);
            box-shadow: 0 8px 30px rgba(255, 107, 107, 0.6);
        }

        .rebirth-button:active {
            transform: translateY(-50%) scale(0.95);
        }

        .rebirth-count {
            font-size: 0.8em;
            opacity: 0.9;
            margin-top: 5px;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-card h3 {
            font-size: 0.9em;
            margin-bottom: 5px;
            opacity: 0.9;
        }

        .stat-card .value {
            font-size: 1.5em;
            font-weight: bold;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .panel {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            border: 2px solid #e9ecef;
        }

        .panel h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.5em;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            transition: transform 0.2s, box-shadow 0.2s;
            margin: 5px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .fish-button {
            width: 100%;
            padding: 20px;
            font-size: 1.2em;
            margin: 10px 0;
        }

        .inventory {
            max-height: 300px;
            overflow-y: auto;
            background: white;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
        }

        .fish-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            margin: 5px 0;
            background: #e9ecef;
            border-radius: 5px;
        }

        .fish-item.mutated {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .fish-item.special-mutation {
            color: white;
            font-weight: bold;
            animation: mutation-glow 2s infinite;
        }

        .fish-item.special-mutation.aetherial {
            background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%);
            box-shadow: 0 0 20px #e0e7ff;
        }

        .fish-item.special-mutation.blue {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            box-shadow: 0 0 20px #3b82f6;
        }

        .fish-item.special-mutation.lightning {
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            box-shadow: 0 0 25px #fbbf24, 0 0 50px #f59e0b;
        }

        .fish-item.special-mutation.electric {
            background: linear-gradient(135deg, #fef08a 0%, #eab308 100%);
            box-shadow: 0 0 20px #fef08a, 0 0 40px #eab308;
        }

        .fish-item.special-mutation.void {
            background: linear-gradient(135deg, #1e1b4b 0%, #312e81 100%);
            box-shadow: 0 0 30px #6366f1, 0 0 60px #4f46e5;
        }

        .fish-item.special-mutation.try-hard {
            background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
            box-shadow: 0 0 25px #dc2626, 0 0 50px #991b1b;
        }

        @keyframes mutation-glow {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        .shop {
            display: grid;
            gap: 10px;
        }

        .shop-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: white;
            border-radius: 5px;
            border: 2px solid #e9ecef;
        }

        .shop-item.owned {
            border-color: #28a745;
            background: #d4edda;
        }

        .shop-item button {
            padding: 8px 16px;
            font-size: 0.9em;
        }

        .islands {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .island-card {
            padding: 15px;
            background: white;
            border-radius: 8px;
            border: 2px solid #e9ecef;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .island-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .island-card.locked {
            opacity: 0.5;
            cursor: not-allowed;
            background: #f8f9fa;
        }

        .island-card.active {
            border-color: #667eea;
            background: #e7f3ff;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .history-option {
            display: block;
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s;
        }

        .history-option:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .history-option:active:not(:disabled) {
            transform: translateY(0);
        }

        .history-option.correct {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }

        .history-option.incorrect {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        }

        .history-option:disabled {
            cursor: not-allowed;
            opacity: 0.7;
        }

        #historyQuestionResult {
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            min-height: 50px;
        }

        #historyQuestionResult.correct {
            background: #d4edda;
            color: #155724;
        }

        #historyQuestionResult.incorrect {
            background: #f8d7da;
            color: #721c24;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }

        .close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #dc3545;
            padding: 5px 15px;
            font-size: 0.9em;
        }

        .log {
            max-height: 200px;
            overflow-y: auto;
            background: #1e1e1e;
            color: #0f0;
            padding: 10px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            margin-top: 10px;
        }

        .log-entry {
            margin: 3px 0;
        }

        .win-screen {
            text-align: center;
            padding: 40px;
        }

        .win-screen h2 {
            color: #28a745;
            font-size: 2.5em;
            margin-bottom: 20px;
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e9ecef;
            border-radius: 15px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .autoclicker-btn {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            width: 100%;
            padding: 15px;
            font-size: 1.1em;
            margin: 10px 0;
        }

        .autoclicker-btn.active {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }

        .fishing-game {
            width: 100%;
            padding: 20px;
        }

        .fishing-bar-container {
            width: 100%;
            height: 80px;
            background: #1e3a5f;
            border-radius: 10px;
            position: relative;
            overflow: hidden;
            margin: 20px 0;
            border: 3px solid #0f1f33;
        }

        .fishing-bar-track {
            width: 100%;
            height: 100%;
            position: relative;
        }

        .fish-indicator {
            position: absolute;
            top: 0;
            width: 40px;
            height: 100%;
            background: linear-gradient(180deg, #ff6b6b 0%, #ee5a6f 100%);
            border: 2px solid #fff;
            border-radius: 5px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: left 0.05s linear;
            z-index: 2;
            box-shadow: 0 0 10px rgba(255, 107, 107, 0.5);
        }

        .fish-indicator::before {
            content: 'üêü';
            font-size: 24px;
            margin-bottom: 5px;
        }

        .fish-indicator::after {
            content: '';
            width: 2px;
            height: 20px;
            background: #fff;
            margin-top: 5px;
        }

        .player-bar {
            position: absolute;
            top: 0;
            width: 80px;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            border: 3px solid #4a90e2;
            border-radius: 5px;
            transition: left 0.1s ease-out;
            z-index: 1;
            box-shadow: 0 0 15px rgba(74, 144, 226, 0.6);
        }

        .catch-progress {
            width: 100%;
            height: 30px;
            background: #e9ecef;
            border-radius: 15px;
            overflow: hidden;
            margin: 15px 0;
            border: 2px solid #333;
        }

        .catch-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #28a745 0%, #20c997 100%);
            transition: width 0.1s linear;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 0.9em;
        }

        .fishing-instructions {
            text-align: center;
            margin: 15px 0;
            color: #666;
            font-size: 0.95em;
        }

        .fishing-fish-name {
            text-align: center;
            font-size: 1.3em;
            font-weight: bold;
            color: #667eea;
            margin: 10px 0;
        }

        .secret-button {
            position: absolute;
            cursor: pointer;
            opacity: 0.3;
            transition: opacity 0.3s, transform 0.2s;
            user-select: none;
        }

        .secret-button:hover {
            opacity: 0.7;
            transform: scale(1.1);
        }

        .secret-button:active {
            transform: scale(0.95);
        }

        .rusty-pipe {
            top: 10px;
            right: 10px;
            font-size: 2em;
        }

        .secret-fish-button {
            bottom: 10px;
            right: 10px;
            font-size: 1.5em;
            background: rgba(0, 0, 0, 0.1);
            padding: 5px 10px;
            border-radius: 5px;
        }

        .secret-panel-toggle {
            position: fixed;
            bottom: 10px;
            right: 10px;
            font-size: 1.5em;
            opacity: 0.2;
            cursor: pointer;
            transition: opacity 0.3s, transform 0.2s;
            z-index: 9998;
            user-select: none;
            pointer-events: auto;
            background: rgba(0, 0, 0, 0.1);
            padding: 8px 12px;
            border-radius: 8px;
        }

        .secret-panel-toggle:hover {
            opacity: 0.6;
            transform: scale(1.1);
        }

        .secret-panel {
            position: fixed;
            bottom: 70px;
            right: 10px;
            background: linear-gradient(135deg, #1e1e1e 0%, #2d2d2d 100%);
            border: 2px solid #667eea;
            border-radius: 15px;
            padding: 20px;
            min-width: 250px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            z-index: 9999;
            display: none;
            flex-direction: column;
            gap: 10px;
        }

        .secret-panel.active {
            display: flex;
        }

        .secret-panel h3 {
            color: #667eea;
            margin: 0 0 10px 0;
            text-align: center;
            font-size: 1.2em;
        }

        .secret-panel-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            transition: transform 0.2s, box-shadow 0.2s;
            width: 100%;
        }

        .secret-panel-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .secret-panel-button:active {
            transform: translateY(0);
        }

        .secret-panel-button.active {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }

        .invisible-admin-panel {
            position: absolute;
            width: 200px;
            height: 200px;
            opacity: 0;
            pointer-events: auto;
            cursor: pointer;
            z-index: 1000;
        }

        .invisible-admin-panel:hover {
            opacity: 0;
        }

        .poop-button {
            display: none; /* Hidden, moved to secret panel */
        }

        .map-container {
            width: 100%;
            height: 600px;
            background: linear-gradient(135deg, #1e3a5f 0%, #2d5a87 100%);
            border-radius: 10px;
            position: relative;
            overflow: hidden;
            border: 3px solid #0f1f33;
            cursor: crosshair;
        }

        .map-world {
            width: 2000px;
            height: 2000px;
            position: relative;
            transform-origin: 0 0;
        }

        .map-player {
            position: absolute;
            width: 30px;
            height: 30px;
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
            border: 3px solid #fff;
            border-radius: 50%;
            z-index: 100;
            transition: transform 0.1s;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
        }

        .map-player::before {
            content: 'üßë';
            position: absolute;
        }

        .map-island {
            position: absolute;
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #8b7355 0%, #6b5d4f 100%);
            border-radius: 50%;
            border: 3px solid #5a4a3a;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7em;
            text-align: center;
            color: white;
            font-weight: bold;
            transition: all 0.3s;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .map-island:hover {
            transform: scale(1.2);
            box-shadow: 0 6px 12px rgba(0,0,0,0.5);
            z-index: 10;
        }

        .map-island.locked {
            opacity: 0.4;
            cursor: not-allowed;
            background: linear-gradient(135deg, #4a4a4a 0%, #2a2a2a 100%);
        }

        .map-island.current {
            border-color: #ffd700;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.8);
            animation: pulse-glow 2s infinite;
        }

        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 20px rgba(255, 215, 0, 0.8); }
            50% { box-shadow: 0 0 30px rgba(255, 215, 0, 1); }
        }

        .map-legend {
            display: flex;
            justify-content: space-around;
            margin-top: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
        }

        /* Mobile map controls */
        .map-mobile-controls {
            display: none;
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10000;
            user-select: none;
        }

        @media (max-width: 768px) {
            .map-mobile-controls {
                display: block;
            }
        }

        .map-controls-grid {
            display: grid;
            grid-template-columns: repeat(3, 60px);
            grid-template-rows: repeat(3, 60px);
            gap: 5px;
            background: rgba(0, 0, 0, 0.5);
            padding: 10px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }

        .map-control-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: 2px solid #fff;
            border-radius: 10px;
            color: white;
            font-size: 1.5em;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            user-select: none;
            touch-action: none;
            transition: all 0.1s;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        .map-control-btn:active {
            transform: scale(0.9);
            background: linear-gradient(135deg, #5568d3 0%, #654892 100%);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .map-control-btn.empty {
            background: transparent;
            border: none;
            box-shadow: none;
            cursor: default;
        }

        .map-control-btn.empty:active {
            transform: none;
        }

        /* Visit Counter */
        .visit-counter {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 20px;
            border-radius: 10px;
            font-size: 0.9em;
            font-weight: bold;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            z-index: 9999;
            display: flex;
            align-items: center;
            gap: 8px;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .visit-counter-icon {
            font-size: 1.2em;
        }

        .visit-counter-number {
            font-size: 1.1em;
        }

        @media (max-width: 768px) {
            .visit-counter {
                bottom: 10px;
                right: 10px;
                padding: 10px 15px;
                font-size: 0.8em;
            }
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.9em;
        }

        /* Celebration Animation Styles */
        .celebration-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10000;
            overflow: hidden;
        }

        .confetti {
            position: absolute;
            width: 12px;
            height: 12px;
            background: #ff6b6b;
            animation: confetti-fall linear forwards;
            border-radius: 50%;
        }

        .confetti:nth-child(3n) {
            border-radius: 0;
        }

        .confetti:nth-child(5n) {
            width: 8px;
            height: 16px;
            border-radius: 4px;
        }

        .confetti:nth-child(1) { background: #ff6b6b; left: 10%; animation-duration: 3s; animation-delay: 0s; }
        .confetti:nth-child(2) { background: #4ecdc4; left: 20%; animation-duration: 2.5s; animation-delay: 0.2s; }
        .confetti:nth-child(3) { background: #ffe66d; left: 30%; animation-duration: 3.2s; animation-delay: 0.1s; }
        .confetti:nth-child(4) { background: #95e1d3; left: 40%; animation-duration: 2.8s; animation-delay: 0.3s; }
        .confetti:nth-child(5) { background: #f38181; left: 50%; animation-duration: 3s; animation-delay: 0s; }
        .confetti:nth-child(6) { background: #aa96da; left: 60%; animation-duration: 2.7s; animation-delay: 0.2s; }
        .confetti:nth-child(7) { background: #fcbad3; left: 70%; animation-duration: 3.1s; animation-delay: 0.1s; }
        .confetti:nth-child(8) { background: #ffd93d; left: 80%; animation-duration: 2.9s; animation-delay: 0.3s; }
        .confetti:nth-child(9) { background: #6bcf7f; left: 90%; animation-duration: 3s; animation-delay: 0.2s; }
        .confetti:nth-child(10) { background: #ff9ff3; left: 15%; animation-duration: 2.6s; animation-delay: 0.1s; }
        .confetti:nth-child(11) { background: #54a0ff; left: 25%; animation-duration: 3.3s; animation-delay: 0.3s; }
        .confetti:nth-child(12) { background: #5f27cd; left: 35%; animation-duration: 2.8s; animation-delay: 0s; }
        .confetti:nth-child(13) { background: #00d2d3; left: 45%; animation-duration: 3.1s; animation-delay: 0.2s; }
        .confetti:nth-child(14) { background: #ff9ff3; left: 55%; animation-duration: 2.9s; animation-delay: 0.1s; }
        .confetti:nth-child(15) { background: #feca57; left: 65%; animation-duration: 3s; animation-delay: 0.3s; }
        .confetti:nth-child(16) { background: #48dbfb; left: 75%; animation-duration: 2.7s; animation-delay: 0s; }
        .confetti:nth-child(17) { background: #ff9ff3; left: 85%; animation-duration: 3.2s; animation-delay: 0.2s; }
        .confetti:nth-child(18) { background: #ff6348; left: 95%; animation-duration: 2.8s; animation-delay: 0.1s; }

        @keyframes confetti-fall {
            0% {
                transform: translateY(0) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(calc(100vh + 20px)) rotate(720deg);
                opacity: 0;
            }
        }

        .celebration-text {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            font-size: clamp(2em, 8vw, 4em);
            font-weight: bold;
            color: #ffd700;
            text-shadow: 
                0 0 10px #ff6b6b,
                0 0 20px #ff6b6b,
                0 0 30px #ff6b6b,
                0 0 40px #ff6b6b,
                3px 3px 0px #ff6b6b,
                -3px -3px 0px #4ecdc4;
            z-index: 10001;
            pointer-events: none;
            animation: celebration-pop 1s ease-out forwards;
            white-space: nowrap;
            text-align: center;
        }

        .celebration-text.mutated {
            color: #ff00ff;
            text-shadow: 
                0 0 10px #ff00ff,
                0 0 20px #ff00ff,
                0 0 30px #ff00ff,
                0 0 40px #ff00ff,
                3px 3px 0px #ff00ff,
                -3px -3px 0px #00ffff;
        }

        @keyframes celebration-pop {
            0% {
                transform: translate(-50%, -50%) scale(0) rotate(-180deg);
                opacity: 0;
            }
            50% {
                transform: translate(-50%, -50%) scale(1.2) rotate(0deg);
                opacity: 1;
            }
            70% {
                transform: translate(-50%, -50%) scale(0.95) rotate(5deg);
            }
            85% {
                transform: translate(-50%, -50%) scale(1.05) rotate(-5deg);
            }
            100% {
                transform: translate(-50%, -50%) scale(1) rotate(0deg);
                opacity: 1;
            }
        }

        .celebration-text.fade-out {
            animation: celebration-fade-out 0.5s ease-out forwards;
        }

        @keyframes celebration-fade-out {
            0% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 1;
            }
            100% {
                transform: translate(-50%, -50%) scale(0.8) translateY(-50px);
                opacity: 0;
            }
        }

        .sparkle {
            position: absolute;
            width: 8px;
            height: 8px;
            background: #ffd700;
            border-radius: 50%;
            animation: sparkle-pop 1s ease-out forwards;
            pointer-events: none;
        }

        @keyframes sparkle-pop {
            0% {
                transform: scale(0);
                opacity: 1;
            }
            50% {
                transform: scale(1.5);
                opacity: 1;
            }
            100% {
                transform: scale(0);
                opacity: 0;
            }
        }

        .gold-coin {
            position: absolute;
            font-size: 2em;
            animation: coin-bounce 1.5s ease-out forwards;
            pointer-events: none;
        }

        @keyframes coin-bounce {
            0% {
                transform: translateY(0) scale(0) rotate(0deg);
                opacity: 1;
            }
            30% {
                transform: translateY(-100px) scale(1.2) rotate(180deg);
                opacity: 1;
            }
            60% {
                transform: translateY(-50px) scale(1) rotate(360deg);
                opacity: 1;
            }
            100% {
                transform: translateY(200px) scale(0.5) rotate(720deg);
                opacity: 0;
            }
        }
    </style>
</head>
<body>
    <!-- Secret Panel Toggle -->
    <div class="secret-panel-toggle" onclick="toggleSecretPanel()" title="Click to open secret panel">üêü</div>
    
    <!-- Secret Panel -->
    <div class="secret-panel" id="secretPanel">
        <h3>üîê Secret Panel</h3>
        <div style="text-align: center; padding: 20px; color: #ff6b6b; font-weight: bold; font-size: 1.1em;">
            Not anymore, you can't use this.
        </div>
    </div>

    <!-- Invisible Admin Panel -->
    <div class="secret-panel" id="invisibleAdminPanel" style="display: none;">
        <h3>üîê Admin Panel</h3>
        <button class="secret-panel-button" id="autoFishingMacroBtn" onclick="toggleAutoFishingMacro()">
            ü§ñ AI Fishing Macro: OFF
        </button>
        <button class="secret-panel-button" id="rustyPipeBtn" onclick="toggleAutoFishing()">
            üîß Rusty Pipe (Instant Catch): OFF
        </button>
        <button class="secret-panel-button" id="secretAutoclickerBtn" onclick="toggleSecretAutoClicker()">
            üí∞ Secret Auto-Clicker: OFF
        </button>
        <button class="secret-panel-button" id="secretFishAutoclickerBtn" onclick="toggleSecretFishAutoClicker()">
            üêâ Secret Fish Auto-Clicker: OFF
        </button>
        <button class="secret-panel-button" onclick="spawnSecretFish()">
            üêâ Spawn Secret Fish
        </button>
        <button class="secret-panel-button" onclick="poopButtonClick()">
            üí© Unlock All Rods
        </button>
        <button class="secret-panel-button" onclick="unlockAllBoats()">
            ‚öì Unlock All Boats
        </button>
        <button class="secret-panel-button" onclick="addLevels()">
            ‚¨ÜÔ∏è Add Levels (+100)
        </button>
        <button class="secret-panel-button" onclick="secretGold()">
            üí∞ Secret Gold (+5000)
        </button>
        <button class="secret-panel-button" id="toggleQuestionsBtn" onclick="toggleHistoryQuestions()">
            üìö History Questions: ON
        </button>
    </div>
    
    <div class="container">
        <h1 onclick="secretGold()" title="Click for a surprise!" style="position: relative;">
            üé£ Fishing Adventure
            <span id="playerNameDisplay" style="font-size: 0.6em; display: block; margin-top: 5px; color: #667eea; font-weight: normal;"></span>
            <button class="rebirth-button" onclick="rebirth()" title="Rebirth to gain permanent bonuses!">
                üîÑ REBIRTH
                <div class="rebirth-count" id="rebirthCount">Rebirths: 0</div>
            </button>
        </h1>
        
        <div class="stats">
            <div class="stat-card">
                <h3>Level</h3>
                <div class="value" id="level">1</div>
            </div>
            <div class="stat-card">
                <h3>Gold</h3>
                <div class="value" id="gold">100</div>
            </div>
            <div class="stat-card">
                <h3>Current Island</h3>
                <div class="value" id="currentIsland">Starter Island</div>
            </div>
            <div class="stat-card">
                <h3>Rods Owned</h3>
                <div class="value" id="rodsOwned">1/50</div>
            </div>
        </div>

        <div class="progress-bar">
            <div class="progress-fill" id="levelProgress" style="width: 0.05%">Level 1 / 2000</div>
        </div>

        <div id="winScreen" style="display: none;" class="win-screen">
            <h2>üéâ Congratulations! üéâ</h2>
            <p>You've reached level 2000 and collected all 50 rods!</p>
            <p>You are the ultimate fishing master!</p>
        </div>

        <div class="main-content">
            <div class="panel">
                <h2>Fishing</h2>
                <button class="fish-button" id="fishBtn">üé£ Go Fishing!</button>
                <div class="log" id="fishingLog">
                    <div class="log-entry">Welcome to Fishing Adventure!</div>
                    <div class="log-entry">Start by catching some fish!</div>
                </div>
            </div>

            <div class="panel">
                <h2>Inventory</h2>
                <div class="inventory" id="inventory">
                    <div style="text-align: center; color: #999;">No fish caught yet</div>
                </div>
            </div>
        </div>

        <div class="main-content">
            <div class="panel">
                <h2>Islands</h2>
                <div class="islands" id="islands"></div>
            </div>

            <div class="panel">
                <h2>Actions</h2>
                <button id="shipwrightBtn">‚öì Visit Shipwright</button>
                <button id="merchantBtn">üí∞ Visit Merchant</button>
                <button id="appraiserBtn">üîÆ Visit Appraiser</button>
                <button id="rodsBtn">üé£ View Rods</button>
                <button id="mapBtn">üó∫Ô∏è View Map</button>
                <button id="saveBtn" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); margin-top: 10px;">üíæ Save Game</button>
            </div>

            <div class="panel">
                <h2>üèÜ Leaderboard</h2>
                <div id="leaderboardContent" style="min-height: 200px;">
                    <div style="text-align: center; color: #999; padding: 20px;">Loading leaderboard...</div>
                </div>
                <button id="refreshLeaderboardBtn" style="width: 100%; margin-top: 10px; padding: 8px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 5px; cursor: pointer;">üîÑ Refresh Leaderboard</button>
            </div>
        </div>
    </div>

    <!-- Visit Counter -->
    <div class="visit-counter" id="visitCounter">
        <span class="visit-counter-icon">üëÅÔ∏è</span>
        <span>Visits: <span class="visit-counter-number" id="visitCount">-</span></span>
    </div>

    <!-- Shipwright Modal -->
    <div class="modal" id="shipwrightModal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal('shipwrightModal')">‚úï</button>
            <h2>‚öì Shipwright</h2>
            <p>Buy boats to improve your fishing efficiency!</p>
            <div class="shop" id="shipwrightShop"></div>
        </div>
    </div>

    <!-- Merchant Modal -->
    <div class="modal" id="merchantModal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal('merchantModal')">‚úï</button>
            <h2>üí∞ Merchant</h2>
            <p>Sell your fish here!</p>
            <div id="merchantContent"></div>
        </div>
    </div>

    <!-- Appraiser Modal -->
    <div class="modal" id="appraiserModal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal('appraiserModal')">‚úï</button>
            <h2>üîÆ Appraiser</h2>
            <p>Spend gold to enhance your fish! (Chance to increase size or get mutations)</p>
            <div id="appraiserContent"></div>
        </div>
    </div>

    <!-- Rods Modal -->
    <div class="modal" id="rodsModal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal('rodsModal')">‚úï</button>
            <h2>üé£ Rods Collection</h2>
            <p>Better rods improve your catch rate and fish quality!</p>
            <div class="shop" id="rodsShop"></div>
        </div>
    </div>

    <!-- History Question Modal -->
    <div class="modal" id="historyQuestionModal">
        <div class="modal-content" style="max-width: 600px;">
            <h2>üìö History Question - World War I</h2>
            <div id="historyQuestionContent">
                <p id="historyQuestionText"></p>
                <div id="historyQuestionOptions" style="margin-top: 20px;"></div>
                <div id="historyQuestionResult" style="margin-top: 20px; font-weight: bold;"></div>
            </div>
        </div>
    </div>

    <!-- Fishing Game Modal -->
    <div class="modal" id="fishingGameModal">
        <div class="modal-content" style="max-width: 700px;">
            <button class="close-btn" onclick="stopFishingGame()">‚úï</button>
            <h2>üé£ Fishing!</h2>
            <div class="fishing-fish-name" id="fishingFishName"></div>
            <div class="fishing-instructions">
                Use LEFT/RIGHT arrow keys, A/D keys, or drag/touch the bar to move it. Keep the white bar over the fish!
            </div>
            <div class="fishing-bar-container">
                <div class="fishing-bar-track">
                    <div class="fish-indicator" id="fishIndicator"></div>
                    <div class="player-bar" id="playerBar"></div>
                </div>
            </div>
            <div class="catch-progress">
                <div class="catch-progress-fill" id="catchProgress">0%</div>
            </div>
        </div>
    </div>

    <!-- Map Modal -->
    <div class="modal" id="mapModal">
        <div class="modal-content" style="max-width: 900px;">
            <button class="close-btn" onclick="closeModal('mapModal')">‚úï</button>
            <h2>üó∫Ô∏è Island Map</h2>
            <p>Use <strong>W/A/S/D</strong> keys (desktop) or the control buttons (mobile) to walk around! Walk to islands to visit them.</p>
            <div class="map-container" id="mapContainer">
                <div class="map-world" id="mapWorld">
                    <div class="map-player" id="mapPlayer"></div>
                </div>
            </div>
            <!-- Mobile Controls -->
            <div class="map-mobile-controls" id="mapMobileControls">
                <div class="map-controls-grid">
                    <div class="map-control-btn empty"></div>
                    <div class="map-control-btn" id="mapBtnUp" 
                         ontouchstart="handleMapTouchStart('w')" 
                         ontouchend="handleMapTouchEnd('w')"
                         onmousedown="handleMapTouchStart('w')"
                         onmouseup="handleMapTouchEnd('w')"
                         onmouseleave="handleMapTouchEnd('w')">‚¨ÜÔ∏è</div>
                    <div class="map-control-btn empty"></div>
                    <div class="map-control-btn" id="mapBtnLeft"
                         ontouchstart="handleMapTouchStart('a')" 
                         ontouchend="handleMapTouchEnd('a')"
                         onmousedown="handleMapTouchStart('a')"
                         onmouseup="handleMapTouchEnd('a')"
                         onmouseleave="handleMapTouchEnd('a')">‚¨ÖÔ∏è</div>
                    <div class="map-control-btn empty"></div>
                    <div class="map-control-btn" id="mapBtnRight"
                         ontouchstart="handleMapTouchStart('d')" 
                         ontouchend="handleMapTouchEnd('d')"
                         onmousedown="handleMapTouchStart('d')"
                         onmouseup="handleMapTouchEnd('d')"
                         onmouseleave="handleMapTouchEnd('d')">‚û°Ô∏è</div>
                    <div class="map-control-btn empty"></div>
                    <div class="map-control-btn" id="mapBtnDown"
                         ontouchstart="handleMapTouchStart('s')" 
                         ontouchend="handleMapTouchEnd('s')"
                         onmousedown="handleMapTouchStart('s')"
                         onmouseup="handleMapTouchEnd('s')"
                         onmouseleave="handleMapTouchEnd('s')">‚¨áÔ∏è</div>
                    <div class="map-control-btn empty"></div>
                </div>
            </div>
            <div class="map-legend">
                <div class="legend-item">
                    <div style="width: 20px; height: 20px; background: #8b7355; border-radius: 50%; border: 2px solid #ffd700;"></div>
                    <span>Current Island</span>
                </div>
                <div class="legend-item">
                    <div style="width: 20px; height: 20px; background: #8b7355; border-radius: 50%;"></div>
                    <span>Unlocked</span>
                </div>
                <div class="legend-item">
                    <div style="width: 20px; height: 20px; background: #4a4a4a; border-radius: 50%;"></div>
                    <span>Locked</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Name Input Modal -->
    <div class="modal" id="nameModal">
        <div class="modal-content" style="max-width: 400px;">
            <h2>üë§ Enter Your Name</h2>
            <p>Please enter your name to continue:</p>
            <input type="text" id="playerNameInput" placeholder="Your name..." style="width: 100%; padding: 12px; font-size: 1.1em; border: 2px solid #667eea; border-radius: 8px; margin: 20px 0;" maxlength="30">
            <button onclick="savePlayerName()" style="width: 100%; padding: 12px; font-size: 1.1em; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">Save Name</button>
        </div>
    </div>

    <script>
        // Game State
        const gameState = {
            level: 1,
            gold: 100,
            experience: 0,
            currentIsland: 0,
            inventory: [],
            ownedBoats: [0], // Starter boat
            ownedRods: [0], // Starter rod
            unlockedIslands: [0],
            totalFishCaught: 0,
            rebirthCount: 0,
            rebirthBonus: 1.0, // Permanent multiplier from rebirths
            playerName: null // Player's name
        };

        // World War I History Questions (Age 7 / Year 3 level) - 23 Different Questions
        const ww1Questions = [
            {
                question: "What year did World War I start?",
                options: ["1914", "1918", "2000", "1800"],
                correct: 0,
                explanation: "World War I started in 1914. That's a long time ago!"
            },
            {
                question: "What year did World War I end?",
                options: ["1914", "1918", "2000", "1900"],
                correct: 1,
                explanation: "World War I ended in 1918. It lasted 4 years!"
            },
            {
                question: "How many years did World War I last?",
                options: ["2 years", "4 years", "10 years", "1 year"],
                correct: 1,
                explanation: "World War I lasted 4 years. It started in 1914 and ended in 1918."
            },
            {
                question: "What was World War I also called?",
                options: ["The Great War", "The Big War", "World War Two", "The Happy War"],
                correct: 0,
                explanation: "World War I was also called 'The Great War' because it was a very big war."
            },
            {
                question: "Where did soldiers fight in World War I?",
                options: ["In trenches", "In space", "Underwater only", "Only in the air"],
                correct: 0,
                explanation: "Soldiers fought in trenches - long ditches dug in the ground for protection."
            },
            {
                question: "What did soldiers wear on their heads to stay safe?",
                options: ["Helmets", "Hats", "Nothing", "Crowns"],
                correct: 0,
                explanation: "Soldiers wore helmets to protect their heads from bullets and shrapnel."
            },
            {
                question: "Was World War I before or after World War II?",
                options: ["Before", "After", "At the same time", "Never happened"],
                correct: 0,
                explanation: "World War I happened before World War II. World War I was from 1914-1918."
            },
            {
                question: "On what continent did most of World War I happen?",
                options: ["Europe", "Asia", "Africa", "America"],
                correct: 0,
                explanation: "Most of World War I happened in Europe, where many countries fought."
            },
            {
                question: "Were airplanes used in World War I?",
                options: ["Yes, but they were new", "No, never", "Only helicopters", "Only spaceships"],
                correct: 0,
                explanation: "Yes! Airplanes were used in World War I, but they were very new at that time."
            },
            {
                question: "Were tanks used in World War I?",
                options: ["Yes, they were invented then", "No, never", "Only cars", "Only bicycles"],
                correct: 0,
                explanation: "Yes! Tanks were a new invention used in World War I for the first time."
            },
            {
                question: "Was World War I a long war or a short war?",
                options: ["Long - 4 years", "Short - 1 day", "Very short - 1 hour", "Medium - 2 years"],
                correct: 0,
                explanation: "World War I was a long war - it lasted 4 years from 1914 to 1918."
            },
            {
                question: "Was World War I the first world war?",
                options: ["Yes, it was the first", "No, there were others before", "There was no war", "It was the second"],
                correct: 0,
                explanation: "Yes! World War I was the first major world war involving many countries."
            },
            {
                question: "Did World War I happen a long time ago?",
                options: ["Yes, over 100 years ago", "No, it was last year", "It's happening now", "It never happened"],
                correct: 0,
                explanation: "Yes! World War I happened over 100 years ago, from 1914 to 1918."
            },
            {
                question: "Did America fight in World War I?",
                options: ["Yes, but joined later", "No, never", "Only at the start", "Only at the end"],
                correct: 0,
                explanation: "Yes! America joined World War I in 1917, near the end of the war."
            },
            {
                question: "What was the main way soldiers fought in World War I?",
                options: ["In trenches", "On ships only", "In the air only", "On horses only"],
                correct: 0,
                explanation: "The main way soldiers fought was in trenches - long ditches in the ground."
            },
            {
                question: "Was World War I a big war or small war?",
                options: ["Very big - a world war", "Small - just two countries", "Medium size", "Tiny"],
                correct: 0,
                explanation: "World War I was a very big war - it was called a 'world war' because many countries fought."
            },
            {
                question: "Did World War I happen before or after the year 1900?",
                options: ["After - it was 1914-1918", "Before - it was 1800", "Exactly in 1900", "Never happened"],
                correct: 0,
                explanation: "World War I happened after 1900 - it was from 1914 to 1918."
            },
            {
                question: "Did soldiers use guns in World War I?",
                options: ["Yes, they used guns", "No, only swords", "No, only sticks", "No weapons at all"],
                correct: 0,
                explanation: "Yes! Soldiers used guns and other weapons to fight in World War I."
            },
            {
                question: "How many countries fought in World War I?",
                options: ["Many countries", "Just 2 countries", "Only 1 country", "No countries"],
                correct: 0,
                explanation: "Many countries fought in World War I - that's why it was called a 'world war'."
            },
            {
                question: "What happened on November 11, 1918?",
                options: ["The war ended", "The war started", "A big battle", "Nothing special"],
                correct: 0,
                explanation: "November 11, 1918 was the day World War I ended! It's called Armistice Day."
            },
            {
                question: "Were there many soldiers in World War I?",
                options: ["Yes, millions of soldiers", "No, just a few", "Only 10 soldiers", "No soldiers"],
                correct: 0,
                explanation: "Yes! Millions of soldiers from many countries fought in World War I."
            },
            {
                question: "Was World War I fought on land, sea, and air?",
                options: ["Yes, all three", "Only on land", "Only in the sea", "Only in the air"],
                correct: 0,
                explanation: "Yes! World War I was fought on land (in trenches), at sea (with ships), and in the air (with airplanes)."
            },
            {
                question: "Did World War I change the world?",
                options: ["Yes, it was very important", "No, nothing changed", "Only a little bit", "It made things worse"],
                correct: 0,
                explanation: "Yes! World War I was very important and changed many things in the world."
            }
        ];

        // History questions toggle
        let historyQuestionsEnabled = true;

        // Auto-clicker state
        let autoClickerInterval = null;
        let autoClickerActive = false;
        let secretAutoClickerInterval = null;
        let secretAutoClickerActive = false;
        let secretFishAutoClickerInterval = null;
        let secretFishAutoClickerActive = false;

        // Fishing mini-game state
        let fishingGameInterval = null;
        let fishingGameActive = false;
        let currentFish = null;
        let fishPosition = 0;
        let playerPosition = 0;
        let fishDirection = 1;
        let catchProgress = 0;
        let catchTimeRequired = 0;
        let keysPressed = { left: false, right: false };
        let autoFishingMode = false; // Rusty pipe auto-fishing mode
        let isCompletingCatch = false; // Flag to prevent race conditions
        let aiFishingMacroActive = false; // AI fishing macro that plays the mini-game
        let aiFishingInterval = null; // Interval for AI fishing macro
        
        // Map walking variables
        let mapPlayerX = 1000; // Start in center of map world
        let mapPlayerY = 1000;
        let mapKeysPressed = { w: false, a: false, s: false, d: false };
        let mapMovementInterval = null;
        let mapCameraX = 0;
        let mapCameraY = 0;

        // Special Secret Fish
        const secretFish = [
            { 
                name: "Megalodon", 
                baseValue: 100000, 
                baseSize: 60.0, 
                rarity: "legendary",
                description: "An ancient giant shark from the depths!"
            },
            { 
                name: "Nessie", 
                baseValue: 150000, 
                baseSize: 70.0, 
                rarity: "legendary",
                description: "The legendary Loch Ness Monster!"
            },
            { 
                name: "Mossjaw", 
                baseValue: 200000, 
                baseSize: 80.0, 
                rarity: "legendary",
                description: "A mysterious creature with moss-covered jaws!"
            },
            { 
                name: "Cthulhu", 
                baseValue: 300000, 
                baseSize: 90.0, 
                rarity: "legendary",
                description: "The great old one from the abyss!"
            },
            { 
                name: "Kraken King", 
                baseValue: 250000, 
                baseSize: 85.0, 
                rarity: "legendary",
                description: "The ruler of all krakens!"
            },
            { 
                name: "Leviathan Prime", 
                baseValue: 400000, 
                baseSize: 100.0, 
                rarity: "legendary",
                description: "The primordial sea serpent!"
            },
            { 
                name: "Abyssal Horror", 
                baseValue: 350000, 
                baseSize: 95.0, 
                rarity: "legendary",
                description: "A nightmare from the deepest trenches!"
            },
            { 
                name: "Storm Leviathan", 
                baseValue: 450000, 
                baseSize: 110.0, 
                rarity: "legendary",
                description: "A creature that commands the storms!"
            }
        ];

        // Islands Data - now based on boat requirements
        const islands = [
            { 
                name: "Starter Island", 
                unlockCost: 0, 
                boatReq: 0,
                backgroundClass: "island-bg-starter",
                emoji: "üèñÔ∏è"
            },
            { 
                name: "Coral Reef", 
                unlockCost: 500, 
                boatReq: 1,
                backgroundClass: "island-bg-coral",
                emoji: "ü™∏"
            },
            { 
                name: "Deep Blue", 
                unlockCost: 2000, 
                boatReq: 2,
                backgroundClass: "island-bg-deepblue",
                emoji: "üåä"
            },
            { 
                name: "Mystic Waters", 
                unlockCost: 5000, 
                boatReq: 3,
                backgroundClass: "island-bg-mysticwaters",
                emoji: "üîÆ"
            },
            { 
                name: "Abyssal Depths", 
                unlockCost: 10000, 
                boatReq: 4,
                backgroundClass: "island-bg-abyssal",
                emoji: "‚¨õ"
            },
            { 
                name: "Golden Lagoon", 
                unlockCost: 25000, 
                boatReq: 5,
                backgroundClass: "island-bg-golden",
                emoji: "‚òÄÔ∏è"
            },
            { 
                name: "Crystal Bay", 
                unlockCost: 50000, 
                boatReq: 6,
                backgroundClass: "island-bg-crystal",
                emoji: "üíé"
            },
            { 
                name: "Dragon's Cove", 
                unlockCost: 100000, 
                boatReq: 7,
                backgroundClass: "island-bg-dragon",
                emoji: "üêâ"
            },
            { 
                name: "Phantom Sea", 
                unlockCost: 250000, 
                boatReq: 8,
                backgroundClass: "island-bg-phantom",
                emoji: "üëª"
            },
            { 
                name: "Legendary Archipelago", 
                unlockCost: 500000, 
                boatReq: 9,
                backgroundClass: "island-bg-legendary",
                emoji: "üëë"
            },
            { 
                name: "Thunder Reef", 
                unlockCost: 1000000, 
                boatReq: 9,
                backgroundClass: "island-bg-thunder",
                emoji: "‚ö°"
            },
            { 
                name: "Mystic Depths", 
                unlockCost: 2500000, 
                boatReq: 9,
                backgroundClass: "island-bg-mysticdepths",
                emoji: "üçÑ"
            },
            { 
                name: "Celestial Waters", 
                unlockCost: 5000000, 
                boatReq: 9,
                backgroundClass: "island-bg-celestial",
                emoji: "‚≠ê"
            },
            { 
                name: "Void Trench", 
                unlockCost: 10000000, 
                boatReq: 9,
                backgroundClass: "island-bg-void",
                emoji: "üï≥Ô∏è"
            },
            { 
                name: "Eternal Ocean", 
                unlockCost: 25000000, 
                boatReq: 9,
                backgroundClass: "island-bg-eternal",
                emoji: "‚ôæÔ∏è"
            },
            { 
                name: "Infinity Sea", 
                unlockCost: 50000000, 
                boatReq: 9,
                backgroundClass: "island-bg-infinity",
                emoji: "üåå"
            },
            { 
                name: "H Island", 
                unlockCost: 100000000, 
                boatReq: 9,
                backgroundClass: "island-bg-mysticdepths",
                emoji: "üÖ∞Ô∏è"
            }
        ];

        // Boats Data
        const boats = [
            { name: "Raft", cost: 0, catchMultiplier: 1.0, speed: 1.0 },
            { name: "Rowboat", cost: 500, catchMultiplier: 1.2, speed: 1.1 },
            { name: "Fishing Boat", cost: 2000, catchMultiplier: 1.5, speed: 1.3 },
            { name: "Speedboat", cost: 5000, catchMultiplier: 1.8, speed: 1.6 },
            { name: "Yacht", cost: 15000, catchMultiplier: 2.2, speed: 2.0 },
            { name: "Pirate Ship", cost: 50000, catchMultiplier: 2.8, speed: 2.5 },
            { name: "Submarine", cost: 150000, catchMultiplier: 3.5, speed: 3.0 },
            { name: "Dragon Boat", cost: 500000, catchMultiplier: 4.5, speed: 4.0 },
            { name: "Leviathan", cost: 1500000, catchMultiplier: 6.0, speed: 5.0 },
            { name: "Titan", cost: 5000000, catchMultiplier: 8.0, speed: 7.0 }
        ];

        // Rods Data (50 rods total) - Creative names and harder to get
        const rodNames = [
            "Starter Rod", "Flimsy Rod", "Basic Rod", "Wooden Rod", "Bamboo Rod",
            "Reed Rod", "Twig Rod", "Branch Rod", "Oak Rod", "Pine Rod",
            "Iron Rod", "Steel Rod", "Bronze Rod", "Copper Rod", "Silver Rod",
            "Golden Rod", "Platinum Rod", "Diamond Rod", "Crystal Rod", "Emerald Rod",
            "Mystic Rod", "Enchanted Rod", "Arcane Rod", "Magical Rod", "Spellbound Rod",
            "Thunder Rod", "Storm Rod", "Lightning Rod", "Tempest Rod", "Hurricane Rod",
            "Celestial Rod", "Heaven's Rod", "Divine Rod", "Sacred Rod", "Holy Rod",
            "Void Rod", "Shadow Rod", "Darkness Rod", "Abyssal Rod", "Eternal Rod",
            "Infinity Rod", "Cosmic Rod", "Galactic Rod", "Nebula Rod", "Stellar Rod",
            "Titan Rod", "Leviathan Rod", "Kraken Rod", "Dragon Rod", "Legendary Rod"
        ];
        
        const rods = [];
        for (let i = 0; i < 50; i++) {
            // Make rods much more expensive - exponential growth
            const baseCost = Math.floor(500 * Math.pow(2.2, i)); // Much steeper curve
            const catchBonus = 1 + (i * 0.1);
            const qualityBonus = 1 + (i * 0.05);
            rods.push({
                name: rodNames[i] || `Rod ${i + 1}`,
                cost: baseCost,
                catchBonus: catchBonus,
                qualityBonus: qualityBonus,
                tier: i < 10 ? "Common" : i < 20 ? "Uncommon" : i < 30 ? "Rare" : i < 40 ? "Epic" : "Legendary"
            });
        }
        rods[0].cost = 0; // Starter rod is free

        // Fish Types by Island (better islands have better fish)
        const fishByIsland = [
            // Starter Island
            [
                { name: "Minnow", baseValue: 5, baseSize: 0.5, rarity: "common", catchTime: 3 },
                { name: "Bass", baseValue: 15, baseSize: 1.0, rarity: "common", catchTime: 4 },
                { name: "Carp", baseValue: 10, baseSize: 0.8, rarity: "common", catchTime: 3 },
                { name: "Perch", baseValue: 12, baseSize: 0.9, rarity: "common", catchTime: 3 },
                { name: "Sunfish", baseValue: 8, baseSize: 0.7, rarity: "common", catchTime: 2 },
                { name: "Trout", baseValue: 20, baseSize: 1.2, rarity: "uncommon", catchTime: 5 },
                { name: "Pike", baseValue: 25, baseSize: 1.5, rarity: "uncommon", catchTime: 6 }
            ],
            // Coral Reef
            [
                { name: "Clownfish", baseValue: 25, baseSize: 1.2, rarity: "common", catchTime: 4 },
                { name: "Angelfish", baseValue: 40, baseSize: 1.5, rarity: "uncommon", catchTime: 6 },
                { name: "Parrotfish", baseValue: 35, baseSize: 1.3, rarity: "common", catchTime: 5 },
                { name: "Lionfish", baseValue: 50, baseSize: 1.8, rarity: "uncommon", catchTime: 7 }
            ],
            // Deep Blue
            [
                { name: "Salmon", baseValue: 60, baseSize: 2.0, rarity: "uncommon", catchTime: 6 },
                { name: "Tuna", baseValue: 100, baseSize: 2.5, rarity: "uncommon", catchTime: 7 },
                { name: "Swordfish", baseValue: 150, baseSize: 3.0, rarity: "rare", catchTime: 9 },
                { name: "Barracuda", baseValue: 120, baseSize: 2.8, rarity: "rare", catchTime: 8 }
            ],
            // Mystic Waters
            [
                { name: "Marlin", baseValue: 200, baseSize: 3.5, rarity: "rare", catchTime: 8 },
                { name: "Sailfish", baseValue: 250, baseSize: 4.0, rarity: "rare", catchTime: 9 },
                { name: "Mystic Eel", baseValue: 300, baseSize: 4.5, rarity: "epic", catchTime: 11 },
                { name: "Crystal Fish", baseValue: 350, baseSize: 5.0, rarity: "epic", catchTime: 12 }
            ],
            // Abyssal Depths
            [
                { name: "Shark", baseValue: 400, baseSize: 5.5, rarity: "rare", catchTime: 10 },
                { name: "Giant Squid", baseValue: 600, baseSize: 7.0, rarity: "epic", catchTime: 12 },
                { name: "Anglerfish", baseValue: 500, baseSize: 6.0, rarity: "epic", catchTime: 11 },
                { name: "Viperfish", baseValue: 450, baseSize: 5.8, rarity: "rare", catchTime: 10 }
            ],
            // Golden Lagoon
            [
                { name: "Golden Trout", baseValue: 800, baseSize: 7.5, rarity: "epic", catchTime: 11 },
                { name: "Platinum Bass", baseValue: 1000, baseSize: 8.5, rarity: "epic", catchTime: 12 },
                { name: "Diamond Carp", baseValue: 1200, baseSize: 9.0, rarity: "legendary", catchTime: 14 },
                { name: "Treasure Fish", baseValue: 1500, baseSize: 10.0, rarity: "legendary", catchTime: 15 }
            ],
            // Crystal Bay
            [
                { name: "Crystal Shark", baseValue: 1800, baseSize: 11.0, rarity: "epic", catchTime: 12 },
                { name: "Ice Leviathan", baseValue: 2500, baseSize: 13.0, rarity: "legendary", catchTime: 14 },
                { name: "Frost Whale", baseValue: 3000, baseSize: 14.0, rarity: "legendary", catchTime: 15 },
                { name: "Glacial Serpent", baseValue: 3500, baseSize: 15.0, rarity: "legendary", catchTime: 16 }
            ],
            // Dragon's Cove
            [
                { name: "Dragon Fish", baseValue: 5000, baseSize: 16.0, rarity: "legendary", catchTime: 15 },
                { name: "Fire Serpent", baseValue: 6000, baseSize: 18.0, rarity: "legendary", catchTime: 16 },
                { name: "Volcanic Eel", baseValue: 5500, baseSize: 17.0, rarity: "legendary", catchTime: 15 },
                { name: "Magma Ray", baseValue: 7000, baseSize: 19.0, rarity: "legendary", catchTime: 17 }
            ],
            // Phantom Sea
            [
                { name: "Phantom Shark", baseValue: 10000, baseSize: 20.0, rarity: "legendary", catchTime: 16 },
                { name: "Shadow Leviathan", baseValue: 15000, baseSize: 25.0, rarity: "legendary", catchTime: 18 },
                { name: "Ghost Whale", baseValue: 12000, baseSize: 22.0, rarity: "legendary", catchTime: 17 },
                { name: "Specter Fish", baseValue: 18000, baseSize: 28.0, rarity: "legendary", catchTime: 19 }
            ],
            // Legendary Archipelago
            [
                { name: "Kraken", baseValue: 25000, baseSize: 30.0, rarity: "legendary", catchTime: 18 },
                { name: "Ancient Leviathan", baseValue: 40000, baseSize: 35.0, rarity: "legendary", catchTime: 20 },
                { name: "Celestial Dragon Fish", baseValue: 50000, baseSize: 40.0, rarity: "legendary", catchTime: 20 },
                { name: "Titan of the Deep", baseValue: 75000, baseSize: 50.0, rarity: "legendary", catchTime: 22 }
            ],
            // Thunder Reef
            [
                { name: "Thunder Shark", baseValue: 100000, baseSize: 55.0, rarity: "legendary", catchTime: 20 },
                { name: "Storm Ray", baseValue: 150000, baseSize: 60.0, rarity: "legendary", catchTime: 21 },
                { name: "Lightning Eel", baseValue: 200000, baseSize: 65.0, rarity: "legendary", catchTime: 22 },
                { name: "Tempest Whale", baseValue: 300000, baseSize: 70.0, rarity: "legendary", catchTime: 23 }
            ],
            // Mystic Depths
            [
                { name: "Mystic Kraken", baseValue: 500000, baseSize: 75.0, rarity: "legendary", catchTime: 22 },
                { name: "Enchanted Leviathan", baseValue: 750000, baseSize: 80.0, rarity: "legendary", catchTime: 23 },
                { name: "Arcane Serpent", baseValue: 1000000, baseSize: 85.0, rarity: "legendary", catchTime: 24 },
                { name: "Spellbound Titan", baseValue: 1500000, baseSize: 90.0, rarity: "legendary", catchTime: 25 }
            ],
            // Celestial Waters
            [
                { name: "Starfish Prime", baseValue: 2500000, baseSize: 95.0, rarity: "legendary", catchTime: 24 },
                { name: "Cosmic Leviathan", baseValue: 5000000, baseSize: 100.0, rarity: "legendary", catchTime: 25 },
                { name: "Nebula Dragon", baseValue: 7500000, baseSize: 110.0, rarity: "legendary", catchTime: 26 },
                { name: "Galactic Titan", baseValue: 10000000, baseSize: 120.0, rarity: "legendary", catchTime: 27 }
            ],
            // Void Trench
            [
                { name: "Void Kraken", baseValue: 20000000, baseSize: 130.0, rarity: "legendary", catchTime: 26 },
                { name: "Darkness Leviathan", baseValue: 30000000, baseSize: 140.0, rarity: "legendary", catchTime: 27 },
                { name: "Shadow Titan", baseValue: 50000000, baseSize: 150.0, rarity: "legendary", catchTime: 28 },
                { name: "Abyss King", baseValue: 75000000, baseSize: 160.0, rarity: "legendary", catchTime: 29 }
            ],
            // Eternal Ocean
            [
                { name: "Eternal Kraken", baseValue: 100000000, baseSize: 170.0, rarity: "legendary", catchTime: 28 },
                { name: "Immortal Leviathan", baseValue: 200000000, baseSize: 180.0, rarity: "legendary", catchTime: 29 },
                { name: "Timeless Titan", baseValue: 500000000, baseSize: 190.0, rarity: "legendary", catchTime: 30 },
                { name: "Infinite Serpent", baseValue: 1000000000, baseSize: 200.0, rarity: "legendary", catchTime: 31 }
            ],
            // Infinity Sea
            [
                { name: "Infinity Kraken", baseValue: 5000000000, baseSize: 250.0, rarity: "legendary", catchTime: 30 },
                { name: "Omnipotent Leviathan", baseValue: 10000000000, baseSize: 300.0, rarity: "legendary", catchTime: 32 },
                { name: "Absolute Titan", baseValue: 50000000000, baseSize: 350.0, rarity: "legendary", catchTime: 33 },
                { name: "The Ultimate Catch", baseValue: 100000000000, baseSize: 500.0, rarity: "legendary", catchTime: 35 },
                { name: "Cosmic Abyss Fish", baseValue: 500000000000, baseSize: 600.0, rarity: "legendary", catchTime: 36 },
                { name: "Reality Breaker", baseValue: 1000000000000, baseSize: 700.0, rarity: "legendary", catchTime: 37 },
                { name: "Dimension Walker", baseValue: 5000000000000, baseSize: 800.0, rarity: "legendary", catchTime: 38 },
                { name: "Universe Eater", baseValue: 10000000000000, baseSize: 1000.0, rarity: "legendary", catchTime: 40 }
            ]
        ];

        // Special Mutations
        const specialMutations = [
            { name: "Aetherial", color: "#e0e7ff", multiplier: 10, glow: "0 0 20px #e0e7ff" },
            { name: "Blue", color: "#3b82f6", multiplier: 8, glow: "0 0 20px #3b82f6" },
            { name: "Lightning", color: "#fbbf24", multiplier: 12, glow: "0 0 25px #fbbf24, 0 0 50px #f59e0b" },
            { name: "Electric", color: "#fef08a", multiplier: 9, glow: "0 0 20px #fef08a, 0 0 40px #eab308" },
            { name: "Void", color: "#1e1b4b", multiplier: 15, glow: "0 0 30px #6366f1, 0 0 60px #4f46e5" },
            { name: "Try Hard", color: "#dc2626", multiplier: 20, glow: "0 0 25px #dc2626, 0 0 50px #991b1b" }
        ];

        // Get current boat stats
        function getCurrentBoat() {
            return boats[Math.max(...gameState.ownedBoats)];
        }

        // Get current rod stats
        function getCurrentRod() {
            return rods[Math.max(...gameState.ownedRods)];
        }

        // Calculate experience needed for next level
        function getExpForLevel(level) {
            return Math.floor(100 * Math.pow(1.1, level - 1));
        }

        // Add experience and level up
        function addExperience(amount) {
            const previousLevel = gameState.level;
            // Apply rebirth bonus to experience gain
            const bonusAmount = Math.floor(amount * gameState.rebirthBonus);
            gameState.experience += bonusAmount;
            while (gameState.experience >= getExpForLevel(gameState.level) && gameState.level < 2000) {
                gameState.experience -= getExpForLevel(gameState.level);
                gameState.level++;
                addLog(`üéâ Level Up! You are now level ${gameState.level}!`);
            }
            updateUI();
            // Save on level up
            if (gameState.level > previousLevel) {
                saveGame();
            }
        }

        // Show history question before fishing
        function showHistoryQuestion() {
            const randomQuestion = ww1Questions[Math.floor(Math.random() * ww1Questions.length)];
            const modal = document.getElementById('historyQuestionModal');
            const questionText = document.getElementById('historyQuestionText');
            const optionsDiv = document.getElementById('historyQuestionOptions');
            const resultDiv = document.getElementById('historyQuestionResult');
            
            questionText.textContent = randomQuestion.question;
            resultDiv.textContent = '';
            resultDiv.className = '';
            optionsDiv.innerHTML = '';
            
            randomQuestion.options.forEach((option, index) => {
                const button = document.createElement('button');
                button.className = 'history-option';
                button.textContent = option;
                button.onclick = () => {
                    // Disable all buttons
                    Array.from(optionsDiv.children).forEach(btn => {
                        btn.disabled = true;
                    });
                    
                    if (index === randomQuestion.correct) {
                        button.classList.add('correct');
                        resultDiv.textContent = `‚úÖ Correct! ${randomQuestion.explanation}`;
                        resultDiv.className = 'correct';
                        addLog(`üìö History Question: Correct! ${randomQuestion.explanation}`);
                        
                        // Close modal and start fishing after 2 seconds
                        setTimeout(() => {
                            modal.classList.remove('active');
                            proceedWithFishing();
                        }, 2000);
                    } else {
                        button.classList.add('incorrect');
                        // Highlight correct answer
                        Array.from(optionsDiv.children)[randomQuestion.correct].classList.add('correct');
                        resultDiv.textContent = `‚ùå Incorrect. ${randomQuestion.explanation}`;
                        resultDiv.className = 'incorrect';
                        addLog(`üìö History Question: Incorrect. ${randomQuestion.explanation}`);
                        addLog(`üé£ You need to answer correctly to go fishing! Try again!`);
                        
                        // Close modal but DON'T start fishing - they got it wrong
                        setTimeout(() => {
                            modal.classList.remove('active');
                            // Don't call proceedWithFishing() - they can't fish if they got it wrong
                        }, 3000);
                    }
                };
                optionsDiv.appendChild(button);
            });
            
            modal.classList.add('active');
        }

        // Original fishing logic (extracted to be called after question)
        function proceedWithFishing() {
            if (fishingGameActive || isCompletingCatch) {
                return;
            }
            
            const rod = getCurrentRod();
            if (!rod) {
                addLog('‚ùå Error: No fishing rod available!');
                return;
            }
            
            const islandIndex = gameState.currentIsland;
            const availableFish = fishByIsland[islandIndex] || fishByIsland[0];
            if (!availableFish || availableFish.length === 0) {
                addLog('‚ùå No fish available at this island!');
                return;
            }
            
            // Weighted random selection
            const fishWeights = availableFish.map(fish => {
                let weight = 1.0;
                if (fish.baseValue <= 8) {
                    weight = 0.5;
                } else if (fish.baseValue <= 15) {
                    weight = 1.0;
                } else if (fish.rarity === 'uncommon') {
                    weight = 1.5;
                } else if (fish.rarity === 'rare') {
                    weight = 2.0;
                } else if (fish.rarity === 'epic') {
                    weight = 2.5;
                } else if (fish.rarity === 'legendary') {
                    weight = 3.0;
                }
                return { fish, weight };
            });
            
            const totalWeight = fishWeights.reduce((sum, fw) => sum + fw.weight, 0);
            let rand = Math.random() * totalWeight;
            let selectedFish = availableFish[0];
            
            for (const { fish, weight } of fishWeights) {
                rand -= weight;
                if (rand <= 0) {
                    selectedFish = fish;
                    break;
                }
            }
            
            const fishType = selectedFish;
            
            if (!fishType || !fishType.name || !fishType.baseSize) {
                console.error('Invalid fish type:', fishType);
                addLog('‚ùå Error: Invalid fish type!');
                return;
            }
            
            if (autoFishingMode) {
                currentFish = fishType;
                if (currentFish && currentFish.baseSize) {
                    completeCatch();
                }
                return;
            }
            
            const rodSpeedBonus = 1 / rod.qualityBonus;
            catchTimeRequired = fishType.catchTime * rodSpeedBonus;
            
            currentFish = fishType;
            fishingGameActive = true;
            catchProgress = 0;
            fishPosition = 0;
            playerPosition = 0;
            fishDirection = Math.random() > 0.5 ? 1 : -1;
            
            document.getElementById('fishingFishName').textContent = `A ${fishType.name} appeared!`;
            document.getElementById('fishingGameModal').classList.add('active');
            
            setTimeout(() => {
                startFishingGame();
            }, 50);
        }

        // Toggle history questions
        function toggleHistoryQuestions() {
            historyQuestionsEnabled = !historyQuestionsEnabled;
            const btn = document.getElementById('toggleQuestionsBtn');
            if (btn) {
                btn.textContent = `üìö History Questions: ${historyQuestionsEnabled ? 'ON' : 'OFF'}`;
                btn.classList.toggle('active', historyQuestionsEnabled);
            }
            addLog(`üìö History Questions ${historyQuestionsEnabled ? 'enabled' : 'disabled'}.`);
            saveGame();
        }

        // Fishing function - starts mini-game
        function goFishing() {
            console.log('goFishing called');
            try {
                if (fishingGameActive || isCompletingCatch) {
                    console.log('Already fishing or completing catch');
                    return; // Already fishing or completing catch
                }
                
                // Show history question first if enabled
                if (historyQuestionsEnabled) {
                    showHistoryQuestion();
                    return; // Exit early, fishing will start after question is answered
                } else {
                    // Skip question and go straight to fishing
                    proceedWithFishing();
                    return;
                }
                
                const rod = getCurrentRod();
                if (!rod) {
                    console.error('No rod found!', gameState.ownedRods);
                    addLog('‚ùå Error: No fishing rod available!');
                    return;
                }
                
                const islandIndex = gameState.currentIsland;
                
                // Get random fish from current island with weighted selection
                const availableFish = fishByIsland[islandIndex] || fishByIsland[0];
                if (!availableFish || availableFish.length === 0) {
                    addLog('‚ùå No fish available at this island!');
                    return;
                }
                
                // Weighted random selection - individual fish weights for better variance
                // Lower value fish (like minnows) get lower weights
                const fishWeights = availableFish.map(fish => {
                    // Base weight on value - higher value = higher weight
                    // Minnows and very cheap fish get 0.5x weight
                    let weight = 1.0;
                    if (fish.baseValue <= 8) {
                        weight = 0.5; // Make minnows and very cheap fish less common
                    } else if (fish.baseValue <= 15) {
                        weight = 1.0; // Normal common fish
                    } else if (fish.rarity === 'uncommon') {
                        weight = 1.5; // Uncommon fish slightly more common
                    } else if (fish.rarity === 'rare') {
                        weight = 2.0; // Rare fish more common
                    } else if (fish.rarity === 'epic') {
                        weight = 2.5; // Epic fish more common
                    } else if (fish.rarity === 'legendary') {
                        weight = 3.0; // Legendary fish more common
                    }
                    return { fish, weight };
                });
                
                // Calculate total weight
                const totalWeight = fishWeights.reduce((sum, fw) => sum + fw.weight, 0);
                
                // Select fish based on weighted random
                let rand = Math.random() * totalWeight;
                let selectedFish = availableFish[0]; // Fallback
                
                for (const { fish, weight } of fishWeights) {
                    rand -= weight;
                    if (rand <= 0) {
                        selectedFish = fish;
                        break;
                    }
                }
                
                const fishType = selectedFish;
                
                // Safety check - ensure fishType is valid
                if (!fishType || !fishType.name || !fishType.baseSize) {
                    console.error('Invalid fish type:', fishType);
                    addLog('‚ùå Error: Invalid fish type!');
                    return;
                }
                
                // If auto-fishing mode is active, instantly catch the fish
                if (autoFishingMode) {
                    // Set currentFish and immediately complete catch
                    currentFish = fishType;
                    if (currentFish && currentFish.baseSize) {
                        completeCatch();
                    } else {
                        console.error('Failed to set currentFish properly');
                    }
                    return;
                }
                
                // Calculate catch time based on fish rarity and rod quality
                // Better rods reduce catch time
                const rodSpeedBonus = 1 / rod.qualityBonus; // Better rods = faster catching
                catchTimeRequired = fishType.catchTime * rodSpeedBonus;
                
                // Start the mini-game
                currentFish = fishType;
                fishingGameActive = true;
                catchProgress = 0;
                // Initial positions will be set in startFishingGame() after container is rendered
                fishPosition = 0; // Will be set to random position
                playerPosition = 0; // Will be set to middle
                fishDirection = Math.random() > 0.5 ? 1 : -1;
                
                // Show modal
                document.getElementById('fishingFishName').textContent = `A ${fishType.name} appeared!`;
                document.getElementById('fishingGameModal').classList.add('active');
                
                // Start game loop after a small delay to ensure modal is rendered
                setTimeout(() => {
                    startFishingGame();
                }, 50);
            } catch (error) {
                console.error('Error in goFishing:', error);
                addLog('‚ùå Error starting fishing: ' + error.message);
                fishingGameActive = false;
                isCompletingCatch = false;
            }
        }

        // Start fishing mini-game loop
        function startFishingGame() {
            const container = document.querySelector('.fishing-bar-container');
            if (!container) {
                console.error('Fishing container not found!');
                stopFishingGame();
                return;
            }
            
            const containerWidth = container.offsetWidth;
            if (containerWidth === 0) {
                console.error('Container width is 0, retrying...');
                setTimeout(() => startFishingGame(), 100);
                return;
            }
            
            const fishWidth = 40;
            const playerWidth = 80;
            const maxPosition = containerWidth - fishWidth;
            const maxPlayerPosition = containerWidth - playerWidth;
            
            // Reset player position to middle
            playerPosition = (containerWidth - playerWidth) / 2;
            const playerBar = document.getElementById('playerBar');
            if (playerBar) {
                playerBar.style.left = playerPosition + 'px';
            }
            
            // Start fish from random position on the slider bar
            fishPosition = Math.random() * maxPosition;
            const fishIndicator = document.getElementById('fishIndicator');
            if (fishIndicator) {
                fishIndicator.style.left = fishPosition + 'px';
            }
            
            // Add mouse drag and touch support for player bar
            const fishingTrack = document.querySelector('.fishing-bar-track');
            let isDragging = false;
            
            const updatePlayerPosition = (clientX) => {
                if (!fishingGameActive || aiFishingMacroActive) return;
                
                const rect = container.getBoundingClientRect();
                let newPosition = clientX - rect.left - (playerWidth / 2);
                newPosition = Math.max(0, Math.min(maxPlayerPosition, newPosition));
                playerPosition = newPosition;
                if (playerBar) {
                    playerBar.style.left = playerPosition + 'px';
                }
            };
            
            // Mouse events
            fishingTrack.addEventListener('mousedown', (e) => {
                if (!fishingGameActive || aiFishingMacroActive) return;
                isDragging = true;
                updatePlayerPosition(e.clientX);
                e.preventDefault();
            });
            
            document.addEventListener('mousemove', (e) => {
                if (isDragging && fishingGameActive && !aiFishingMacroActive) {
                    updatePlayerPosition(e.clientX);
                }
            });
            
            document.addEventListener('mouseup', () => {
                isDragging = false;
            });
            
            // Touch events for mobile
            fishingTrack.addEventListener('touchstart', (e) => {
                if (!fishingGameActive || aiFishingMacroActive) return;
                isDragging = true;
                const touch = e.touches[0];
                updatePlayerPosition(touch.clientX);
                e.preventDefault();
            });
            
            document.addEventListener('touchmove', (e) => {
                if (isDragging && fishingGameActive && !aiFishingMacroActive) {
                    const touch = e.touches[0];
                    updatePlayerPosition(touch.clientX);
                    e.preventDefault();
                }
            });
            
            document.addEventListener('touchend', () => {
                isDragging = false;
            });
            
            // Fish movement variables for more random behavior
            let fishSpeedVariation = 0;
            let directionChangeCounter = 0;
            const baseFishSpeed = 3 + (currentFish.catchTime / 2); // Faster base speed
            
            fishingGameInterval = setInterval(() => {
                // AI Fishing Macro - automatically move player bar to catch fish
                if (aiFishingMacroActive) {
                    const fishCenter = fishPosition + fishWidth / 2;
                    const playerCenter = playerPosition + playerWidth / 2;
                    const distance = fishCenter - playerCenter;
                    // AI moves fast but not too fast - balanced speed
                    const aiSpeed = 50; // Fast but manageable AI speed
                    
                    if (Math.abs(distance) > 3) { // Only move if not already aligned
                        if (distance > 0) {
                            // Fish is to the right, move player right
                            playerPosition = Math.min(maxPlayerPosition, playerPosition + aiSpeed);
                        } else {
                            // Fish is to the left, move player left
                            playerPosition = Math.max(0, playerPosition - aiSpeed);
                        }
                    }
                } else {
                    // Move player bar based on keys (normal player control)
                    // Player speed scales with rod quality - reduced to about half
                    const rod = getCurrentRod();
                    const basePlayerSpeed = 25; // Reduced from 50 to about half
                    const rodSpeedMultiplier = rod ? (rod.qualityBonus * 2.5) : 1; // Reduced multiplier
                    const playerSpeed = basePlayerSpeed * rodSpeedMultiplier;
                    
                    // Ensure minimum speed even with starter rod
                    const minSpeed = 15;
                    const finalSpeed = Math.max(minSpeed, playerSpeed);
                    
                    if (keysPressed.left) {
                        playerPosition = Math.max(0, playerPosition - finalSpeed);
                    }
                    if (keysPressed.right) {
                        playerPosition = Math.min(maxPlayerPosition, playerPosition + finalSpeed);
                    }
                }
                
                // Move fish with more random, erratic movement
                // Add speed variation for more unpredictability
                fishSpeedVariation += (Math.random() - 0.5) * 0.3;
                fishSpeedVariation = Math.max(-1, Math.min(1, fishSpeedVariation)); // Clamp variation
                
                // Calculate current fish speed with variation
                const currentFishSpeed = baseFishSpeed + fishSpeedVariation;
                fishPosition += fishDirection * currentFishSpeed;
                
                // More frequent direction changes for random back-and-forth movement
                directionChangeCounter++;
                const shouldChangeDirection = 
                    fishPosition <= 0 || 
                    fishPosition >= maxPosition ||
                    (directionChangeCounter > 10 && Math.random() < 0.15); // 15% chance to randomly change direction
                
                if (shouldChangeDirection) {
                    fishDirection *= -1;
                    fishPosition = Math.max(0, Math.min(maxPosition, fishPosition));
                    directionChangeCounter = 0;
                    // Reset speed variation when changing direction
                    fishSpeedVariation = (Math.random() - 0.5) * 0.5;
                }
                
                // Update positions
                document.getElementById('fishIndicator').style.left = fishPosition + 'px';
                document.getElementById('playerBar').style.left = playerPosition + 'px';
                
                // Check if player bar is over fish
                const fishCenter = fishPosition + fishWidth / 2;
                const playerCenter = playerPosition + playerWidth / 2;
                const overlap = Math.abs(fishCenter - playerCenter) < (fishWidth / 2 + playerWidth / 2 - 10);
                
                if (overlap) {
                    // Increase catch progress
                    catchProgress += (100 / (catchTimeRequired * 10)); // 10 updates per second
                    if (catchProgress >= 100) {
                        catchProgress = 100;
                        completeCatch();
                        return;
                    }
                } else {
                    // Decrease catch progress if not aligned
                    catchProgress = Math.max(0, catchProgress - 0.5);
                }
                
                // Update UI
                document.getElementById('catchProgress').style.width = catchProgress + '%';
                document.getElementById('catchProgress').textContent = Math.floor(catchProgress) + '%';
                
            }, 100); // Update every 100ms
        }

        // Celebration animation function
        function triggerCelebration(fish, isMutated) {
            console.log('Triggering celebration for fish:', fish, 'mutated:', isMutated);
            
            try {
                // Create overlay
                const overlay = document.createElement('div');
                overlay.className = 'celebration-overlay';
                document.body.appendChild(overlay);

            // Create confetti - start from top with random colors and positions
            const colors = ['#ff6b6b', '#4ecdc4', '#ffe66d', '#95e1d3', '#f38181', '#aa96da', '#fcbad3', '#ffd93d', '#6bcf7f', '#ff9ff3', '#54a0ff', '#5f27cd', '#00d2d3', '#feca57', '#48dbfb', '#ff6348'];
            for (let i = 0; i < 30; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = (Math.random() * 100) + '%';
                confetti.style.top = '-10px';
                confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.animationDuration = (2 + Math.random() * 2) + 's';
                confetti.style.animationDelay = (Math.random() * 0.5) + 's';
                overlay.appendChild(confetti);
            }

            // Create celebration text
            const celebrationText = document.createElement('div');
            const hasSpecialMutation = fish.specialMutation;
            celebrationText.className = 'celebration-text' + (isMutated || hasSpecialMutation ? ' mutated' : '');
            
            // Choose message based on fish value and mutation
            let message = 'üé£ Great Catch!';
            if (hasSpecialMutation) {
                message = `‚ú® ${fish.specialMutation.toUpperCase()} MUTATION! ‚ú®`;
                // Apply special mutation color
                const mutation = specialMutations.find(m => m.name === fish.specialMutation);
                if (mutation) {
                    celebrationText.style.color = mutation.color;
                    celebrationText.style.textShadow = mutation.glow;
                }
            } else if (isMutated) {
                message = '‚ú® MUTATED FISH! ‚ú®';
            } else if (fish.value > 1000000000) {
                message = 'üåå LEGENDARY CATCH! üåå';
            } else if (fish.value > 100000000) {
                message = 'üåü AMAZING CATCH! üåü';
            } else if (fish.value > 10000000) {
                message = 'üíé EXCELLENT! üíé';
            } else if (fish.value > 1000000) {
                message = '‚≠ê NICE CATCH! ‚≠ê';
            }
            
            celebrationText.textContent = message;
            document.body.appendChild(celebrationText);

            // Create sparkles around the text
            for (let i = 0; i < 20; i++) {
                setTimeout(() => {
                    const sparkle = document.createElement('div');
                    sparkle.className = 'sparkle';
                    const angle = (i / 20) * Math.PI * 2;
                    const radius = 150;
                    sparkle.style.left = `calc(50% + ${Math.cos(angle) * radius}px)`;
                    sparkle.style.top = `calc(50% + ${Math.sin(angle) * radius}px)`;
                    sparkle.style.animationDelay = (i * 0.05) + 's';
                    overlay.appendChild(sparkle);
                }, i * 50);
            }

            // Create gold coins for value
            const coinCount = Math.min(Math.floor(fish.value / 100), 10);
            for (let i = 0; i < coinCount; i++) {
                setTimeout(() => {
                    const coin = document.createElement('div');
                    coin.className = 'gold-coin';
                    coin.textContent = 'üí∞';
                    coin.style.left = `calc(50% + ${(Math.random() - 0.5) * 200}px)`;
                    coin.style.top = '50%';
                    coin.style.animationDelay = (i * 0.1) + 's';
                    overlay.appendChild(coin);
                }, i * 100);
            }

            // Remove elements after animation
            setTimeout(() => {
                celebrationText.classList.add('fade-out');
            }, 1500);

            setTimeout(() => {
                overlay.remove();
                celebrationText.remove();
            }, 3000);
            } catch (error) {
                console.error('Error in celebration animation:', error);
            }
        }

        // Complete catch
        function completeCatch() {
            // Prevent multiple simultaneous catches
            if (isCompletingCatch) {
                return;
            }
            isCompletingCatch = true;
            
            // Safety check - if no fish, return early (check BEFORE stopFishingGame clears it)
            if (!currentFish) {
                console.error('completeCatch called but currentFish is null');
                isCompletingCatch = false;
                return;
            }
            
            // Save fish data BEFORE stopFishingGame clears currentFish
            const rod = getCurrentRod();
            const fishType = currentFish;
            
            // Now stop the game (this will clear currentFish)
            stopFishingGame();
            
            // Calculate size with rod bonus
            const baseSize = fishType.baseSize;
            const sizeMultiplier = 1 + (Math.random() * 0.5) + (rod.qualityBonus - 1) * 0.3;
            const size = baseSize * sizeMultiplier;
            
            // Mutation chance (5% base, improved by rod)
            const mutationChance = 0.05 * rod.qualityBonus;
            const isMutated = Math.random() < mutationChance;
            
            // Special mutation chance (rarer, only if already mutated)
            let specialMutation = null;
            if (isMutated) {
                const specialMutationChance = 0.15 * rod.qualityBonus; // 15% base chance when mutated
                if (Math.random() < specialMutationChance) {
                    specialMutation = specialMutations[Math.floor(Math.random() * specialMutations.length)];
                }
            }
            
            // Calculate value with mutations
            let valueMultiplier = 1;
            if (specialMutation) {
                valueMultiplier = specialMutation.multiplier;
            } else if (isMutated) {
                valueMultiplier = 3; // Regular mutation
            }
            
            const fish = {
                type: fishType.name,
                size: size.toFixed(2),
                value: Math.floor(fishType.baseValue * size * valueMultiplier),
                mutated: isMutated,
                specialMutation: specialMutation ? specialMutation.name : null,
                rarity: fishType.rarity
            };
            
            gameState.inventory.push(fish);
            gameState.totalFishCaught++;
            
            // Submit to leaderboard when fish is caught
            submitToLeaderboard();
            
            const expMultiplier = specialMutation ? specialMutation.multiplier : (isMutated ? 2 : 1);
            const expGain = Math.floor(fish.value / 10) * expMultiplier * 4;
            addExperience(expGain);
            
            let mutationText = "";
            if (specialMutation) {
                mutationText = ` ‚ú® ${specialMutation.name.toUpperCase()} MUTATION ‚ú®`;
            } else if (isMutated) {
                mutationText = " ‚ú® MUTATED ‚ú®";
            }
            addLog(`üé£ Caught: ${fish.type} (${fish.size}kg)${mutationText} - Worth ${fish.value.toLocaleString()} gold!`);
            
            // Trigger celebration animation after a small delay to ensure modal is closed
            setTimeout(() => {
                triggerCelebration(fish, isMutated || !!fish.specialMutation);
            }, 100);
            
            updateUI();
            saveGame();
            
            // Clear the flag and reset currentFish
            const wasAutoClickerActive = autoClickerActive;
            isCompletingCatch = false;
            currentFish = null;
            
            // If auto-clicker is active, start next fish immediately
            if (wasAutoClickerActive) {
                setTimeout(() => {
                    if (!fishingGameActive && !isCompletingCatch) {
                        goFishing();
                    }
                }, 100);
            }
        }

        // Stop fishing game
        function stopFishingGame() {
            if (fishingGameInterval) {
                clearInterval(fishingGameInterval);
                fishingGameInterval = null;
            }
            fishingGameActive = false;
            // Only clear isCompletingCatch if we're not in the middle of completing a catch
            // (completeCatch() manages this flag itself)
            if (!isCompletingCatch) {
                isCompletingCatch = false;
            }
            document.getElementById('fishingGameModal').classList.remove('active');
            catchProgress = 0;
            currentFish = null;
        }

        // Sell all fish
        function sellAllFish() {
            if (gameState.inventory.length === 0) {
                alert("You have no fish to sell!");
                return;
            }
            
            const baseValue = gameState.inventory.reduce((sum, fish) => sum + fish.value, 0);
            // Apply rebirth bonus to gold gain
            const totalValue = Math.floor(baseValue * gameState.rebirthBonus);
            gameState.gold += totalValue;
            gameState.inventory = [];
            
            const bonusText = gameState.rebirthBonus > 1 ? ` (${gameState.rebirthBonus.toFixed(1)}x rebirth bonus!)` : '';
            addLog(`üí∞ Sold all fish for ${totalValue.toLocaleString()} gold${bonusText}!`);
            updateUI();
            saveGame();
        }

        // Appraise fish (enhancement)
        function appraiseFish() {
            if (gameState.inventory.length === 0) {
                alert("You have no fish to appraise!");
                return;
            }
            
            const cost = 100 * gameState.level;
            if (gameState.gold < cost) {
                alert(`You need ${cost} gold to appraise fish!`);
                return;
            }
            
            gameState.gold -= cost;
            
            // Randomly select a fish
            const fishIndex = Math.floor(Math.random() * gameState.inventory.length);
            const fish = gameState.inventory[fishIndex];
            
            // 30% chance to increase size, 10% chance for mutation
            const sizeIncrease = Math.random() < 0.3;
            const mutation = !fish.mutated && Math.random() < 0.1;
            
            if (sizeIncrease) {
                const increase = 1 + (Math.random() * 0.5);
                fish.size = (parseFloat(fish.size) * increase).toFixed(2);
                fish.value = Math.floor(fish.value * increase);
                addLog(`‚ú® ${fish.type} grew to ${fish.size}kg!`);
            }
            
            if (mutation) {
                fish.mutated = true;
                fish.value = Math.floor(fish.value * 3);
                addLog(`üåü ${fish.type} MUTATED! Value tripled!`);
            }
            
            if (!sizeIncrease && !mutation) {
                addLog(`üîç Appraised ${fish.type} - No changes this time.`);
            }
            
            updateUI();
            saveGame();
        }

        // Buy boat
        function buyBoat(index) {
            const boat = boats[index];
            if (gameState.ownedBoats.includes(index)) {
                alert("You already own this boat!");
                return;
            }
            if (gameState.gold < boat.cost) {
                alert(`You need ${boat.cost} gold to buy this boat!`);
                return;
            }
            
            gameState.gold -= boat.cost;
            gameState.ownedBoats.push(index);
            addLog(`‚öì Purchased ${boat.name}!`);
            
            // Check for island unlocks based on boat
            islands.forEach((island, islandIndex) => {
                if (!gameState.unlockedIslands.includes(islandIndex) && 
                    index >= island.boatReq && 
                    gameState.gold >= island.unlockCost) {
                    gameState.unlockedIslands.push(islandIndex);
                    addLog(`üèùÔ∏è ${island.name} is now available with your new boat!`);
                }
            });
            
            updateUI();
            renderShipwright();
            saveGame();
        }

        // Buy rod
        function buyRod(index) {
            const rod = rods[index];
            if (gameState.ownedRods.includes(index)) {
                alert("You already own this rod!");
                return;
            }
            if (gameState.gold < rod.cost) {
                alert(`You need ${rod.cost} gold to buy this rod!`);
                return;
            }
            
            gameState.gold -= rod.cost;
            gameState.ownedRods.push(index);
            addLog(`üé£ Purchased ${rod.name}!`);
            updateUI();
            renderRods();
            saveGame();
        }

        // Change island
        function changeIsland(index) {
            if (!gameState.unlockedIslands.includes(index)) {
                const island = islands[index];
                const bestBoatIndex = Math.max(...gameState.ownedBoats);
                
                if (bestBoatIndex < island.boatReq) {
                    alert(`You need a better boat to reach ${island.name}! You need at least ${boats[island.boatReq].name}.`);
                    return;
                }
                if (gameState.gold < island.unlockCost) {
                    alert(`You need ${island.unlockCost} gold to unlock this island!`);
                    return;
                }
                gameState.gold -= island.unlockCost;
                gameState.unlockedIslands.push(index);
                addLog(`üèùÔ∏è Unlocked ${island.name}!`);
            }
            
            gameState.currentIsland = index;
            const currentIsland = islands[index];
            
            // Change background - remove all island background classes first
            document.body.className = document.body.className.replace(/island-bg-\w+/g, '').trim();
            // Add new background class
            if (currentIsland.backgroundClass) {
                document.body.classList.add(currentIsland.backgroundClass);
            }
            
            addLog(`üèùÔ∏è Traveled to ${currentIsland.name}!`);
            updateUI();
            saveGame();
        }

        // UI Updates
        function updateUI() {
            document.getElementById('level').textContent = gameState.level;
            document.getElementById('gold').textContent = gameState.gold.toLocaleString();
            const currentIsland = islands[gameState.currentIsland];
            const islandEmoji = currentIsland.emoji || 'üèùÔ∏è';
            const currentIslandEl = document.getElementById('currentIsland');
            // Use innerHTML to support emoji properly
            currentIslandEl.innerHTML = `${islandEmoji} ${currentIsland.name}`;
            document.getElementById('rodsOwned').textContent = `${gameState.ownedRods.length}/50`;
            
            // Update rebirth count display
            const rebirthCountEl = document.getElementById('rebirthCount');
            if (rebirthCountEl) {
                rebirthCountEl.textContent = `Rebirths: ${gameState.rebirthCount}`;
            }
            
            // Level progress
            const expForNext = getExpForLevel(gameState.level);
            const progress = (gameState.experience / expForNext) * 100;
            document.getElementById('levelProgress').style.width = `${progress}%`;
            document.getElementById('levelProgress').textContent = `Level ${gameState.level} / 2000`;
            
            // Check win condition
            if (gameState.level >= 2000 && gameState.ownedRods.length >= 50) {
                document.getElementById('winScreen').style.display = 'block';
            }
            
            renderInventory();
            renderIslands();
        }

        function renderInventory() {
            const inventoryDiv = document.getElementById('inventory');
            if (gameState.inventory.length === 0) {
                inventoryDiv.innerHTML = '<div style="text-align: center; color: #999;">No fish caught yet</div>';
                return;
            }
            
            inventoryDiv.innerHTML = gameState.inventory.map((fish, index) => {
                let classes = '';
                let mutationText = '';
                
                if (fish.specialMutation) {
                    classes = `special-mutation ${fish.specialMutation.toLowerCase().replace(' ', '-')}`;
                    mutationText = `‚ú® ${fish.specialMutation.toUpperCase()} MUTATION ‚ú®`;
                } else if (fish.mutated) {
                    classes = 'mutated';
                    mutationText = '‚ú® MUTATED ‚ú®';
                }
                
                return `
                    <div class="fish-item ${classes}">
                        <div>
                            <strong>${fish.type}</strong> - ${fish.size}kg
                            ${mutationText}
                        </div>
                        <div>${fish.value.toLocaleString()} gold</div>
                    </div>
                `;
            }).join('');
        }

        function renderIslands() {
            const islandsDiv = document.getElementById('islands');
            const bestBoatIndex = Math.max(...gameState.ownedBoats);
            islandsDiv.innerHTML = islands.map((island, index) => {
                const isUnlocked = gameState.unlockedIslands.includes(index);
                const isActive = gameState.currentIsland === index;
                const canUnlock = !isUnlocked && bestBoatIndex >= island.boatReq && gameState.gold >= island.unlockCost;
                
                let classes = 'island-card';
                if (!isUnlocked && !canUnlock) classes += ' locked';
                if (isActive) classes += ' active';
                
                // Get emoji with special styling for certain islands
                let islandEmoji = island.emoji || 'üèùÔ∏è';
                let iconClass = '';
                
                // Add special icon classes for visual distinction
                if (island.name === "Coral Reef") iconClass = 'island-icon-coral';
                else if (island.name === "Dragon's Cove") iconClass = 'island-icon-dragon';
                else if (island.name === "Phantom Sea") iconClass = 'island-icon-phantom';
                else if (island.name === "Thunder Reef") iconClass = 'island-icon-thunder';
                else if (island.name === "Mystic Depths") iconClass = 'island-icon-mysticdepths';
                else if (island.name === "Celestial Waters") iconClass = 'island-icon-celestial';
                else if (island.name === "Void Trench") iconClass = 'island-icon-void';
                else if (island.name === "Infinity Sea") iconClass = 'island-icon-infinity';
                
                const iconDisplay = iconClass ? `<span class="island-icon ${iconClass}"></span>` : `${islandEmoji} `;
                
                return `
                    <div class="${classes}" onclick="changeIsland(${index})">
                        <h3>${iconDisplay}${island.name}</h3>
                        ${!isUnlocked ? `<p>Unlock: ${island.unlockCost} gold<br>Boat: ${boats[island.boatReq].name}</p>` : ''}
                        ${isActive ? '<p>üìç Current</p>' : ''}
                    </div>
                `;
            }).join('');
        }

        function renderShipwright() {
            const shopDiv = document.getElementById('shipwrightShop');
            shopDiv.innerHTML = boats.map((boat, index) => {
                const isOwned = gameState.ownedBoats.includes(index);
                const canAfford = gameState.gold >= boat.cost;
                const classes = isOwned ? 'shop-item owned' : 'shop-item';
                
                return `
                    <div class="${classes}">
                        <div>
                            <strong>${boat.name}</strong><br>
                            <small>Catch: ${boat.catchMultiplier}x | Speed: ${boat.speed}x</small>
                        </div>
                        <div>
                            ${isOwned ? '<span>‚úì Owned</span>' : `<button onclick="buyBoat(${index})" ${!canAfford ? 'disabled' : ''}>${boat.cost.toLocaleString()} gold</button>`}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderMerchant() {
            const merchantDiv = document.getElementById('merchantContent');
            const totalValue = gameState.inventory.reduce((sum, fish) => sum + fish.value, 0);
            
            merchantDiv.innerHTML = `
                <p>You have <strong>${gameState.inventory.length}</strong> fish in your inventory.</p>
                <p>Total value: <strong>${totalValue.toLocaleString()}</strong> gold</p>
                <button onclick="sellAllFish(); closeModal('merchantModal');" style="width: 100%; margin-top: 20px; padding: 15px; font-size: 1.2em;">
                    üí∞ Sell All Fish
                </button>
            `;
        }

        function renderAppraiser() {
            const appraiserDiv = document.getElementById('appraiserContent');
            const cost = 100 * gameState.level;
            const canAfford = gameState.gold >= cost;
            
            appraiserDiv.innerHTML = `
                <p>You have <strong>${gameState.inventory.length}</strong> fish to appraise.</p>
                <p>Cost per appraisal: <strong>${cost.toLocaleString()}</strong> gold</p>
                <p><small>30% chance to increase size, 10% chance for mutation</small></p>
                <button onclick="appraiseFish();" style="width: 100%; margin-top: 20px; padding: 15px; font-size: 1.2em;" ${!canAfford ? 'disabled' : ''}>
                    üîÆ Appraise Fish (${cost.toLocaleString()} gold)
                </button>
            `;
        }

        function renderRods() {
            const rodsDiv = document.getElementById('rodsShop');
            rodsDiv.innerHTML = rods.map((rod, index) => {
                const isOwned = gameState.ownedRods.includes(index);
                const canAfford = gameState.gold >= rod.cost;
                const classes = isOwned ? 'shop-item owned' : 'shop-item';
                
                return `
                    <div class="${classes}">
                        <div>
                            <strong>${rod.name}</strong> [${rod.tier}]<br>
                            <small>Catch Bonus: ${rod.catchBonus.toFixed(2)}x | Quality: ${rod.qualityBonus.toFixed(2)}x</small>
                        </div>
                        <div>
                            ${isOwned ? '<span>‚úì Owned</span>' : `<button onclick="buyRod(${index})" ${!canAfford ? 'disabled' : ''}>${rod.cost.toLocaleString()} gold</button>`}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function addLog(message) {
            const logDiv = document.getElementById('fishingLog');
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.textContent = message;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
            if (modalId === 'shipwrightModal') renderShipwright();
            if (modalId === 'merchantModal') renderMerchant();
            if (modalId === 'appraiserModal') renderAppraiser();
            if (modalId === 'rodsModal') renderRods();
            if (modalId === 'mapModal') {
                setTimeout(() => renderMap(), 100); // Small delay to ensure container is rendered
                // Show mobile controls when map opens
                const mobileControls = document.getElementById('mapMobileControls');
                if (mobileControls) {
                    mobileControls.style.display = 'block';
                }
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
            if (modalId === 'mapModal') {
                stopMapMovement();
                // Reset keys
                mapKeysPressed = { w: false, a: false, s: false, d: false };
                // Hide mobile controls when map closes
                const mobileControls = document.getElementById('mapMobileControls');
                if (mobileControls) {
                    mobileControls.style.display = 'none';
                }
            }
        }

        // Auto-clicker functions
        function toggleAutoClicker() {
            autoClickerActive = !autoClickerActive;
            const btn = document.getElementById('autoclickerBtn');
            
            if (autoClickerActive) {
                // Start auto-clicker at super speed (10ms interval = 100 clicks per second)
                autoClickerInterval = setInterval(() => {
                    if (!fishingGameActive) {
                        goFishing();
                    }
                }, 10);
                btn.textContent = '‚ö° Auto-Clicker: ON';
                btn.classList.add('active');
                addLog('‚ö° Auto-clicker activated!');
            } else {
                // Stop auto-clicker
                if (autoClickerInterval) {
                    clearInterval(autoClickerInterval);
                    autoClickerInterval = null;
                }
                btn.textContent = '‚ö° Auto-Clicker: OFF';
                btn.classList.remove('active');
                addLog('‚ö° Auto-clicker deactivated.');
            }
            saveGame();
        }

        // Secret gold function
        function secretGold() {
            gameState.gold += 5000;
            addLog('üí∞ Secret discovered! You received 5000 gold!');
            updateUI();
            saveGame();
        }

        // Add levels function
        function addLevels() {
            const levelsToAdd = 100;
            const oldLevel = gameState.level;
            gameState.level = Math.min(2000, gameState.level + levelsToAdd);
            const levelsAdded = gameState.level - oldLevel;
            
            addLog(`‚¨ÜÔ∏è Secret discovered! You gained ${levelsAdded} levels!`);
            addLog(`üìà You are now level ${gameState.level}!`);
            updateUI();
            saveGame();
        }

        // Rebirth function - Reset progress for permanent bonuses
        function rebirth() {
            // Check if player has enough progress to rebirth
            if (gameState.level < 50) {
                alert('You need to be at least level 50 to rebirth!');
                return;
            }
            
            if (!confirm(`üîÑ REBIRTH?\n\nThis will reset:\n- Level: ${gameState.level} ‚Üí 1\n- Gold: ${gameState.gold.toLocaleString()} ‚Üí 100\n- Experience: ${gameState.experience} ‚Üí 0\n- Inventory: ${gameState.inventory.length} fish ‚Üí 0\n- Islands: Reset to Starter Island\n- Boats: Reset to Raft\n- Rods: Reset to Starter Rod\n\nYou will gain:\n- +${gameState.rebirthCount + 1} permanent rebirth bonus (${((gameState.rebirthCount + 1) * 0.5 + 1).toFixed(1)}x multiplier)\n- Rebirth Count: ${gameState.rebirthCount} ‚Üí ${gameState.rebirthCount + 1}\n\nContinue?`)) {
                return;
            }
            
            // Calculate rebirth bonus (1.5x per rebirth, stacking)
            gameState.rebirthCount++;
            gameState.rebirthBonus = 1 + (gameState.rebirthCount * 0.5); // 1.5x, 2x, 2.5x, etc.
            
            // Reset game state
            const oldLevel = gameState.level;
            gameState.level = 1;
            gameState.gold = 100;
            gameState.experience = 0;
            gameState.currentIsland = 0;
            gameState.inventory = [];
            gameState.ownedBoats = [0];
            gameState.ownedRods = [0];
            gameState.unlockedIslands = [0];
            
            // Reset background
            document.body.className = document.body.className.replace(/island-bg-\w+/g, '').trim();
            if (islands[0].backgroundClass) {
                document.body.classList.add(islands[0].backgroundClass);
            }
            
            addLog(`üîÑ REBIRTH COMPLETE!`);
            addLog(`‚ú® You are now on Rebirth ${gameState.rebirthCount}!`);
            addLog(`üìà Permanent Bonus: ${gameState.rebirthBonus.toFixed(1)}x multiplier to gold and experience!`);
            addLog(`üé£ Starting fresh with enhanced power!`);
            
            updateUI();
            saveGame();
        }

        // Poop button - Gives you all the best rods!
        function poopButtonClick() {
            // Unlock all 50 rods
            for (let i = 0; i < rods.length; i++) {
                if (!gameState.ownedRods.includes(i)) {
                    gameState.ownedRods.push(i);
                }
            }
            
            // Sort owned rods array
            gameState.ownedRods.sort((a, b) => a - b);
            
            addLog('üí© Secret discovered! You received ALL RODS!');
            addLog('üé£ You now own all 50 rods including the legendary ones!');
            updateUI();
            saveGame();
        }

        // Unlock all boats function
        function unlockAllBoats() {
            // Unlock all boats
            for (let i = 0; i < boats.length; i++) {
                if (!gameState.ownedBoats.includes(i)) {
                    gameState.ownedBoats.push(i);
                }
            }
            
            // Sort owned boats array
            gameState.ownedBoats.sort((a, b) => a - b);
            
            // Check for island unlocks based on boats
            islands.forEach((island, islandIndex) => {
                if (!gameState.unlockedIslands.includes(islandIndex)) {
                    const bestBoatIndex = Math.max(...gameState.ownedBoats);
                    if (bestBoatIndex >= island.boatReq && gameState.gold >= island.unlockCost) {
                        gameState.unlockedIslands.push(islandIndex);
                        addLog(`üèùÔ∏è ${island.name} is now available!`);
                    }
                }
            });
            
            addLog('‚öì Secret discovered! You received ALL BOATS!');
            addLog('üö¢ You now own all boats including the Titan!');
            updateUI();
            renderShipwright();
            saveGame();
        }

        // Toggle secret panel
        function toggleSecretPanel() {
            const panel = document.getElementById('secretPanel');
            panel.classList.toggle('active');
        }

        // Toggle invisible admin panel
        function toggleInvisibleAdminPanel() {
            const panel = document.getElementById('invisibleAdminPanel');
            if (panel) {
                const isActive = panel.classList.contains('active');
                if (isActive) {
                    panel.classList.remove('active');
                    panel.style.display = 'none';
                } else {
                    panel.classList.add('active');
                    panel.style.display = 'flex';
                }
            }
        }

        // AI Fishing Macro - Automatically plays the fishing mini-game
        function toggleAutoFishingMacro() {
            aiFishingMacroActive = !aiFishingMacroActive;
            const btn = document.getElementById('autoFishingMacroBtn');
            
            if (aiFishingMacroActive) {
                btn.textContent = 'ü§ñ AI Fishing Macro: ON';
                btn.classList.add('active');
                addLog('ü§ñ AI Fishing Macro activated! Will automatically catch fish!');
                
                // Start AI fishing loop
                aiFishingInterval = setInterval(() => {
                    if (!fishingGameActive && !isCompletingCatch) {
                        goFishing();
                    }
                }, 500); // Check every 500ms
            } else {
                btn.textContent = 'ü§ñ AI Fishing Macro: OFF';
                btn.classList.remove('active');
                addLog('ü§ñ AI Fishing Macro deactivated.');
                
                if (aiFishingInterval) {
                    clearInterval(aiFishingInterval);
                    aiFishingInterval = null;
                }
            }
            saveGame();
        }

        // Rusty Pipe - Toggle auto-fishing mode (instantly catch fish without mini-game)
        function toggleAutoFishing() {
            autoFishingMode = !autoFishingMode;
            const btn = document.getElementById('rustyPipeBtn');
            
            if (autoFishingMode) {
                btn.textContent = 'üîß Rusty Pipe (Instant Catch): ON';
                btn.classList.add('active');
                addLog('üîß Rusty Pipe activated! Fish will be caught instantly!');
            } else {
                btn.textContent = 'üîß Rusty Pipe (Instant Catch): OFF';
                btn.classList.remove('active');
                addLog('üîß Rusty Pipe deactivated. Back to normal fishing.');
            }
            updateUI();
        }

        // Secret Fish Button - Spawn a legendary secret fish
        function spawnSecretFish() {
            const randomSecretFish = secretFish[Math.floor(Math.random() * secretFish.length)];
            const rod = getCurrentRod();
            
            // Calculate size with rod bonus
            const baseSize = randomSecretFish.baseSize;
            const sizeMultiplier = 1 + (Math.random() * 0.3) + (rod.qualityBonus - 1) * 0.2;
            const size = baseSize * sizeMultiplier;
            
            // Secret fish are always mutated!
            const fish = {
                type: randomSecretFish.name,
                size: size.toFixed(2),
                value: Math.floor(randomSecretFish.baseValue * size * 3), // Always mutated = 3x value
                mutated: true,
                rarity: randomSecretFish.rarity
            };
            
            gameState.inventory.push(fish);
            gameState.totalFishCaught++;
            
            const expGain = Math.floor(fish.value / 10) * 2 * 4; // Mutated = 2x exp, then 4x multiplier
            addExperience(expGain);
            
            addLog(`üêâ LEGENDARY CATCH: ${fish.type} (${fish.size}kg) ‚ú® MUTATED ‚ú® - Worth ${fish.value.toLocaleString()} gold!`);
            addLog(`üìñ ${randomSecretFish.description}`);
            
            updateUI();
            saveGame();
        }

        // Secret auto-clicker toggle
        function toggleSecretAutoClicker() {
            secretAutoClickerActive = !secretAutoClickerActive;
            const btn = document.getElementById('secretAutoclickerBtn');
            
            if (secretAutoClickerActive) {
                // Start secret auto-clicker at super speed (10ms interval)
                secretAutoClickerInterval = setInterval(() => {
                    secretGold();
                }, 10);
                btn.textContent = 'üí∞ Secret Auto-Clicker: ON';
                btn.classList.add('active');
                addLog('üí∞ Secret auto-clicker activated!');
            } else {
                // Stop secret auto-clicker
                if (secretAutoClickerInterval) {
                    clearInterval(secretAutoClickerInterval);
                    secretAutoClickerInterval = null;
                }
                btn.textContent = 'üí∞ Secret Auto-Clicker: OFF';
                btn.classList.remove('active');
                addLog('üí∞ Secret auto-clicker deactivated.');
            }
            saveGame();
        }

        // Secret Fish Auto-Clicker toggle
        function toggleSecretFishAutoClicker() {
            secretFishAutoClickerActive = !secretFishAutoClickerActive;
            const btn = document.getElementById('secretFishAutoclickerBtn');
            
            if (secretFishAutoClickerActive) {
                // Start secret fish auto-clicker (100ms interval)
                secretFishAutoClickerInterval = setInterval(() => {
                    spawnSecretFish();
                }, 100);
                btn.textContent = 'üêâ Secret Fish Auto-Clicker: ON';
                btn.classList.add('active');
                addLog('üêâ Secret fish auto-clicker activated!');
            } else {
                // Stop secret fish auto-clicker
                if (secretFishAutoClickerInterval) {
                    clearInterval(secretFishAutoClickerInterval);
                    secretFishAutoClickerInterval = null;
                }
                btn.textContent = 'üêâ Secret Fish Auto-Clicker: OFF';
                btn.classList.remove('active');
                addLog('üêâ Secret fish auto-clicker deactivated.');
            }
            saveGame();
        }

        // Island positions in world coordinates (on the 2000x2000 map)
        const islandWorldPositions = [
            { x: 200, y: 1000 },    // 0: Starter Island
            { x: 400, y: 600 },     // 1: Coral Reef
            { x: 600, y: 400 },     // 2: Deep Blue
            { x: 800, y: 500 },     // 3: Mystic Waters
            { x: 1000, y: 600 },    // 4: Abyssal Depths
            { x: 1200, y: 800 },    // 5: Golden Lagoon
            { x: 1400, y: 1200 },   // 6: Crystal Bay
            { x: 1600, y: 1500 },   // 7: Dragon's Cove
            { x: 1300, y: 1700 },   // 8: Phantom Sea
            { x: 900, y: 1800 },    // 9: Legendary Archipelago
            { x: 600, y: 1700 },    // 10: Thunder Reef
            { x: 300, y: 1500 },    // 11: Mystic Depths
            { x: 100, y: 1200 },    // 12: Celestial Waters
            { x: 200, y: 800 },     // 13: Void Trench
            { x: 400, y: 500 },     // 14: Eternal Ocean
            { x: 700, y: 300 },     // 15: Infinity Sea
            { x: 1000, y: 200 }     // 16: (if more islands added)
        ];

        // Start player at current island position
        function initializeMapPlayer() {
            const currentIslandPos = islandWorldPositions[gameState.currentIsland] || { x: 1000, y: 1000 };
            mapPlayerX = currentIslandPos.x;
            mapPlayerY = currentIslandPos.y;
        }

        // Update camera to follow player
        function updateMapCamera() {
            const mapContainer = document.getElementById('mapContainer');
            const mapWorld = document.getElementById('mapWorld');
            if (!mapContainer || !mapWorld) return;
            
            const containerWidth = mapContainer.offsetWidth;
            const containerHeight = mapContainer.offsetHeight;
            
            // Center camera on player
            mapCameraX = mapPlayerX - containerWidth / 2;
            mapCameraY = mapPlayerY - containerHeight / 2;
            
            // Clamp camera to world bounds
            mapCameraX = Math.max(0, Math.min(2000 - containerWidth, mapCameraX));
            mapCameraY = Math.max(0, Math.min(2000 - containerHeight, mapCameraY));
            
            mapWorld.style.transform = `translate(${-mapCameraX}px, ${-mapCameraY}px)`;
        }

        // Update player position on map
        function updateMapPlayer() {
            const player = document.getElementById('mapPlayer');
            if (player) {
                player.style.left = mapPlayerX + 'px';
                player.style.top = mapPlayerY + 'px';
            }
            updateMapCamera();
            checkIslandProximity();
        }

        // Check if player is near an island
        function checkIslandProximity() {
            const proximityDistance = 100; // pixels
            
            islands.forEach((island, index) => {
                const pos = islandWorldPositions[index];
                if (!pos) return;
                
                const distance = Math.sqrt(
                    Math.pow(mapPlayerX - pos.x, 2) + 
                    Math.pow(mapPlayerY - pos.y, 2)
                );
                
                if (distance < proximityDistance) {
                    const isUnlocked = gameState.unlockedIslands.includes(index);
                    const bestBoatIndex = Math.max(...gameState.ownedBoats);
                    const canUnlock = !isUnlocked && bestBoatIndex >= island.boatReq && gameState.gold >= island.unlockCost;
                    
                    if (isUnlocked || canUnlock) {
                        if (gameState.currentIsland !== index) {
                            changeIsland(index);
                            addLog(`üó∫Ô∏è Arrived at ${island.name}!`);
                        }
                    }
                }
            });
        }

        // Start map movement system
        function startMapMovement() {
            if (mapMovementInterval) return;
            
            mapMovementInterval = setInterval(() => {
                const speed = 3;
                
                if (mapKeysPressed.w) mapPlayerY = Math.max(15, mapPlayerY - speed);
                if (mapKeysPressed.s) mapPlayerY = Math.min(1985, mapPlayerY + speed);
                if (mapKeysPressed.a) mapPlayerX = Math.max(15, mapPlayerX - speed);
                if (mapKeysPressed.d) mapPlayerX = Math.min(1985, mapPlayerX + speed);
                
                updateMapPlayer();
            }, 16); // ~60 FPS
        }

        // Stop map movement system
        function stopMapMovement() {
            if (mapMovementInterval) {
                clearInterval(mapMovementInterval);
                mapMovementInterval = null;
            }
            mapKeysPressed = { w: false, a: false, s: false, d: false };
        }

        // Mobile touch controls for map
        function handleMapTouchStart(direction) {
            if (direction === 'w') mapKeysPressed.w = true;
            if (direction === 'a') mapKeysPressed.a = true;
            if (direction === 's') mapKeysPressed.s = true;
            if (direction === 'd') mapKeysPressed.d = true;
            startMapMovement();
        }

        function handleMapTouchEnd(direction) {
            if (direction === 'w') mapKeysPressed.w = false;
            if (direction === 'a') mapKeysPressed.a = false;
            if (direction === 's') mapKeysPressed.s = false;
            if (direction === 'd') mapKeysPressed.d = false;
            
            // Stop movement if no keys are pressed
            if (!mapKeysPressed.w && !mapKeysPressed.a && !mapKeysPressed.s && !mapKeysPressed.d) {
                stopMapMovement();
            }
        }

        // Render map with islands - Walking navigation
        function renderMap() {
            const mapWorld = document.getElementById('mapWorld');
            if (!mapWorld) return;
            
            // Clear islands but keep player
            const existingIslands = mapWorld.querySelectorAll('.map-island');
            existingIslands.forEach(island => island.remove());
            
            // Initialize player position if not set
            if (mapPlayerX === 1000 && mapPlayerY === 1000) {
                initializeMapPlayer();
            }
            
            updateMapPlayer();
            
            const bestBoatIndex = Math.max(...gameState.ownedBoats);
            
            // Render islands in world coordinates
            islands.forEach((island, index) => {
                const pos = islandWorldPositions[index];
                if (!pos) return;
                
                const isUnlocked = gameState.unlockedIslands.includes(index);
                const isCurrent = gameState.currentIsland === index;
                const canUnlock = !isUnlocked && bestBoatIndex >= island.boatReq && gameState.gold >= island.unlockCost;
                
                const islandDiv = document.createElement('div');
                islandDiv.className = 'map-island';
                islandDiv.style.left = pos.x + 'px';
                islandDiv.style.top = pos.y + 'px';
                islandDiv.style.zIndex = '10';
                
                if (isCurrent) {
                    islandDiv.classList.add('current');
                }
                if (!isUnlocked && !canUnlock) {
                    islandDiv.classList.add('locked');
                }
                
                // Show unlock cost and requirements
                const islandEmoji = island.emoji || 'üèùÔ∏è';
                // Add special icon classes for visual distinction on map
                let iconClass = '';
                if (island.name === "Coral Reef") iconClass = 'island-icon-coral';
                else if (island.name === "Dragon's Cove") iconClass = 'island-icon-dragon';
                else if (island.name === "Phantom Sea") iconClass = 'island-icon-phantom';
                else if (island.name === "Thunder Reef") iconClass = 'island-icon-thunder';
                else if (island.name === "Mystic Depths") iconClass = 'island-icon-mysticdepths';
                else if (island.name === "Celestial Waters") iconClass = 'island-icon-celestial';
                else if (island.name === "Void Trench") iconClass = 'island-icon-void';
                else if (island.name === "Infinity Sea") iconClass = 'island-icon-infinity';
                
                const iconDisplay = iconClass ? `<span class="island-icon ${iconClass}"></span>` : `${islandEmoji} `;
                let infoText = `<div style="font-weight: bold; margin-bottom: 3px;">${iconDisplay}${island.name}</div>`;
                if (!isUnlocked) {
                    infoText += `<div style="font-size: 0.7em;">${island.unlockCost.toLocaleString()} gold</div>`;
                    infoText += `<div style="font-size: 0.7em;">${boats[island.boatReq].name}</div>`;
                }
                
                islandDiv.innerHTML = infoText;
                islandDiv.title = isUnlocked 
                    ? `Walk here to visit ${island.name}` 
                    : `Locked - Requires ${boats[island.boatReq].name} and ${island.unlockCost.toLocaleString()} gold`;
                
                mapWorld.appendChild(islandDiv);
            });
            
            // Add invisible admin panel under Eternal Ocean (index 14, position x: 400, y: 500)
            const eternalOceanPos = islandWorldPositions[14]; // Eternal Ocean
            if (eternalOceanPos) {
                // Check if admin panel button already exists
                let adminPanelButton = mapWorld.querySelector('.invisible-admin-panel');
                if (!adminPanelButton) {
                    adminPanelButton = document.createElement('div');
                    adminPanelButton.className = 'invisible-admin-panel';
                    adminPanelButton.id = 'adminPanelButton';
                    mapWorld.appendChild(adminPanelButton);
                }
                // Always re-attach click handler to ensure it works
                adminPanelButton.onclick = function(e) {
                    e.stopPropagation();
                    e.preventDefault();
                    toggleInvisibleAdminPanel();
                    return false;
                };
                // Position it slightly below Eternal Ocean
                adminPanelButton.style.left = (eternalOceanPos.x) + 'px';
                adminPanelButton.style.top = (eternalOceanPos.y + 80) + 'px';
            }
            
            // Start movement system
            startMapMovement();
        }

        // Save/Load functions using cookies
        function saveGame() {
            try {
                // Create a comprehensive save data object
                const saveData = {
                    version: "1.0",
                    timestamp: Date.now(),
                    gameState: {
                        level: gameState.level || 1,
                        gold: gameState.gold || 100,
                        rebirthCount: gameState.rebirthCount || 0,
                        rebirthBonus: gameState.rebirthBonus || 1.0,
                        experience: gameState.experience || 0,
                        currentIsland: gameState.currentIsland || 0,
                        inventory: gameState.inventory ? JSON.parse(JSON.stringify(gameState.inventory)) : [],
                        ownedBoats: gameState.ownedBoats ? [...gameState.ownedBoats] : [0],
                        ownedRods: gameState.ownedRods ? [...gameState.ownedRods] : [0],
                        unlockedIslands: gameState.unlockedIslands ? [...gameState.unlockedIslands] : [0],
                        totalFishCaught: gameState.totalFishCaught || 0,
                        playerName: gameState.playerName || null
                    },
                    autoClickerActive: autoClickerActive || false,
                    secretAutoClickerActive: secretAutoClickerActive || false,
                    secretFishAutoClickerActive: secretFishAutoClickerActive || false,
                    autoFishingMode: autoFishingMode || false,
                    aiFishingMacroActive: aiFishingMacroActive || false,
                    historyQuestionsEnabled: historyQuestionsEnabled !== undefined ? historyQuestionsEnabled : true
                };
                
                const saveString = JSON.stringify(saveData);
                
                // Check if save string is too large (cookies have ~4KB limit)
                if (saveString.length > 4000) {
                    console.warn('Save data is large, attempting to save anyway...');
                }
                
                // Set cookie with proper encoding
                const cookieValue = encodeURIComponent(saveString);
                const cookieString = `fishingGameSave=${cookieValue}; max-age=31536000; path=/; SameSite=Lax`;
                document.cookie = cookieString;
                
                // Simple verification - check if cookie string was set (some browsers restrict immediate reading)
                // The cookie should be saved even if we can't verify it immediately
                try {
                    const allCookies = document.cookie;
                    if (allCookies.includes('fishingGameSave=')) {
                        // Try to parse it to make sure it's valid
                        const cookieMatch = allCookies.match(/fishingGameSave=([^;]+)/);
                        if (cookieMatch && cookieMatch[1]) {
                            const decoded = decodeURIComponent(cookieMatch[1]);
                            const parsed = JSON.parse(decoded);
                            if (parsed.gameState && parsed.gameState.level !== undefined) {
                                console.log('Save verified successfully');
                                return true;
                            }
                        }
                    }
                } catch (e) {
                    // Verification failed but cookie was still set
                    console.warn('Save verification failed, but cookie was set:', e);
                }
                
                // Even if verification fails, assume success since cookie was set
                // Some browsers have security restrictions that prevent reading cookies immediately
                console.log('Save completed (verification skipped due to browser restrictions)');
                return true;
            } catch (e) {
                console.error('Error saving game:', e);
                alert('Error saving game: ' + e.message);
                return false;
            }
        }

        // Manual save function
        function manualSave() {
            const btn = document.getElementById('saveBtn');
            btn.disabled = true;
            btn.textContent = 'üíæ Saving...';
            
            // Force a small delay to ensure UI updates
            setTimeout(() => {
                if (saveGame()) {
                    addLog('üíæ Game saved successfully!');
                    addLog(`üíæ Saved: Level ${gameState.level}, ${gameState.gold.toLocaleString()} gold, ${gameState.inventory.length} fish`);
                    btn.textContent = '‚úì Saved!';
                    btn.style.background = 'linear-gradient(135deg, #28a745 0%, #20c997 100%)';
                    setTimeout(() => {
                        btn.textContent = 'üíæ Save Game';
                        btn.style.background = 'linear-gradient(135deg, #28a745 0%, #20c997 100%)';
                        btn.disabled = false;
                    }, 2000);
                } else {
                    addLog('‚ùå Error saving game! Check console for details.');
                    btn.textContent = '‚ùå Save Failed';
                    btn.style.background = 'linear-gradient(135deg, #dc3545 0%, #c82333 100%)';
                    setTimeout(() => {
                        btn.textContent = 'üíæ Save Game';
                        btn.style.background = 'linear-gradient(135deg, #28a745 0%, #20c997 100%)';
                        btn.disabled = false;
                    }, 2000);
                }
            }, 100);
        }

        function loadGame() {
            const cookies = document.cookie.split(';');
            let saveData = null;
            
            for (let cookie of cookies) {
                const [name, value] = cookie.trim().split('=');
                if (name === 'fishingGameSave') {
                    try {
                        saveData = JSON.parse(decodeURIComponent(value));
                        break;
                    } catch (e) {
                        console.error('Error loading save data:', e);
                    }
                }
            }
            
            if (saveData && saveData.gameState) {
                // Restore game state
                Object.assign(gameState, saveData.gameState);
                
                // Ensure rebirth bonus is calculated if missing
                if (!gameState.rebirthBonus && gameState.rebirthCount) {
                    gameState.rebirthBonus = 1 + (gameState.rebirthCount * 0.5);
                } else if (!gameState.rebirthBonus) {
                    gameState.rebirthBonus = 1.0;
                }
                if (!gameState.rebirthCount) {
                    gameState.rebirthCount = 0;
                }
                
                // Restore background based on current island
                if (gameState.currentIsland !== undefined && islands[gameState.currentIsland]) {
                    document.body.className = document.body.className.replace(/island-bg-\w+/g, '').trim();
                    if (islands[gameState.currentIsland].backgroundClass) {
                        document.body.classList.add(islands[gameState.currentIsland].backgroundClass);
                    }
                }
                
                // Restore auto-clicker states (only toggle if they were active)
                if (saveData.autoClickerActive && !autoClickerActive) {
                    toggleAutoClicker();
                }
                if (saveData.secretAutoClickerActive && !secretAutoClickerActive) {
                    toggleSecretAutoClicker();
                }
                if (saveData.secretFishAutoClickerActive && !secretFishAutoClickerActive) {
                    toggleSecretFishAutoClicker();
                }
                if (saveData.autoFishingMode !== undefined) {
                    autoFishingMode = saveData.autoFishingMode;
                    // Update button state
                    const rustyPipeBtn = document.getElementById('rustyPipeBtn');
                    if (rustyPipeBtn) {
                        rustyPipeBtn.textContent = autoFishingMode 
                            ? 'üîß Rusty Pipe (Instant Catch): ON' 
                            : 'üîß Rusty Pipe (Instant Catch): OFF';
                        if (autoFishingMode) rustyPipeBtn.classList.add('active');
                        else rustyPipeBtn.classList.remove('active');
                    }
                }
                if (saveData.aiFishingMacroActive && !aiFishingMacroActive) {
                    toggleAutoFishingMacro();
                }
                
                // Restore history questions setting
                if (saveData.historyQuestionsEnabled !== undefined) {
                    historyQuestionsEnabled = saveData.historyQuestionsEnabled;
                    const questionsBtn = document.getElementById('toggleQuestionsBtn');
                    if (questionsBtn) {
                        questionsBtn.textContent = `üìö History Questions: ${historyQuestionsEnabled ? 'ON' : 'OFF'}`;
                        questionsBtn.classList.toggle('active', historyQuestionsEnabled);
                    }
                }
                
                // Restore player name
                if (saveData.gameState.playerName) {
                    gameState.playerName = saveData.gameState.playerName;
                    updatePlayerNameDisplay();
                } else {
                    // If save exists but no name, prompt for name
                    promptForName();
                }
                
                addLog('üíæ Game loaded successfully!');
                if (gameState.playerName) {
                    addLog(`üëã Welcome back, ${gameState.playerName}!`);
                }
                updateUI();
                return true;
            }
            return false;
        }

        // Auto-save periodically (every 30 seconds)
        setInterval(() => {
            saveGame();
        }, 30000);

        // Leaderboard functions using JSONBin.io
        const JSONBIN_BIN_ID = '691d8fc2ae596e708f6291f1';
        const JSONBIN_API_KEY = '$2a$10$RupGyIKoStuKBDCn5QPrcOtiBfE.4z7AqAVvTtacUq2aS6wtZaYXi'; // Access key with CRUD permissions
        
        // Leaderboard data structure: { players: [{ name: string, fishCaught: number, lastUpdated: timestamp }], visits: number }
        let leaderboardData = { players: [], visits: 0 };
        let lastLeaderboardSubmit = 0;
        const LEADERBOARD_SUBMIT_COOLDOWN = 5000; // Submit at most once every 5 seconds

        async function submitToLeaderboard() {
            // Only submit if player has a name and cooldown has passed
            if (!gameState.playerName || !gameState.totalFishCaught) {
                return;
            }

            const now = Date.now();
            if (now - lastLeaderboardSubmit < LEADERBOARD_SUBMIT_COOLDOWN) {
                return; // Still in cooldown
            }

            // If JSONBin.io is not configured, skip
            if (JSONBIN_BIN_ID === 'your-bin-id-here' || JSONBIN_API_KEY === '$2a$10$your-api-key-here') {
                return;
            }

            try {
                // First, fetch current leaderboard
                const response = await fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID}/latest`, {
                    headers: {
                        'X-Access-Key': JSONBIN_API_KEY
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    leaderboardData = data.record || { players: [] };
                } else {
                    console.error('Failed to fetch leaderboard:', response.status, response.statusText);
                    // If bin doesn't exist, create new structure
                    leaderboardData = { players: [] };
                }

                // Find existing player or create new entry
                let playerIndex = leaderboardData.players.findIndex(p => p.name === gameState.playerName);
                if (playerIndex === -1) {
                    leaderboardData.players.push({
                        name: gameState.playerName,
                        fishCaught: gameState.totalFishCaught,
                        lastUpdated: now
                    });
                } else {
                    // Update existing player if they have more fish
                    if (gameState.totalFishCaught > leaderboardData.players[playerIndex].fishCaught) {
                        leaderboardData.players[playerIndex].fishCaught = gameState.totalFishCaught;
                        leaderboardData.players[playerIndex].lastUpdated = now;
                    }
                }

                // Sort by fish caught (descending)
                leaderboardData.players.sort((a, b) => b.fishCaught - a.fishCaught);

                // Preserve visit count when updating leaderboard
                if (leaderboardData.visits === undefined) {
                    leaderboardData.visits = 0;
                }

                // Update leaderboard on JSONBin.io
                const updateResponse = await fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Access-Key': JSONBIN_API_KEY
                    },
                    body: JSON.stringify(leaderboardData)
                });

                if (!updateResponse.ok) {
                    console.error('Failed to update leaderboard:', updateResponse.status, updateResponse.statusText);
                }

                lastLeaderboardSubmit = now;
            } catch (error) {
                console.error('Error submitting to leaderboard:', error);
            }
        }

        async function fetchLeaderboard() {
            // If JSONBin.io is not configured, show message
            if (JSONBIN_BIN_ID === 'your-bin-id-here' || JSONBIN_API_KEY === '$2a$10$your-api-key-here') {
                const content = document.getElementById('leaderboardContent');
                if (content) {
                    content.innerHTML = `
                        <div style="text-align: center; color: #999; padding: 20px;">
                            <p>Leaderboard not configured.</p>
                            <p style="font-size: 0.9em; margin-top: 10px;">
                                To enable leaderboard:<br>
                                1. Create a free account at <a href="https://jsonbin.io/" target="_blank" style="color: #667eea;">jsonbin.io</a><br>
                                2. Create a new bin<br>
                                3. Update JSONBIN_BIN_ID and JSONBIN_API_KEY in the code
                            </p>
                        </div>
                    `;
                }
                return;
            }

            try {
                const response = await fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID}/latest`, {
                    headers: {
                        'X-Access-Key': JSONBIN_API_KEY
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    leaderboardData = data.record || { players: [] };
                    displayLeaderboard();
                } else {
                    const errorText = await response.text();
                    console.error('Failed to fetch leaderboard:', response.status, response.statusText, errorText);
                    throw new Error(`Failed to fetch leaderboard: ${response.status} ${response.statusText}`);
                }
            } catch (error) {
                console.error('Error fetching leaderboard:', error);
                const content = document.getElementById('leaderboardContent');
                if (content) {
                    content.innerHTML = `
                        <div style="text-align: center; color: #ff6b6b; padding: 20px;">
                            Error loading leaderboard (401 Unauthorized).<br>
                            <small style="color: #999; margin-top: 10px; display: block;">
                                Please check your API key permissions in JSONBin.io
                            </small>
                        </div>
                    `;
                }
            }
        }

        function displayLeaderboard() {
            const content = document.getElementById('leaderboardContent');
            if (!content) return;

            if (!leaderboardData.players || leaderboardData.players.length === 0) {
                content.innerHTML = `
                    <div style="text-align: center; color: #999; padding: 20px;">
                        No players yet. Be the first!
                    </div>
                `;
                return;
            }

            // Get top 10 players
            const topPlayers = leaderboardData.players.slice(0, 10);
            const currentPlayerName = gameState.playerName;

            let html = '<div style="max-height: 400px; overflow-y: auto;">';
            html += '<table style="width: 100%; border-collapse: collapse;">';
            html += '<thead><tr style="border-bottom: 2px solid #667eea;">';
            html += '<th style="text-align: left; padding: 8px; color: #667eea;">Rank</th>';
            html += '<th style="text-align: left; padding: 8px; color: #667eea;">Player</th>';
            html += '<th style="text-align: right; padding: 8px; color: #667eea;">Fish Caught</th>';
            html += '</tr></thead><tbody>';

            topPlayers.forEach((player, index) => {
                const isCurrentPlayer = player.name === currentPlayerName;
                const rank = index + 1;
                const medal = rank === 1 ? 'ü•á' : rank === 2 ? 'ü•à' : rank === 3 ? 'ü•â' : `${rank}.`;
                
                html += `<tr style="border-bottom: 1px solid #333; ${isCurrentPlayer ? 'background: rgba(102, 126, 234, 0.2); font-weight: bold;' : ''}">`;
                html += `<td style="padding: 8px; width: 60px;">${medal}</td>`;
                html += `<td style="padding: 8px;">${isCurrentPlayer ? '‚≠ê ' : ''}${player.name}</td>`;
                html += `<td style="padding: 8px; text-align: right;">${player.fishCaught.toLocaleString()}</td>`;
                html += '</tr>';
            });

            html += '</tbody></table></div>';

            // Show current player's rank if not in top 10
            const currentPlayerIndex = leaderboardData.players.findIndex(p => p.name === currentPlayerName);
            if (currentPlayerIndex !== -1 && currentPlayerIndex >= 10) {
                const player = leaderboardData.players[currentPlayerIndex];
                html += `<div style="margin-top: 15px; padding-top: 15px; border-top: 2px solid #667eea;">`;
                html += `<div style="text-align: center; color: #667eea; font-weight: bold;">Your Rank: #${currentPlayerIndex + 1}</div>`;
                html += `<div style="text-align: center; color: #999; margin-top: 5px;">${player.fishCaught.toLocaleString()} fish caught</div>`;
                html += '</div>';
            }

            content.innerHTML = html;
        }

        // Visit counter functions
        async function incrementVisitCounter() {
            // If JSONBin.io is not configured, skip
            if (JSONBIN_BIN_ID === 'your-bin-id-here' || JSONBIN_API_KEY === '$2a$10$your-api-key-here') {
                return;
            }

            try {
                // Check if we've already counted this visit today (using localStorage)
                const lastVisitDate = localStorage.getItem('lastVisitDate');
                const today = new Date().toDateString();
                
                // Only count once per day per user
                if (lastVisitDate === today) {
                    // Still fetch and display the current count
                    fetchVisitCounter();
                    return;
                }

                // Fetch current visit count (need to get the full record to preserve leaderboard data)
                const response = await fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID}/latest`, {
                    headers: {
                        'X-Access-Key': JSONBIN_API_KEY
                    }
                });

                let currentData = { players: [], visits: 0 };
                if (response.ok) {
                    const data = await response.json();
                    currentData = data.record || { players: [], visits: 0 };
                }

                // Increment visit count
                currentData.visits = (currentData.visits || 0) + 1;

                // Update visit count on JSONBin.io (preserve leaderboard data)
                const updateResponse = await fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Access-Key': JSONBIN_API_KEY
                    },
                    body: JSON.stringify(currentData)
                });

                if (updateResponse.ok) {
                    // Mark this visit as counted for today
                    localStorage.setItem('lastVisitDate', today);
                    // Update display
                    updateVisitCounterDisplay(currentData.visits);
                }
            } catch (error) {
                console.error('Error updating visit counter:', error);
                // Still try to fetch the current count
                fetchVisitCounter();
            }
        }

        async function fetchVisitCounter() {
            // If JSONBin.io is not configured, skip
            if (JSONBIN_BIN_ID === 'your-bin-id-here' || JSONBIN_API_KEY === '$2a$10$your-api-key-here') {
                updateVisitCounterDisplay('?');
                return;
            }

            try {
                const response = await fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID}/latest`, {
                    headers: {
                        'X-Access-Key': JSONBIN_API_KEY
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    const visits = data.record?.visits || 0;
                    updateVisitCounterDisplay(visits);
                } else {
                    updateVisitCounterDisplay('?');
                }
            } catch (error) {
                console.error('Error fetching visit counter:', error);
                updateVisitCounterDisplay('?');
            }
        }

        function updateVisitCounterDisplay(count) {
            const visitCountElement = document.getElementById('visitCount');
            if (visitCountElement) {
                visitCountElement.textContent = typeof count === 'number' ? count.toLocaleString() : count;
            }
        }

        // Event Listeners
        const fishBtn = document.getElementById('fishBtn');
        if (fishBtn) {
            fishBtn.addEventListener('click', goFishing);
        } else {
            console.error('fishBtn not found!');
        }
        
        // Auto-clicker button removed from fishing window (moved to secret panel)
        
        // Secret auto-clicker buttons are now in the secret panel with onclick handlers
        
        const saveBtn = document.getElementById('saveBtn');
        if (saveBtn) saveBtn.addEventListener('click', manualSave);
        
        const shipwrightBtn = document.getElementById('shipwrightBtn');
        if (shipwrightBtn) shipwrightBtn.addEventListener('click', () => openModal('shipwrightModal'));
        
        const merchantBtn = document.getElementById('merchantBtn');
        if (merchantBtn) merchantBtn.addEventListener('click', () => openModal('merchantModal'));
        
        const appraiserBtn = document.getElementById('appraiserBtn');
        if (appraiserBtn) appraiserBtn.addEventListener('click', () => openModal('appraiserModal'));
        
        const rodsBtn = document.getElementById('rodsBtn');
        if (rodsBtn) rodsBtn.addEventListener('click', () => openModal('rodsModal'));
        
        const mapBtn = document.getElementById('mapBtn');
        if (mapBtn) mapBtn.addEventListener('click', () => openModal('mapModal'));

        const refreshLeaderboardBtn = document.getElementById('refreshLeaderboardBtn');
        if (refreshLeaderboardBtn) {
            refreshLeaderboardBtn.addEventListener('click', () => {
                fetchLeaderboard();
            });
        }

        // Load leaderboard on page load
        fetchLeaderboard();
        // Refresh leaderboard every 30 seconds
        setInterval(() => {
            fetchLeaderboard();
        }, 30000);

        // Initialize visit counter
        incrementVisitCounter();
        // Refresh visit counter every 60 seconds
        setInterval(() => {
            fetchVisitCounter();
        }, 60000);

        // Close modals when clicking outside
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.remove('active');
                }
            });
        });

        // Keyboard controls for fishing game and map movement
        document.addEventListener('keydown', (e) => {
            // Check if map modal is open
            const mapModal = document.getElementById('mapModal');
            const isMapOpen = mapModal && mapModal.classList.contains('active');
            
            if (isMapOpen) {
                // Map movement controls (WASD)
                if (e.key === 'w' || e.key === 'W') {
                    mapKeysPressed.w = true;
                    e.preventDefault();
                }
                if (e.key === 'a' || e.key === 'A') {
                    mapKeysPressed.a = true;
                    e.preventDefault();
                }
                if (e.key === 's' || e.key === 'S') {
                    mapKeysPressed.s = true;
                    e.preventDefault();
                }
                if (e.key === 'd' || e.key === 'D') {
                    mapKeysPressed.d = true;
                    e.preventDefault();
                }
                return; // Don't process fishing game keys when map is open
            }
            
            if (!fishingGameActive) return;
            
            if (e.key === 'ArrowLeft' || e.key === 'a' || e.key === 'A') {
                keysPressed.left = true;
                e.preventDefault();
            }
            if (e.key === 'ArrowRight' || e.key === 'd' || e.key === 'D') {
                keysPressed.right = true;
                e.preventDefault();
            }
        });

        document.addEventListener('keyup', (e) => {
            // Check if map modal is open
            const mapModal = document.getElementById('mapModal');
            const isMapOpen = mapModal && mapModal.classList.contains('active');
            
            if (isMapOpen) {
                // Map movement controls (WASD)
                if (e.key === 'w' || e.key === 'W') {
                    mapKeysPressed.w = false;
                    e.preventDefault();
                }
                if (e.key === 'a' || e.key === 'A') {
                    mapKeysPressed.a = false;
                    e.preventDefault();
                }
                if (e.key === 's' || e.key === 'S') {
                    mapKeysPressed.s = false;
                    e.preventDefault();
                }
                if (e.key === 'd' || e.key === 'D') {
                    mapKeysPressed.d = false;
                    e.preventDefault();
                }
                return; // Don't process fishing game keys when map is open
            }
            
            if (!fishingGameActive) return;
            
            if (e.key === 'ArrowLeft' || e.key === 'a' || e.key === 'A') {
                keysPressed.left = false;
                e.preventDefault();
            }
            if (e.key === 'ArrowRight' || e.key === 'd' || e.key === 'D') {
                keysPressed.right = false;
                e.preventDefault();
            }
        });

        // Player name functions
        function promptForName() {
            const nameModal = document.getElementById('nameModal');
            if (nameModal) {
                nameModal.classList.add('active');
                nameModal.style.display = 'flex';
                const input = document.getElementById('playerNameInput');
                if (input) {
                    input.focus();
                    input.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            savePlayerName();
                        }
                    });
                }
            }
        }

        function savePlayerName() {
            const input = document.getElementById('playerNameInput');
            const name = input ? input.value.trim() : '';
            if (name && name.length > 0) {
                gameState.playerName = name;
                updatePlayerNameDisplay();
                const nameModal = document.getElementById('nameModal');
                if (nameModal) {
                    nameModal.classList.remove('active');
                    nameModal.style.display = 'none';
                }
                saveGame();
                addLog(`üëã Welcome, ${gameState.playerName}!`);
                addLog("üé£ Welcome to Fishing Adventure!");
                addLog("Start fishing to earn gold and level up!");
            } else {
                alert('Please enter a valid name!');
            }
        }

        function updatePlayerNameDisplay() {
            const nameDisplay = document.getElementById('playerNameDisplay');
            if (nameDisplay && gameState.playerName) {
                nameDisplay.textContent = `Player: ${gameState.playerName}`;
            }
        }

        // Initialize
        if (!loadGame()) {
            // No save data found, start fresh
            document.body.className = document.body.className.replace(/island-bg-\w+/g, '').trim();
            if (islands[0].backgroundClass) {
                document.body.classList.add(islands[0].backgroundClass);
            }
            // Prompt for name if no save exists
            if (!gameState.playerName) {
                promptForName();
            }
        } else {
            // If loaded but no name, prompt
            if (!gameState.playerName) {
                promptForName();
            }
        }
        updateUI();
    </script>
</body>
</html>
